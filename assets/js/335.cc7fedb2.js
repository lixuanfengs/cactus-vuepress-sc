(window.webpackJsonp=window.webpackJsonp||[]).push([[335],{685:function(s,n,a){"use strict";a.r(n);var e=a(0),t=Object(e.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[s._v("在微服务的架构中，服务网关就是一个介于客户端与服务端之间的中间层。在这种情况下，客户端只需要跟服务网关交互，无需调用具体的微服务接口。这样的好处在于，客户端可以降低复杂性，无需关注具体是哪个微服务在提供服务。这一节我们将使用Spring Cloud Zuul搭建微服务网关febs-gateway。")]),s._v(" "),n("h2",{attrs:{id:"搭建febs-gateway"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#搭建febs-gateway"}},[s._v("#")]),s._v(" 搭建febs-gateway")]),s._v(" "),n("p",[s._v("点击IDEA菜单栏 File -> New -> Module...，模板选择Spring Initializr，Module SDK选择JDK 1.8：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/06/efedwq.png",alt:"35.png"}})]),s._v(" "),n("p",[s._v("点击Next，按照下图所示填写相关内容：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/06/efu4kq.png",alt:"36.png"}})]),s._v(" "),n("p",[s._v("点解Next，在依赖列表里选择Zuul：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/06/efuIhV.png",alt:"37.png"}})]),s._v(" "),n("p",[s._v("点击Next：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/06/efKAHA.png",alt:"38.png"}})]),s._v(" "),n("p",[s._v("填写模块名称和路径后，点击Finish完成创建，至此，项目结构如下所示：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/06/efKDb9.png",alt:"39.png"}})]),s._v(" "),n("p",[s._v("我们修改febs-gateway模块的pom，内容如下所示：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('<?xml version="1.0" encoding="UTF-8"?>\n<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">\n    <modelVersion>4.0.0</modelVersion>\n    <parent>\n        <groupId>cc.mrbird</groupId>\n        <artifactId>febs-cloud</artifactId>\n        <version>1.0-SNAPSHOT</version>\n        <relativePath>../febs-cloud/pom.xml</relativePath>\n    </parent>\n\n    <artifactId>febs-gateway</artifactId>\n    <name>FEBS-Gateway</name>\n    <description>FEBS-Gateway微服务网关</description>\n\n    <dependencies>\n        <dependency>\n            <groupId>cc.mrbird</groupId>\n            <artifactId>febs-common</artifactId>\n            <version>1.0-SNAPSHOT</version>\n        </dependency>\n         <dependency>\n            <groupId>org.springframework.cloud</groupId>\n            <artifactId>spring-cloud-starter-netflix-zuul</artifactId>\n        </dependency>\n    </dependencies>\n\n    <build>\n        <plugins>\n            <plugin>\n                <groupId>org.springframework.boot</groupId>\n                <artifactId>spring-boot-maven-plugin</artifactId>\n            </plugin>\n        </plugins>\n    </build>\n\n</project>\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br")])]),n("p",[s._v("在上述pom配置中，我们指定了父项目为febs-cloud，并且引入了通用模块febs-common。")]),s._v(" "),n("p",[s._v("修改febs-cloud模块的pom，在modules标签里引入febs-gateway：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("<modules>\n    <module>../febs-common</module>\n    <module>../febs-register</module>\n    <module>../febs-auth</module>\n    <module>../febs-gateway</module>\n</modules>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("在febs-gateway的入口类"),n("code",[s._v("FebsGatewayApplication")]),s._v("上添加"),n("code",[s._v("@EnableDiscoveryClient")]),s._v("注解，开启服务注册与发现，添加"),n("code",[s._v("@EnableZuulProxy")]),s._v("注解，开启Zuul服务网关功能：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("@EnableZuulProxy\n@EnableDiscoveryClient\n@SpringBootApplication\npublic class FebsGatewayApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(FebsGatewayApplication.class, args);\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("接着编写配置文件application.yml，先添加如下内容：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("server:\n  port: 8301\n\nspring:\n  application:\n    name: FEBS-Gateway\n\neureka:\n  instance:\n    lease-renewal-interval-in-seconds: 20\n  client:\n    register-with-eureka: true\n    fetch-registry: true\n    instance-info-replication-interval-seconds: 30\n    registry-fetch-interval-seconds: 3\n    serviceUrl:\n      defaultZone: http://febs:123456@localhost:8001/register/eureka/\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("p",[s._v("应用端口号为8301，服务名称为FEBS-Gateway，剩下的Eureka配置在上一节微服务认证服务器搭建过程中已经进行了详细介绍，所以这里就不再赘述了。")]),s._v(" "),n("p",[s._v("接着在application.yml继续添加和Zuul有关的配置，内容如下所示：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('zuul:\n  routes:\n    auth:\n      path: /auth/**\n      serviceId: FEBS-Auth\n      sensitiveHeaders: "*"\n  retryable: true\n  ignored-services: "*"\n  ribbon:\n    eager-load:\n      enabled: true\n\nribbon:\n  ReadTimeout: 3000\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("其中：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('...\n  auth:\n    path: /auth/**\n    serviceId: FEBS-Auth\n    sensitiveHeaders: "*"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("这一段配置意思是，所有以"),n("code",[s._v("/auth")]),s._v("开头的请求都会被转发到名称为FEBS-Auth的服务上，由于我们需要在请求头中携带令牌，所以"),n("code",[s._v("sensitiveHeaders")]),s._v("设置为"),n("code",[s._v("*")]),s._v("，表示不过滤请求头信息，即请求的请求头信息将原封不动的转发出去。此外，因为Zuul已经包含了ribbon和hystrix依赖，所以我们在使用Zuul的同时，可以添加ribbon和hystrix相关配置。")]),s._v(" "),n("p",[s._v("上述配置中剩下的内容含义如下：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("zuul.retryable")]),s._v("，设置为true时，表示开启重试机制；")]),s._v(" "),n("li",[n("code",[s._v("zuul.ignored-services")]),s._v("，Zuul配合Eureka后会有一套默认的配置规则，这里我们只想请求根据我们显示配置的路由规则走，所以设置为"),n("code",[s._v("*")]),s._v("，表示关闭所有默认路由配置规则；")]),s._v(" "),n("li",[n("code",[s._v("zuul.ribbon.eager-load.enabled")]),s._v("，Zuul内部通过Ribbon按照一定的负载均衡算法来获取服务，Ribbon进行客户端负载均衡的Client并不是在服务启动的时候就初始化好的，而是在调用的时候才会去创建相应的Client，所以第一次调用的耗时不仅仅包含发送HTTP请求的时间，还包含了创建RibbonClient的时间，这样一来如果创建时间速度较慢，同时设置的超时时间又比较短的话，第一次请求很容易出现超时的情况。设置为true的时候表示开启Ribbon的饥饿加载模式，即在应用启动的时候就去获取相应的Client备用。")]),s._v(" "),n("li",[n("code",[s._v("ribbon.ReadTimeout")]),s._v("，设置请求超时时间，单位为毫秒；")])]),s._v(" "),n("p",[s._v("配置文件编写完毕后，我们需要编写一个web安全配置类。在febs-gateway模块下的cc.mrbird.febs.gateway路径下新增configure包，然后在该包下新增"),n("code",[s._v("FebsGatewaySecurityConfigure")]),s._v("配置类：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("@EnableWebSecurity\npublic class FebsGatewaySecurityConfigure extends WebSecurityConfigurerAdapter {\n    @Override\n    protected void configure(HttpSecurity http) throws Exception {\n        http.csrf().disable();\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("因为febs-gateway引入了febs-common模块，febs-common模块包含了Spring Cloud Security依赖，所以我们需要定义一个自己的WebSecurity配置类，来覆盖默认的。这里主要是关闭了csrf功能，否则会报csrf相关异常。")]),s._v(" "),n("h2",{attrs:{id:"postman测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#postman测试"}},[s._v("#")]),s._v(" PostMan测试")]),s._v(" "),n("p",[s._v("到目前为止，我们已经搭建好了微服务网关模块，现在让我们用PostMan测试一下是否可以通过微服务网关转发请求到febs-auth模块获取访问令牌。")]),s._v(" "),n("p",[s._v("在此之前，我们在febs-gateway模块下的resources路径下新增banner.txt：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("|------------------------------|\n|    ____  ____  ___   __      |\n|   | |_  | |_  | |_) ( (`     |\n|   |_|   |_|__ |_|_) _)_)     |\n|                              |\n|   ${spring.application.name}               |\n|   Spring-Boot: ${spring-boot.version} |\n|------------------------------|\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("在Service窗口里分别启动"),n("code",[s._v("FebsRegisterApplication")]),s._v("、"),n("code",[s._v("FebsAuthApplication")]),s._v("和"),n("code",[s._v("FebsGatewayApplication")]),s._v("：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/06/ef5Dpj.png",alt:"40.png"}})]),s._v(" "),n("p",[s._v("启动后，使用PostMan发送 "),n("a",{attrs:{href:"localhost:8301/auth/oauth/token"}},[s._v("localhost:8301/auth/oauth/token")]),s._v(" POST请求（注意这里和上一节的测试请求已经不一样了哦，现在端口是8301，即微服务网关的端口，并且请求路径添加了/auth前缀）：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/06/efIBVK.png",alt:"41.png"}})]),s._v(" "),n("p",[s._v("可以看到，成功获取到了令牌。")]),s._v(" "),n("p",[s._v("使用这个令牌访问febs-auth的"),n("code",[s._v("/user")]),s._v("接口看看：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s1.ax1x.com/2020/06/17/NAgYj0.png",alt:"42.png"}})]),s._v(" "),n("p",[s._v("没问题，剩下的刷新令牌，注销令牌我就不测试了。下一节中我们开始搭建两个资源服务器febs-server-system和febs-server-test。")])])}),[],!1,null,null,null);n.default=t.exports}}]);