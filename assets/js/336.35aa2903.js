(window.webpackJsonp=window.webpackJsonp||[]).push([[336],{688:function(s,e,n){"use strict";n.r(e);var a=n(0),t=Object(a.a)({},(function(){var s=this,e=s._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("本节的目标是搭建两个微服务提供者（同时也是资源服务器）febs-server-system和febs-server-test，主要目的是为了演示认证服务器和资源服务器在分离的模式下，如何进行资源保护和资源获取。")]),s._v(" "),e("h2",{attrs:{id:"搭建febs-server-system"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#搭建febs-server-system"}},[s._v("#")]),s._v(" 搭建febs-server-system")]),s._v(" "),e("p",[s._v("因为存在多个微服务提供者，所以我们先新增一个febs-server作为这些微服务的父项目，统一进行管理。")]),s._v(" "),e("p",[s._v("点击IDEA菜单栏 File -> New -> Module...新增一个Maven模块：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/06/efzJw4.png",alt:"43.png"}})]),s._v(" "),e("p",[s._v("点击Next，父模块选择FEBS-Cloud，ArtifactId为febs-server：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/06/efzRfI.png",alt:"44.png"}})]),s._v(" "),e("p",[s._v("点击Next，模块名称和路径按照下图所示填写：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/06/ehS04s.png",alt:"45.png"}})]),s._v(" "),e("p",[s._v("然后点击Finish完成模块创建。")]),s._v(" "),e("p",[s._v("因为febs-server是一个纯聚合模块，所以可以把它src目录下的内容全部删了，至此，项目结构如下所示：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/06/ehpAaQ.png",alt:"46.png"}})]),s._v(" "),e("p",[s._v("修改febs-server的pom，引入febs-common模块：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('<?xml version="1.0" encoding="UTF-8"?>\n<project xmlns="http://maven.apache.org/POM/4.0.0"\n         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">\n    <modelVersion>4.0.0</modelVersion>\n\n    <parent>\n        <groupId>cc.mrbird</groupId>\n        <artifactId>febs-cloud</artifactId>\n        <version>1.0-SNAPSHOT</version>\n        <relativePath>../febs-cloud/pom.xml</relativePath>\n    </parent>\n\n    <artifactId>febs-server</artifactId>\n    <packaging>pom</packaging>\n    <name>FEBS-Server</name>\n    <description>FEBS-Server服务提供模块</description>\n\n    <dependencies>\n        <dependency>\n            <groupId>cc.mrbird</groupId>\n            <artifactId>febs-common</artifactId>\n            <version>1.0-SNAPSHOT</version>\n        </dependency>\n    </dependencies>\n\n</project>\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br")])]),e("p",[s._v("因为在创建的时候已经选择了febs-cloud作为父模块，所以febs-cloud模块的pom里已经引入了febs-server作为子模块：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("<modules>\n    <module>../febs-common</module>\n    <module>../febs-register</module>\n    <module>../febs-auth</module>\n    <module>../febs-gateway</module>\n    <module>../febs-server</module>\n</modules>\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("创建好febs-server模块后，我们开始创建febs-server-system模块。点击IDEA菜单栏 File -> New -> Modules...，选择Spring Initialzr作为模板，Module SDK选择JDK 1.8：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/06/eh9DXV.png",alt:"47.png"}})]),s._v(" "),e("p",[s._v("点击Next，按照下图所示填写相关内容：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/06/ehCmuV.png",alt:"48.png"}})]),s._v(" "),e("p",[s._v("点解Next，暂时无需添加依赖，所以继续点击Next：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/06/ehCDCd.png",alt:"49.png"}})]),s._v(" "),e("p",[s._v("按照上图所示填写模块名称和路径（注意，febs-server-system位于febs-server路径下），然后点击Finish完成模块创建。")]),s._v(" "),e("p",[s._v("至此，项目结构如下所示：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/06/ehCWVS.png",alt:"50.png"}})]),s._v(" "),e("p",[s._v("修改febs-server-system模块的pom，内容如下所示：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('<?xml version="1.0" encoding="UTF-8"?>\n<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">\n    <modelVersion>4.0.0</modelVersion>\n\n    <parent>\n        <groupId>cc.mrbird</groupId>\n        <artifactId>febs-server</artifactId>\n        <version>1.0-SNAPSHOT</version>\n        <relativePath>../pom.xml</relativePath>\n    </parent>\n\n    <artifactId>febs-server-system</artifactId>\n    <name>FEBS-Server-System</name>\n    <description>FEBS-Server-System微服务系统模块</description>\n\n    <build>\n        <plugins>\n            <plugin>\n                <groupId>org.springframework.boot</groupId>\n                <artifactId>spring-boot-maven-plugin</artifactId>\n            </plugin>\n        </plugins>\n    </build>\n\n</project>\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br")])]),e("p",[s._v("在该pom中，指定了父模块为febs-server，在febs-server模块的pom的modules标签里也许引入febs-server-system：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("<modules>\n    <module>febs-server-system</module>\n</modules>\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("接下来开始编写和febs-server-system模块相关的代码。")]),s._v(" "),e("p",[s._v("在febs-server-system模块的入口类"),e("code",[s._v("FebsServerSystemApplication")]),s._v("上添加"),e("code",[s._v("@EnableDiscoveryClient")]),s._v("注解，开启服务注册与发现：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("@EnableDiscoveryClient\n@SpringBootApplication\npublic class FebsServerSystemApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(FebsServerSystemApplication.class, args);\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("然后编写项目配置文件application.yml，内容如下所示：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("server:\n  port: 8201\n\nspring:\n  application:\n    name: FEBS-Server-System\n\neureka:\n  instance:\n    lease-renewal-interval-in-seconds: 20\n  client:\n    register-with-eureka: true\n    fetch-registry: true\n    instance-info-replication-interval-seconds: 30\n    serviceUrl:\n      defaultZone: http://febs:123456@localhost:8001/register/eureka/\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br")])]),e("p",[s._v("应用端口号为8201，服务名称为FEBS-Server-System，剩下的配置为Eureka相关配置，前面章节都详细介绍过了，这里也不赘述了。接下来开始编写和安全有关的代码。")]),s._v(" "),e("p",[s._v("既然febs-server-system是一个资源服务器，那么我们就必须创建一个资源服务器配置类。在cc.mrbird.febs.server.system路径下新增configure包，然后在该包下新增"),e("code",[s._v("FebsServerSystemResourceServerConfigure")]),s._v("配置类：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@Configuration\n@EnableResourceServer\npublic class FebsServerSystemResourceServerConfigure extends ResourceServerConfigurerAdapter {\n\n    @Override\n    public void configure(HttpSecurity http) throws Exception {\n        http.csrf().disable()\n                .requestMatchers().antMatchers("/**")\n            .and()\n                .authorizeRequests()\n                .antMatchers("/**").authenticated();\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("p",[s._v("上述配置表示所有访问febs-server-system的请求都需要认证，只有通过认证服务器发放的令牌才能进行访问。")]),s._v(" "),e("p",[s._v("然后在febs-server-system的入口类"),e("code",[s._v("FebsServerSystemApplication")]),s._v("上添加"),e("code",[s._v("@EnableGlobalMethodSecurity(prePostEnabled = true)")]),s._v("注解，表示开启Spring Cloud Security权限注解（可以参考 https://mrbird.cc/Spring-Security-Permission.html）：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("@EnableDiscoveryClient\n@SpringBootApplication\n@EnableGlobalMethodSecurity(prePostEnabled = true)\npublic class FebsServerSystemApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(FebsServerSystemApplication.class, args);\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("p",[s._v("在配置文件application.yml添加oauth2相关配置：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("security:\n  oauth2:\n    resource:\n      id: ${spring.application.name}\n      user-info-uri: http://localhost:8301/auth/user\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[e("code",[s._v("user-info-uri")]),s._v("路径为http://localhost:8301/auth/user，通过微服务网关，该请求将被转发到http://localhost:8101/user。该配置的作用主要有两个：")]),s._v(" "),e("ol",[e("li",[s._v("到认证服务器里校验当前请求头中的令牌是否为合法的令牌；")]),s._v(" "),e("li",[s._v("通过当前令牌获取对应的用户信息。")])]),s._v(" "),e("p",[s._v("接着创建一个Controller，对外提供一些REST服务。在cc.mrbird.febs.server.system路径下新建controller包，然后在该包下新增"),e("code",[s._v("TestController")]),s._v("：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@RestController\npublic class TestController {\n\n    @GetMapping("info")\n    public String test(){\n        return "febs-server-system";\n    }\n\n    @GetMapping("user")\n    public Principal currentUser(Principal principal) {\n        return principal;\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("p",[s._v("最后，和其他模块一样，我们在febs-server-system模块下的resources目录创建一个banner.txt：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("|------------------------------|\n|    ____  ____  ___   __      |\n|   | |_  | |_  | |_) ( (`     |\n|   |_|   |_|__ |_|_) _)_)     |\n|                              |\n|   ${spring.application.name}         |\n|   Spring-Boot: ${spring-boot.version} |\n|------------------------------|\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("搭建好febs-server-system模块后，我们开始搭建febs-server-test模块。")]),s._v(" "),e("h2",{attrs:{id:"搭建febs-server-test"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#搭建febs-server-test"}},[s._v("#")]),s._v(" 搭建febs-server-test")]),s._v(" "),e("p",[s._v("点击IDEA菜单栏 File -> New -> Module...，模板选择Spring Initializr，Module SDK选择JDK1.8：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/07/e47rPf.png",alt:"51.png"}})]),s._v(" "),e("p",[s._v("点击Next，按照下图所示填写相关内容：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/07/e47fZn.png",alt:"52.png"}})]),s._v(" "),e("p",[s._v("点击Next，这里也是不选择任何依赖，直接点击Next：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/07/e47oGT.png",alt:"53.png"}})]),s._v(" "),e("p",[s._v("按照上图所示填写模块名称和项目路径（注意，febs-server-test位于febs-server路径下），然后点击Finish完成创建，至此项目结构如下图所示：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/07/e4HmJf.png",alt:"54.png"}})]),s._v(" "),e("p",[s._v("修改febs-server-test模块的pom，内容如下所示：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('<?xml version="1.0" encoding="UTF-8"?>\n<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">\n    <modelVersion>4.0.0</modelVersion>\n\n    <parent>\n        <groupId>cc.mrbird</groupId>\n        <artifactId>febs-server</artifactId>\n        <version>1.0-SNAPSHOT</version>\n        <relativePath>../pom.xml</relativePath>\n    </parent>\n\n    <artifactId>febs-server-test</artifactId>\n    <name>FEBS-Server-Test</name>\n    <description>FEBS-Server-Test测试服务模块</description>\n\n    <build>\n        <plugins>\n            <plugin>\n                <groupId>org.springframework.boot</groupId>\n                <artifactId>spring-boot-maven-plugin</artifactId>\n            </plugin>\n        </plugins>\n    </build>\n\n</project>\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br")])]),e("p",[s._v("上述配置中，指定了父模块为febs-server。")]),s._v(" "),e("p",[s._v("因为febs-server-test模块的代码和febs-server-system基本一致，所以下面开始贴代码，不做过多的说明。")]),s._v(" "),e("p",[s._v("在febs-server-test模块的入口类"),e("code",[s._v("FebsServerTestApplication")]),s._v("上使用"),e("code",[s._v("@EnableDiscoveryClient")]),s._v("和"),e("code",[s._v("@EnableGlobalMethodSecurity(prePostEnabled = true)")]),s._v("注解标注：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("@EnableDiscoveryClient\n@SpringBootApplication\n@EnableGlobalMethodSecurity(prePostEnabled = true)\npublic class FebsServerTestApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(FebsServerTestApplication.class, args);\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("p",[s._v("编写配置文件application.yml，内容如下所示：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("server:\n  port: 8202\n\nspring:\n  application:\n    name: FEBS-Server-Test\n\neureka:\n  instance:\n    lease-renewal-interval-in-seconds: 20\n  client:\n    register-with-eureka: true\n    fetch-registry: true\n    instance-info-replication-interval-seconds: 30\n    registry-fetch-interval-seconds: 3\n    serviceUrl:\n      defaultZone: http://febs:123456@localhost:8001/register/eureka/\nsecurity:\n  oauth2:\n    resource:\n      id: ${spring.application.name}\n      user-info-uri: http://localhost:8301/auth/user\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br")])]),e("p",[s._v("应用端口号为8202，服务名称为FEBS-Server-Test。")]),s._v(" "),e("p",[s._v("接着在cc.mrbird.febs.server.test目录下新建configure包，然后在该包下新建"),e("code",[s._v("FebsServerTestResourceServerConfigure")]),s._v("资源服务器配置类：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@Configuration\n@EnableResourceServer\npublic class FebsServerTestResourceServerConfigure extends ResourceServerConfigurerAdapter {\n\n    @Override\n    public void configure(HttpSecurity http) throws Exception {\n        http.csrf().disable()\n                .requestMatchers().antMatchers("/**")\n            .and()\n                .authorizeRequests()\n                .antMatchers("/**").authenticated();\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("p",[s._v("在cc.mrbird.febs.server.test目录下新建controller包，然后在该包下新建"),e("code",[s._v("TestController")]),s._v("对外提供一些REST服务：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@RestController\npublic class TestController {\n\n    @GetMapping("test1")\n    @PreAuthorize("hasAnyAuthority(\'user:add\')")\n    public String test1(){\n        return "拥有\'user:add\'权限";\n    }\n\n    @GetMapping("test2")\n    @PreAuthorize("hasAnyAuthority(\'user:update\')")\n    public String test2(){\n        return "拥有\'user:update\'权限";\n    }\n\n    @GetMapping("user")\n    public Principal currentUser(Principal principal) {\n        return principal;\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br")])]),e("p",[s._v("上面代码中，使用了权限注解保护方法，当用户已认证并且拥有"),e("code",[s._v("user:add")]),s._v("权限的时候，才能访问"),e("code",[s._v("test1")]),s._v("方法；当用户已认证并拥有"),e("code",[s._v("user:update")]),s._v("权限的时候才能访问"),e("code",[s._v("test2")]),s._v("方法。")]),s._v(" "),e("p",[s._v("最后在resources目录新建一个banner.txt文件：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("|------------------------------|\n|    ____  ____  ___   __      |\n|   | |_  | |_  | |_) ( (`     |\n|   |_|   |_|__ |_|_) _)_)     |\n|                              |\n|   ${spring.application.name}           |\n|   Spring-Boot: ${spring-boot.version} |\n|------------------------------|\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("h2",{attrs:{id:"postman测试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#postman测试"}},[s._v("#")]),s._v(" PostMan测试")]),s._v(" "),e("p",[s._v("到这里febs-server-system和febs-server-test模块创建完了，所以我们在febs-gateway模块里添加上相关的路由配置。修改febs-gateway模块的配置文件application.yml，添加如下路由配置：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('zuul:\n  routes:\n    system:\n      path: /system/**\n      serviceId: FEBS-Server-System\n      sensitiveHeaders: "*"\n    test:\n      path: /test/**\n      serviceId: FEBS-Server-Test\n      sensitiveHeaders: "*"\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[s._v("febs-gateway完整的配置文件application.yml如下所示：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('server:\n  port: 8301\n\nspring:\n  application:\n    name: FEBS-Gateway\n\neureka:\n  instance:\n    lease-renewal-interval-in-seconds: 20\n  client:\n    register-with-eureka: true\n    fetch-registry: true\n    instance-info-replication-interval-seconds: 30\n    registry-fetch-interval-seconds: 3\n    serviceUrl:\n      defaultZone: http://febs:123456@localhost:8001/register/eureka/\n\nzuul:\n  routes:\n    auth:\n      path: /auth/**\n      serviceId: FEBS-Auth\n      sensitiveHeaders: "*"\n    system:\n      path: /system/**\n      serviceId: FEBS-Server-System\n      sensitiveHeaders: "*"\n    test:\n      path: /test/**\n      serviceId: FEBS-Server-Test\n      sensitiveHeaders: "*"\n  retryable: true\n  ignored-services: "*"\n  ribbon:\n    eager-load:\n      enabled: true\n\nribbon:\n  ReadTimeout: 3000\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br")])]),e("p",[s._v("接下来在Services窗口逐步启动"),e("code",[s._v("FebsRegisterApplication")]),s._v("、"),e("code",[s._v("FebsAuthApplication")]),s._v("、"),e("code",[s._v("FebsGatewayApplication")]),s._v("、"),e("code",[s._v("FebsServerSystemApplication")]),s._v("和"),e("code",[s._v("FebsServerTestApplication")]),s._v("（别忘了Redis也必须开启）：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/07/e4b5gU.png",alt:"55.png"}})]),s._v(" "),e("p",[s._v("各个微服务系统都启动完毕后，使用PostMan发送 "),e("a",{attrs:{href:"localhost:8301/auth/oauth/token"}},[s._v("localhost:8301/auth/oauth/token")]),s._v(" POST请求，获取令牌：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/07/e4qpKe.png",alt:"56.png"}})]),s._v(" "),e("p",[s._v("发送 "),e("a",{attrs:{href:"localhost:8301/system/info"}},[s._v("localhost:8301/system/info")]),s._v(" GET请求，请求头携带令牌：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/07/e4qziq.png",alt:"57.png"}})]),s._v(" "),e("p",[s._v("如果不携带令牌看看请求能否成功：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/07/e4LFL4.png",alt:"58.png"}})]),s._v(" "),e("p",[s._v("请求返回401，提示需要认证。")]),s._v(" "),e("p",[s._v("发送 "),e("a",{attrs:{href:"localhost:8301/system/user"}},[s._v("localhost:8301/system/user")]),s._v(" GET请求，看看是否能够正常获取到当前用户信息：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/07/e4LeF1.png",alt:"59.png"}})]),s._v(" "),e("p",[s._v("发送 "),e("a",{attrs:{href:"localhost:8301/test/test1"}},[s._v("localhost:8301/test/test1")]),s._v(" GET请求，观察结果：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/07/e4LDmQ.png",alt:"60.png"}})]),s._v(" "),e("p",[s._v("因为我们在febs-auth模块的"),e("code",[s._v("FebsUserDetailService")]),s._v("定义的模拟用户拥有"),e("code",[s._v("user:add")]),s._v("权限，所以可以正常访问。")]),s._v(" "),e("p",[s._v("发送 "),e("a",{attrs:{href:"localhost:8301/test/test2"}},[s._v("localhost:8301/test/test2")]),s._v(" GET请求，看看是否能够正常访问：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/07/e4LO1K.png",alt:"61.png"}})]),s._v(" "),e("p",[s._v("因为用户没有"),e("code",[s._v("user:update")]),s._v("权限，所以访问febs-server-test模块的"),e("code",[s._v("/test2")]),s._v("资源，返回403（权限不足）异常。")]),s._v(" "),e("p",[s._v("发送 "),e("a",{attrs:{href:"localhost:8301/test/user"}},[s._v("localhost:8301/test/user")]),s._v(" GET请求，看看是否也能够获取到当前登录用户信息:")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/07/e4O13V.png",alt:"62.png"}})]),s._v(" "),e("h2",{attrs:{id:"本章小结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#本章小结"}},[s._v("#")]),s._v(" 本章小结")]),s._v(" "),e("p",[s._v("到这里，FEBS-Cloud微服务权限系统的基础框架已经搭建好了。好的开始是成功的一半，我们已经实现了认证服务器和资源服务器分离的情况下，通过认证服务器统一发放访问令牌，使用访问令牌获取资源服务器提供的服务，并且所有的请求都是通过微服务网关转发完成的。")]),s._v(" "),e("p",[s._v("但目前系统还是不够完整，还存在着许多细节需要我们去完善，下一节中，我们将逐步分析当前系统存在的问题，并一起解决它们。")])])}),[],!1,null,null,null);e.default=t.exports}}]);