(window.webpackJsonp=window.webpackJsonp||[]).push([[338],{692:function(s,e,n){"use strict";n.r(e);var t=n(0),a=Object(t.a)({},(function(){var s=this,e=s._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("目前系统的异常响应都是以Spring内部构建好的默认的格式返回，这一节中我们将自定义各种异常处理器，将默认的异常响应“翻译”为符合我们期望的格式响应。")]),s._v(" "),e("h2",{attrs:{id:"认证异常翻译"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#认证异常翻译"}},[s._v("#")]),s._v(" 认证异常翻译")]),s._v(" "),e("p",[s._v("默认情况下，当我们在获取令牌时输入错误的用户名或密码，系统返回如下格式响应:")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('{\n    "error": "invalid_grant",\n    "error_description": "Bad credentials"\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("当grant_type错误时，系统返回：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('{\n    "error": "unsupported_grant_type",\n    "error_description": "Unsupported grant type: passwordd"\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("接下来我们定义一个异常翻译器，将这些认证类型异常翻译为友好的格式。在febs-auth模块cc.mrbird.febs.auth路径下新建translator包，然后在该包下新建"),e("code",[s._v("FebsWebResponseExceptionTranslator")]),s._v("：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@Slf4j\n@Component\npublic class FebsWebResponseExceptionTranslator implements WebResponseExceptionTranslator {\n\n    @Override\n    public ResponseEntity translate(Exception e) {\n        ResponseEntity.BodyBuilder status = ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR);\n        FebsResponse response = new FebsResponse();\n        String message = "认证失败";\n        log.error(message, e);\n        if (e instanceof UnsupportedGrantTypeException) {\n            message = "不支持该认证类型";\n            return status.body(response.message(message));\n        }\n        if (e instanceof InvalidGrantException) {\n            if (StringUtils.containsIgnoreCase(e.getMessage(), "Invalid refresh token")) {\n                message = "refresh token无效";\n                return status.body(response.message(message));\n            }\n            if (StringUtils.containsIgnoreCase(e.getMessage(), "locked")) {\n                message = "用户已被锁定，请联系管理员";\n                return status.body(response.message(message));\n            }\n            message = "用户名或密码错误";\n            return status.body(response.message(message));\n        }\n        return status.body(response.message(message));\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br")])]),e("p",[e("code",[s._v("FebsWebResponseExceptionTranslator")]),s._v("实现了"),e("code",[s._v("WebResponseExceptionTranslator")]),s._v("接口，用于覆盖默认的认证异常响应。在"),e("code",[s._v("translate")]),s._v("方法中，我们通过"),e("code",[s._v("Exception")]),s._v("异常对象的类型和内容将异常归类，并且统一返回500HTTP状态码（"),e("code",[s._v("HttpStatus.INTERNAL_SERVER_ERROR")]),s._v("）。")]),s._v(" "),e("p",[s._v("此外，类上"),e("code",[s._v("@Component")]),s._v("注解用于将当前类注册为一个Bean，"),e("code",[s._v("@sl4j")]),s._v("注解为lombok类型注解，用于往当前类中注入"),e("code",[s._v("org.slf4j.Logger")]),s._v("日志打印对象，效果相当于在类里定义如下属性：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("private Logger log = LoggerFactory.getLogger(this.getClass());\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("要让这个异常翻译器生效，我们还需在认证服务器配置类"),e("code",[s._v("FebsAuthorizationServerConfigure")]),s._v("的"),e("code",[s._v("configure(AuthorizationServerEndpointsConfigurer endpoints)")]),s._v("方法里指定它：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@Configuration\n@EnableAuthorizationServer\npublic class FebsAuthorizationServerConfigure extends AuthorizationServerConfigurerAdapter {\n\n    ......\n    \n    @Autowired\n    private FebsWebResponseExceptionTranslator exceptionTranslator;\n\n    ......\n\n    @Override\n    @SuppressWarnings("all")\n    public void configure(AuthorizationServerEndpointsConfigurer endpoints) {\n        endpoints.tokenStore(tokenStore())\n                .userDetailsService(userDetailService)\n                .authenticationManager(authenticationManager)\n                .tokenServices(defaultTokenServices())\n                .exceptionTranslator(exceptionTranslator);\n    }\n    ......\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br")])]),e("p",[s._v("配置好后，重启febs-auth模块，在获取令牌的时候，当输入错误的用户名密码时，系统返回：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/07/e5Wn39.png",alt:"65.png"}})]),s._v(" "),e("p",[s._v("当grant_type填写为hello的时候，系统返回：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/07/e5WhD0.png",alt:"66.png"}})]),s._v(" "),e("p",[s._v("在通过refresh_token刷新令牌的时候，填写错误的refresh_token，系统返回：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/07/e5Wb8J.png",alt:"67.png"}})]),s._v(" "),e("h2",{attrs:{id:"处理资源服务器异常"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#处理资源服务器异常"}},[s._v("#")]),s._v(" 处理资源服务器异常")]),s._v(" "),e("p",[s._v("资源服务器异常主要有两种：令牌不正确返回401和用户无权限返回403。因为资源服务器有多个，所以相关的异常处理类可以定义在febs-common通用模块里。")]),s._v(" "),e("p",[s._v("在febs-common模块cc.mrbird.febs.common路径下新建handler包，然后在该包下新建"),e("code",[s._v("FebsAuthExceptionEntryPoint")]),s._v("：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('public class FebsAuthExceptionEntryPoint implements AuthenticationEntryPoint {\n\n    @Override\n    public void commence(HttpServletRequest request, HttpServletResponse response,\n                         AuthenticationException authException) throws IOException {\n        FebsResponse febsResponse = new FebsResponse();\n\n        response.setContentType("application/json;charset=UTF-8");\n        response.setStatus(401);\n        response.getOutputStream().write(JSONObject.toJSONString(febsResponse.message("token无效")).getBytes());\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("p",[e("code",[s._v("FebsAuthExceptionEntryPoint")]),s._v("实现了"),e("code",[s._v("AuthenticationEntryPoint")]),s._v("接口的"),e("code",[s._v("commence")]),s._v("方法，在方法内自定义了响应的格式。")]),s._v(" "),e("p",[s._v("其中"),e("code",[s._v("application/json;charset=UTF-8")]),s._v("和HTTP状态码401，Spring都提供了相应的常量类，所以上面代码可以优化为：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('public class FebsAuthExceptionEntryPoint implements AuthenticationEntryPoint {\n\n    @Override\n    public void commence(HttpServletRequest request, HttpServletResponse response,\n                         AuthenticationException authException) throws IOException {\n        FebsResponse febsResponse = new FebsResponse();\n\n        response.setContentType(MediaType.APPLICATION_JSON_UTF8_VALUE);\n        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);\n        response.getOutputStream().write(JSONObject.toJSONString(febsResponse.message("token无效")).getBytes());\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("p",[s._v("此外，构造响应的这几行代码后续会经常使用到，所以我们可以将它抽取为一个工具方法。")]),s._v(" "),e("p",[s._v("在febs-common模块的cc.mrbird.febs.common路径下新建utils包，然后在该包下新建"),e("code",[s._v("FebsUtil")]),s._v("工具类，并定义如下方法：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("@Slf4j\npublic class FebsUtil {\n\n    /**\n     * 设置响应\n     *\n     * @param response    HttpServletResponse\n     * @param contentType content-type\n     * @param status      http状态码\n     * @param value       响应内容\n     * @throws IOException IOException\n     */\n    public static void makeResponse(HttpServletResponse response, String contentType,\n                                    int status, Object value) throws IOException {\n        response.setContentType(contentType);\n        response.setStatus(status);\n        response.getOutputStream().write(JSONObject.toJSONString(value).getBytes());\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br")])]),e("p",[s._v("于是"),e("code",[s._v("FebsAuthExceptionEntryPoint")]),s._v("最终代码如下所示:")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('public class FebsAuthExceptionEntryPoint implements AuthenticationEntryPoint {\n\n    @Override\n    public void commence(HttpServletRequest request, HttpServletResponse response,\n                         AuthenticationException authException) throws IOException {\n        FebsResponse febsResponse = new FebsResponse();\n        FebsUtil.makeResponse(\n                response, MediaType.APPLICATION_JSON_UTF8_VALUE,\n                HttpServletResponse.SC_UNAUTHORIZED, febsResponse.message("token无效")\n        );\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("p",[s._v("接着在febs-common的cc.mrbird.febs.common.handler路径下新建"),e("code",[s._v("FebsAccessDeniedHandler")]),s._v("用于处理403类型异常：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('public class FebsAccessDeniedHandler implements AccessDeniedHandler {\n\n    @Override\n    public void handle(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException) throws IOException {\n        FebsResponse febsResponse = new FebsResponse();\n        FebsUtil.makeResponse(\n                response, MediaType.APPLICATION_JSON_UTF8_VALUE,\n                HttpServletResponse.SC_FORBIDDEN, febsResponse.message("没有权限访问该资源"));\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[s._v("响应码为"),e("code",[s._v("HttpServletResponse.SC_FORBIDDEN")]),s._v("，即403。")]),s._v(" "),e("p",[s._v("因为febs-common模块是一个普通的maven项目，并不是一个Spring Boot项目，所以即使在这两个类上使用"),e("code",[s._v("@Component")]),s._v("注解标注，它们也不能被成功注册到各个微服务子系统的Spring IOC容器中。我们可以使用"),e("code",[s._v("@Enable")]),s._v("模块驱动的方式来解决这个问题。")]),s._v(" "),e("p",[s._v("在febs-common模块的cc.mrbird.febs.common路径下新建configure包，然后在该包下新建"),e("code",[s._v("FebsAuthExceptionConfigure")]),s._v("配置类：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('public class FebsAuthExceptionConfigure {\n\n    @Bean\n    @ConditionalOnMissingBean(name = "accessDeniedHandler")\n    public FebsAccessDeniedHandler accessDeniedHandler() {\n        return new FebsAccessDeniedHandler();\n    }\n\n    @Bean\n    @ConditionalOnMissingBean(name = "authenticationEntryPoint")\n    public FebsAuthExceptionEntryPoint authenticationEntryPoint() {\n        return new FebsAuthExceptionEntryPoint();\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br")])]),e("p",[s._v("在该配置类中，我们注册了"),e("code",[s._v("FebsAccessDeniedHandler")]),s._v("和"),e("code",[s._v("FebsAuthExceptionEntryPoint")]),s._v("。"),e("code",[s._v("@ConditionalOnMissingBean")]),s._v("注解的意思是，当IOC容器中没有指定名称或类型的Bean的时候，就注册它。以"),e("code",[s._v('@ConditionalOnMissingBean(name = "accessDeniedHandler")')]),s._v("为例，当微服务系统的Spring IOC容器中没有名称为"),e("code",[s._v("accessDeniedHandler")]),s._v("的Bean的时候，就将"),e("code",[s._v("FebsAccessDeniedHandler")]),s._v("注册为一个Bean。这样做的好处在于，子系统可以自定义自个儿的资源服务器异常处理器，覆盖我们在febs-common通用模块里定义的。")]),s._v(" "),e("p",[s._v("接着定义一个注解来驱动该配置类。")]),s._v(" "),e("p",[s._v("在febs-common模块的cc.mrbird.febs.common路径下新建annotation包，然后在该包下新建"),e("code",[s._v("EnableFebsAuthExceptionHandler")]),s._v("注解：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("@Target({ElementType.TYPE})\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Import(FebsAuthExceptionConfigure.class)\npublic @interface EnableFebsAuthExceptionHandler {\n\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("在该注解上，我们使用"),e("code",[s._v("@Import")]),s._v("将"),e("code",[s._v("FebsAuthExceptionConfigure")]),s._v("配置类引入了进来。")]),s._v(" "),e("p",[s._v("最后演示下如何使用"),e("code",[s._v("@EnableFebsAuthExceptionHandler")]),s._v("注解。")]),s._v(" "),e("p",[s._v("因为febs-auth，febs-server-system，febs-server-test都是资源服务器，所以它们三个都需要使用"),e("code",[s._v("@EnableFebsAuthExceptionHandler")]),s._v("注解实现资源服务器异常处理。三者的步骤都是一模一样的，所以这里以febs-auth模块为例，剩下的febs-server-system和febs-server-test照着配置即可。")]),s._v(" "),e("p",[s._v("在febs-auth模块的入口类上使用"),e("code",[s._v("@EnableFebsAuthExceptionHandler")]),s._v("注解标注：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("@EnableDiscoveryClient\n@SpringBootApplication\n@EnableFebsAuthExceptionHandler\npublic class FebsAuthApplication {\n    public static void main(String[] args) {\n        SpringApplication.run(FebsAuthApplication.class, args);\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("通过该注解，febs-auth模块的IOC容器里就已经注册了"),e("code",[s._v("FebsAccessDeniedHandler")]),s._v("和"),e("code",[s._v("FebsAuthExceptionEntryPoint")]),s._v("。")]),s._v(" "),e("p",[s._v("然后在资源服务器配置类"),e("code",[s._v("FebsResourceServerConfigurer")]),s._v("里注入它们，并配置：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@Configuration\n@EnableResourceServer\npublic class FebsResourceServerConfigurer extends ResourceServerConfigurerAdapter {\n\n    @Autowired\n    private FebsAccessDeniedHandler accessDeniedHandler;\n    @Autowired\n    private FebsAuthExceptionEntryPoint exceptionEntryPoint;\n\n    @Override\n    public void configure(HttpSecurity http) throws Exception {\n        http.csrf().disable()\n                .requestMatchers().antMatchers("/**")\n                .and()\n                .authorizeRequests()\n                .antMatchers("/**").authenticated();\n    }\n\n    @Override\n    public void configure(ResourceServerSecurityConfigurer resources) {\n        resources.authenticationEntryPoint(exceptionEntryPoint)\n                .accessDeniedHandler(accessDeniedHandler);\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br")])]),e("p",[s._v("febs-server-system和febs-server-test模块也按照这两个步骤配置即可。")]),s._v(" "),e("p",[s._v("重启febs-auth、febs-server-system和febs-server-test模块，使用PostMan发送")]),s._v(" "),e("p",[e("a",{attrs:{href:"localhost:8301/system/info"}},[s._v("localhost:8301/system/info")]),s._v(" GET请求，输入错误的令牌观察系统返回：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/07/e5OXf1.png",alt:"68.png"}})]),s._v(" "),e("p",[s._v("使用PostMan发送 "),e("a",{attrs:{href:"localhost:8301/test/test2"}},[s._v("localhost:8301/test/test2")]),s._v(" GET请求，输入正确的令牌观察系统返回：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/07/e5X0AJ.png",alt:"69.png"}})]),s._v(" "),e("p",[s._v("说明我们上面的配置已经生效。")]),s._v(" "),e("p",[s._v("注：对Spring"),e("code",[s._v("@Enable")]),s._v("模块驱动不了解的同学可以参考我的博客：https://mrbird.cc/deepin-springboot-autoconfig.html")]),s._v(" "),e("h2",{attrs:{id:"处理zuul异常"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#处理zuul异常"}},[s._v("#")]),s._v(" 处理Zuul异常")]),s._v(" "),e("p",[s._v("当Zuul转发请求超时时，系统返回如下响应：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('{\n    "timestamp": "2019-08-07T07:58:21.938+0000",\n    "status": 504,\n    "error": "Gateway Timeout",\n    "message": "com.netflix.zuul.exception.ZuulException: Hystrix Readed time out"\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("当处理转发请求的微服务模块不可用时，系统返回：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('{\n    "timestamp": "2019-08-07T08:01:31.829+0000",\n    "status": 500,\n    "error": "Internal Server Error",\n    "message": "GENERAL"\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("自定义Zuul异常处理可以通过继承Zuul的"),e("code",[s._v("SendErrorFilter")]),s._v("过滤器来实现。")]),s._v(" "),e("p",[s._v("在febs-gateway模块的cc.mrbird.febs.gateway路径下新建filter包，然后在该包下新建"),e("code",[s._v("FebsGatewayErrorFilter")]),s._v("过滤器：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@Slf4j\n@Component\npublic class FebsGatewayErrorFilter extends SendErrorFilter {\n\n    @Override\n    public Object run() {\n        try {\n            FebsResponse febsResponse = new FebsResponse();\n            RequestContext ctx = RequestContext.getCurrentContext();\n            String serviceId = (String) ctx.get(FilterConstants.SERVICE_ID_KEY);\n\n            ExceptionHolder exception = findZuulException(ctx.getThrowable());\n            String errorCause = exception.getErrorCause();\n            Throwable throwable = exception.getThrowable();\n            String message = throwable.getMessage();\n            message = StringUtils.isBlank(message) ? errorCause : message;\n            febsResponse = resolveExceptionMessage(message, serviceId, febsResponse);\n\n            HttpServletResponse response = ctx.getResponse();\n            FebsUtil.makeResponse(\n                    response, MediaType.APPLICATION_JSON_UTF8_VALUE,\n                    HttpServletResponse.SC_INTERNAL_SERVER_ERROR, febsResponse\n            );\n            log.error("Zull sendError：{}", febsResponse.getMessage());\n        } catch (Exception ex) {\n            log.error("Zuul sendError", ex);\n            ReflectionUtils.rethrowRuntimeException(ex);\n        }\n        return null;\n    }\n\n    private FebsResponse resolveExceptionMessage(String message, String serviceId, FebsResponse febsResponse) {\n        if (StringUtils.containsIgnoreCase(message, "time out")) {\n            return febsResponse.message("请求" + serviceId + "服务超时");\n        }\n        if (StringUtils.containsIgnoreCase(message, "forwarding error")) {\n            return febsResponse.message(serviceId + "服务不可用");\n        }\n        return febsResponse.message("Zuul请求" + serviceId + "服务异常");\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br")])]),e("p",[s._v("在该过滤器中，我们可以通过"),e("code",[s._v("RequestContext")]),s._v("获取到当前请求上下文，通过请求上下文可以获取到当前请求的服务名称"),e("code",[s._v("serviceId")]),s._v("和当前请求的异常对象"),e("code",[s._v("ExceptionHolder")]),s._v("等信息。通过异常对象我们可以继续获取到异常内容，根据不同的异常内容我们可以自定义想要的响应。")]),s._v(" "),e("p",[s._v("要让我们自定义的Zuul异常过滤器生效，还需要在febs-gateway的配置文件中添加如下配置，让默认的异常过滤器失效：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("zuul:\n  SendErrorFilter:\n    error:\n      disable: true\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("重启febs-gateway模块，当请求服务超时时，响应如下所示：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/07/eIKGCR.png",alt:"70.png"}})]),s._v(" "),e("p",[s._v("当请求的服务不可用时候，响应如下所示：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/07/eIKaDO.png",alt:"71.png"}})]),s._v(" "),e("h2",{attrs:{id:"全局异常处理器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#全局异常处理器"}},[s._v("#")]),s._v(" 全局异常处理器")]),s._v(" "),e("p",[s._v("所谓的全局异常处理指的是全局处理Controller层抛出来的异常。因为全局异常处理器在各个微服务系统里都能用到，所以我们把它定义在febs-common模块里。")]),s._v(" "),e("p",[s._v("在febs-common模块的cc.mrbird.febs.common.handler路径下新建"),e("code",[s._v("BaseExceptionHandler")]),s._v("：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@Slf4j\npublic class BaseExceptionHandler {\n\n    @ExceptionHandler(value = Exception.class)\n    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)\n    public FebsResponse handleException(Exception e) {\n        log.error("系统内部异常，异常信息", e);\n        return new FebsResponse().message("系统内部异常");\n    }\n\n    @ExceptionHandler(value = FebsAuthException.class)\n    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)\n    public FebsResponse handleFebsAuthException(FebsAuthException e) {\n        log.error("系统错误", e);\n        return new FebsResponse().message(e.getMessage());\n    }\n    \n    @ExceptionHandler(value = AccessDeniedException.class)\n    @ResponseStatus(HttpStatus.FORBIDDEN)\n    public FebsResponse handleAccessDeniedException(){\n        return new FebsResponse().message("没有权限访问该资源");\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br")])]),e("p",[s._v("然后以febs-auth为例，在febs-auth模块的cc.mrbird.febs.auth路径下新建handler包，然后在该包下新建"),e("code",[s._v("GlobalExceptionHandler")]),s._v("类：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("@RestControllerAdvice\n@Order(value = Ordered.HIGHEST_PRECEDENCE)\npublic class GlobalExceptionHandler extends BaseExceptionHandler {\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("对于通用的异常类型捕获可以在"),e("code",[s._v("BaseExceptionHandler")]),s._v("中定义，而当前微服务系统独有的异常类型捕获可以在"),e("code",[s._v("GlobalExceptionHandler")]),s._v("中定义。")]),s._v(" "),e("p",[s._v("febs-server-system和febs-server-test模块处理方式和febs-auth一致，这里就不演示了。")])])}),[],!1,null,null,null);e.default=a.exports}}]);