(window.webpackJsonp=window.webpackJsonp||[]).push([[343],{695:function(s,n,e){"use strict";e.r(n);var a=e(0),r=Object(a.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[s._v("上一小节中，我们已经创建好了数据库和数据表，这一节开始接入持久层框架并完善登录过程。")]),s._v(" "),n("h2",{attrs:{id:"整合mybatis-plus"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#整合mybatis-plus"}},[s._v("#")]),s._v(" 整合MyBatis Plus")]),s._v(" "),n("p",[s._v("持久层框架使用时下热门的MyBatis增强插件"),n("a",{attrs:{href:"https://baomidou.gitee.io/mybatis-plus-doc/#/",target:"_blank",rel:"noopener noreferrer"}},[s._v("MyBatis Plus"),n("OutboundLink")],1),s._v("。")]),s._v(" "),n("p",[s._v("因为后续多个微服务系统需要用到MyBatis Plus，并且数据表对应的实体类是定义在febs-common模块里的，所以我们选择在febs-common模块里引入相应的MyBatis Plus依赖。")]),s._v(" "),n("p",[s._v("在febs-common模块的pom里引入MyBatis Plus依赖：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("<dependency>\n    <groupId>com.baomidou</groupId>\n    <artifactId>mybatis-plus-boot-starter</artifactId>\n    <version>3.1.2</version>\n</dependency>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("然后在febs-auth模块的pom里引入MySQL连接驱动和MyBatis Plus多数据源依赖：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("<dependency>\n    <groupId>com.baomidou</groupId>\n    <artifactId>dynamic-datasource-spring-boot-starter</artifactId>\n    <version>2.5.4</version>\n</dependency>\n<dependency>\n    <groupId>mysql</groupId>\n    <artifactId>mysql-connector-java</artifactId>\n    <scope>runtime</scope>\n</dependency>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("接着在febs-auth模块的配置文件application.yml里添加多数据源配置：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("spring:\n  datasource:\n    dynamic:\n      hikari:\n        connection-timeout: 30000\n        max-lifetime: 1800000\n        max-pool-size: 15\n        min-idle: 5\n        connection-test-query: select 1\n        pool-name: FebsHikariCP\n      primary: base\n      datasource:\n        base:\n          username: root\n          password: 123456\n          driver-class-name: com.mysql.cj.jdbc.Driver\n          url: jdbc:mysql://localhost:3306/febs_cloud_base?useUnicode=true&characterEncoding=UTF-8&useJDBCCompliantTimezoneShift=true&useLegacyDatetimeCode=false&serverTimezone=GMT%2b8\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("p",[s._v("这里数据库连接池使用的是"),n("a",{attrs:{href:"https://github.com/brettwooldridge/HikariCP",target:"_blank",rel:"noopener noreferrer"}},[s._v("Hikari"),n("OutboundLink")],1),s._v("，Spring Boot2.0后官方推荐使用该连接池，特点是响应速度快。这里只配置了一个名称为base的数据源，如果要继续添加数据源的话只需要在"),n("code",[s._v("spring.datasource.dynamic.datasource")]),s._v("下继续添加即可。")]),s._v(" "),n("p",[s._v("配置好多数据源后，开始配置MyBatis Plus。在febs-auth的配置文件application.yml里添加如下配置：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("mybatis-plus:\n  type-aliases-package: cc.mrbird.febs.common.entity.system\n  mapper-locations: classpath:mapper/*.xml\n  configuration:\n    jdbc-type-for-null: null\n  global-config:\n    banner: false\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("上述配置的含义如下：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("mybatis-plus.type-aliases-package")]),s._v("，指定别名扫描路径，这个路径后续在febs-common模块里定义，该路径下的实体类将自动配置别名，默认为类名首字母小写。配置别名后，便可以直接在MyBatis XML文件里使用了；")]),s._v(" "),n("li",[n("code",[s._v("mybatis-plus.mapper-locations")]),s._v("指定MyBatis XML文件路径；")]),s._v(" "),n("li",[n("code",[s._v("mybatis-plus.configuration.jdbc-type-for-null")]),s._v("，指定为null，否则再插入空值时会报“无效的列类型”错误；")]),s._v(" "),n("li",[n("code",[s._v("mybatis-plus.configuration.global-config.banner")]),s._v("设置为false关闭MyBatis Plus Banner打印。")])]),s._v(" "),n("p",[s._v("更多MyBatis Plus配置可以参考其官方文档。")]),s._v(" "),n("p",[s._v("此外，因为我们在febs-common模块里引入了"),n("code",[s._v("mybatis-plus-boot-starter")]),s._v("，该starter包含数据库自动装配配置，而febs-gateway、febs-server-system和febs-server-test模块并没有配置数据库，所以我们需要在它们的配置文件application.yml里添加如下配置来关闭数据库自动装配:")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("spring:\n  autoconfigure:\n    exclude: org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("否则这些模块在启动的时候将抛出异常："),n("strong",[s._v("Failed to configure a DataSource: 'url' attribute is not specified and no embedded datasource could be configured.")])]),s._v(" "),n("h2",{attrs:{id:"用户持久层操作"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#用户持久层操作"}},[s._v("#")]),s._v(" 用户持久层操作")]),s._v(" "),n("p",[s._v("在febs-common模块的cc.mrbird.febs.common.entity路径下新建system包，然后在该包下新建"),n("code",[s._v("SystemUser")]),s._v("实体类，对应t_user用户表数据：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Data\n@TableName("t_user")\npublic class SystemUser implements Serializable {\n\n    private static final long serialVersionUID = -4352868070794165001L;\n\n    // 用户状态：有效\n    public static final String STATUS_VALID = "1";\n    // 用户状态：锁定\n    public static final String STATUS_LOCK = "0";\n    // 默认头像\n    public static final String DEFAULT_AVATAR = "default.jpg";\n    // 默认密码\n    public static final String DEFAULT_PASSWORD = "1234qwer";\n    // 性别男\n    public static final String SEX_MALE = "0";\n    // 性别女\n    public static final String SEX_FEMALE = "1";\n    // 性别保密\n    public static final String SEX_UNKNOW = "2";\n\n    /**\n     * 用户 ID\n     */\n    @TableId(value = "USER_ID", type = IdType.AUTO)\n    private Long userId;\n\n    /**\n     * 用户名\n     */\n    @TableField("USERNAME")\n    private String username;\n\n    /**\n     * 密码\n     */\n    @TableField("PASSWORD")\n    private String password;\n\n    /**\n     * 部门 ID\n     */\n    @TableField("DEPT_ID")\n    private Long deptId;\n\n    /**\n     * 邮箱\n     */\n    @TableField("EMAIL")\n    private String email;\n\n    /**\n     * 联系电话\n     */\n    @TableField("MOBILE")\n    private String mobile;\n\n    /**\n     * 状态 0锁定 1有效\n     */\n    @TableField("STATUS")\n    private String status;\n\n    /**\n     * 创建时间\n     */\n    @TableField("CREATE_TIME")\n    private Date createTime;\n\n    /**\n     * 修改时间\n     */\n    @TableField("MODIFY_TIME")\n    private Date modifyTime;\n\n    /**\n     * 最近访问时间\n     */\n    @TableField("LAST_LOGIN_TIME")\n    private Date lastLoginTime;\n\n    /**\n     * 性别 0男 1女 2 保密\n     */\n    @TableField("SSEX")\n    private String sex;\n\n    /**\n     * 头像\n     */\n    @TableField("AVATAR")\n    private String avatar;\n\n    /**\n     * 描述\n     */\n    @TableField("DESCRIPTION")\n    private String description;\n\n    /**\n     * 部门名称\n     */\n    @TableField(exist = false)\n    private String deptName;\n\n    @TableField(exist = false)\n    private String createTimeFrom;\n    @TableField(exist = false)\n    private String createTimeTo;\n    /**\n     * 角色 ID\n     */\n    @TableField(exist = false)\n    private String roleId;\n\n    @TableField(exist = false)\n    private String roleName;\n\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br"),n("span",{staticClass:"line-number"},[s._v("91")]),n("br"),n("span",{staticClass:"line-number"},[s._v("92")]),n("br"),n("span",{staticClass:"line-number"},[s._v("93")]),n("br"),n("span",{staticClass:"line-number"},[s._v("94")]),n("br"),n("span",{staticClass:"line-number"},[s._v("95")]),n("br"),n("span",{staticClass:"line-number"},[s._v("96")]),n("br"),n("span",{staticClass:"line-number"},[s._v("97")]),n("br"),n("span",{staticClass:"line-number"},[s._v("98")]),n("br"),n("span",{staticClass:"line-number"},[s._v("99")]),n("br"),n("span",{staticClass:"line-number"},[s._v("100")]),n("br"),n("span",{staticClass:"line-number"},[s._v("101")]),n("br"),n("span",{staticClass:"line-number"},[s._v("102")]),n("br"),n("span",{staticClass:"line-number"},[s._v("103")]),n("br"),n("span",{staticClass:"line-number"},[s._v("104")]),n("br"),n("span",{staticClass:"line-number"},[s._v("105")]),n("br"),n("span",{staticClass:"line-number"},[s._v("106")]),n("br"),n("span",{staticClass:"line-number"},[s._v("107")]),n("br"),n("span",{staticClass:"line-number"},[s._v("108")]),n("br"),n("span",{staticClass:"line-number"},[s._v("109")]),n("br"),n("span",{staticClass:"line-number"},[s._v("110")]),n("br"),n("span",{staticClass:"line-number"},[s._v("111")]),n("br"),n("span",{staticClass:"line-number"},[s._v("112")]),n("br"),n("span",{staticClass:"line-number"},[s._v("113")]),n("br"),n("span",{staticClass:"line-number"},[s._v("114")]),n("br"),n("span",{staticClass:"line-number"},[s._v("115")]),n("br"),n("span",{staticClass:"line-number"},[s._v("116")]),n("br"),n("span",{staticClass:"line-number"},[s._v("117")]),n("br"),n("span",{staticClass:"line-number"},[s._v("118")]),n("br"),n("span",{staticClass:"line-number"},[s._v("119")]),n("br")])]),n("p",[n("code",[s._v('@TableName("t_user")')]),s._v("注解用于指定对应数据表的表名；"),n("code",[s._v("@TableField")]),s._v("用于指定数据表字段名称；"),n("code",[s._v("@TableField(exist = false)")]),s._v("表示非数据表字段，非数据表字段一般用于拓展查询结果；"),n("code",[s._v("@TableId")]),s._v("表示该字段为数据表主键。")]),s._v(" "),n("p",[s._v("接着在system路径下新建"),n("code",[s._v("Menu")]),s._v("实体类，对应t_menu数据表：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Data\n@TableName("t_menu")\npublic class Menu implements Serializable {\n\n    private static final long serialVersionUID = 7187628714679791771L;\n\n    // 菜单\n    public static final String TYPE_MENU = "0";\n    // 按钮\n    public static final String TYPE_BUTTON = "1";\n\n    /**\n     * 菜单/按钮ID\n     */\n    @TableId(value = "MENU_ID", type = IdType.AUTO)\n    private Long menuId;\n\n    /**\n     * 上级菜单ID\n     */\n    @TableField("PARENT_ID")\n    private Long parentId;\n\n    /**\n     * 菜单/按钮名称\n     */\n    @TableField("MENU_NAME")\n    private String menuName;\n\n    /**\n     * 菜单URL\n     */\n    @TableField("PATH")\n    private String path;\n\n    /**\n     * 对应 Vue组件\n     */\n    @TableField("COMPONENT")\n    private String component;\n\n    /**\n     * 权限标识\n     */\n    @TableField("PERMS")\n    private String perms;\n\n    /**\n     * 图标\n     */\n    @TableField("ICON")\n    private String icon;\n\n    /**\n     * 类型 0菜单 1按钮\n     */\n    @TableField("TYPE")\n    private String type;\n\n    /**\n     * 排序\n     */\n    @TableField("ORDER_NUM")\n    private Integer orderNum;\n\n    /**\n     * 创建时间\n     */\n    @TableField("CREATE_TIME")\n    private Date createTime;\n\n    /**\n     * 修改时间\n     */\n    @TableField("MODIFY_TIME")\n    private Date modifyTime;\n\n    private transient String createTimeFrom;\n    private transient String createTimeTo;\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br")])]),n("p",[s._v("非表字段除了使用"),n("code",[s._v("@TableField(exist = false)")]),s._v("注解标注外，也可以使用"),n("code",[s._v("transient")]),s._v("关键字。")]),s._v(" "),n("p",[s._v("创建完实体类后，开始创建Dao层。")]),s._v(" "),n("p",[s._v("在febs-auth模块的cc.mrbird.febs.auth路径下新建mapper包，然后在该包下新建"),n("code",[s._v("UserMapper")]),s._v("和"),n("code",[s._v("MenuMapper")]),s._v("：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("public interface UserMapper extends BaseMapper<SystemUser> {\n    SystemUser findByName(String username);\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[n("code",[s._v("findByName")]),s._v("方法用于通过用户名查找用户信息。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("public interface MenuMapper extends BaseMapper<Menu> {\n    List<Menu> findUserPermissions(String username);\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[n("code",[s._v("findUserPermissions")]),s._v("方法用于通过用户名查找用户权限集合。")]),s._v(" "),n("p",[s._v("虽然通过继承"),n("code",[s._v("BaseMapper<T>")]),s._v("，我们的Mapper接口已经包含了基础的单表增删改查方法，但是上面两个接口的方法都需要通过关联数据表的方式查询数据，所以我们需要使用传统的MyBatis XML映射的方式来实现。")]),s._v(" "),n("p",[s._v("在febs-auth模块的resources路径下新建mapper包，这个路径对应application.yml里配置的"),n("code",[s._v("mybatis-plus.type-aliases-package")]),s._v("。然后在该包下新建"),n("code",[s._v("UserMapper.xml")]),s._v("和"),n("code",[s._v("MenuMapper.xml")]),s._v("：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">\n<mapper namespace="cc.mrbird.febs.auth.mapper.UserMapper">\n    <select id="findByName" parameterType="string" resultType="systemUser">\n        SELECT\n        u.user_id userId,\n        u.username,\n        u.email,\n        u.mobile,\n        u.password,\n        u.status,\n        u.create_time createTime,\n        u.ssex sex,\n        u.dept_id deptId,\n        u.last_login_time lastLoginTime,\n        u.modify_time modifyTime,\n        u.description,\n        u.avatar,\n        d.dept_name deptName,\n        GROUP_CONCAT(r.role_id) roleId,\n        GROUP_CONCAT(r.ROLE_NAME) roleName\n        FROM\n        t_user u\n        LEFT JOIN t_dept d ON (u.dept_id = d.dept_id)\n        LEFT JOIN t_user_role ur ON (u.user_id = ur.user_id)\n        LEFT JOIN t_role r ON r.role_id = ur.role_id\n        WHERE  u.username = #{username}\n        group by u.username,u.user_id,u.email,u.mobile,u.password, u.status,u.create_time,u.ssex,u.dept_id\n\t\t\t\t,u.last_login_time,u.modify_time,u.description,u.avatar\n    </select>\n</mapper>\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br")])]),n("p",[s._v("返回值类型为"),n("code",[s._v("systemUser")]),s._v("，即febs-common模块cc.mrbird.febs.common.entity.system路径下的"),n("code",[s._v("SystemUser")]),s._v("，因为设置了别名所以可以直接使用。这个SQL逻辑就是通过多表关联的方式来查询出用户的详细信息，较为简单不做详细说明。")]),s._v(" "),n("p",[n("code",[s._v("MenuMapper.xml")]),s._v("代码如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">\n<mapper namespace="cc.mrbird.febs.auth.mapper.MenuMapper">\n    <select id="findUserPermissions" resultType="menu">\n        select distinct m.perms\n        from t_role r\n                 left join t_user_role ur on (r.role_id = ur.role_id)\n                 left join t_user u on (u.user_id = ur.user_id)\n                 left join t_role_menu rm on (rm.role_id = r.role_id)\n                 left join t_menu m on (m.menu_id = rm.menu_id)\n        where u.username = #{userName}\n          and m.perms is not null\n          and m.perms &lt;&gt; \'\'\n    </select>\n</mapper>\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("p",[s._v("定义好Dao层后，我们还需要在febs-auth模块的入口类上使用"),n("code",[s._v('@MapperScan("cc.mrbird.febs.auth.mapper")')]),s._v("注解标注：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@EnableDiscoveryClient\n@SpringBootApplication\n@FebsCloudApplication\n@EnableFebsAuthExceptionHandler\n@MapperScan("cc.mrbird.febs.auth.mapper")\npublic class FebsAuthApplication {\n    public static void main(String[] args) {\n        SpringApplication.run(FebsAuthApplication.class, args);\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("作用为将路径下的Mapper类都注册到IOC容器中。")]),s._v(" "),n("p",[s._v("接着在febs-auth模块的cc.mrbird.febs.auth路径下新建manager包，在该包下新建"),n("code",[s._v("UserManager")]),s._v("，用于统一定义和用户相关的业务方法：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Service\npublic class UserManager {\n\n    @Autowired\n    private UserMapper userMapper;\n    @Autowired\n    private MenuMapper menuMapper;\n\n    public SystemUser findByName(String username) {\n        return userMapper.findByName(username);\n    }\n\n     public String findUserPermissions(String username) {\n        List<Menu> userPermissions = menuMapper.findUserPermissions(username);\n\n        List<String> perms = new ArrayList<>();\n        for (Menu m: userPermissions){\n            perms.add(m.getPerms());\n        }\n        return StringUtils.join(perms, ",");\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("p",[s._v("其中"),n("code",[s._v("findUserPermissions")]),s._v("方法的代码可以通过Java 8的Stream简化：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Service\npublic class UserManager {\n\n    ......\n\n    public String findUserPermissions(String username) {\n        List<Menu> userPermissions = menuMapper.findUserPermissions(username);\n        return userPermissions.stream().map(Menu::getPerms).collect(Collectors.joining(","));\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("该方法返回的是用户权限集合以逗号拼接后的值，如"),n("code",[s._v("user:add,user:update,user:delete")]),s._v("。")]),s._v(" "),n("p",[s._v("在前面的章节中，我们曾经在febs-common模块里定义了一个"),n("code",[s._v("FebsAuthUser")]),s._v("，这个类也是用于存放用户数据，这里之所以分"),n("code",[s._v("SystemUser")]),s._v("和"),n("code",[s._v("FebsAuthUser")]),s._v("的用意主要有：")]),s._v(" "),n("ol",[n("li",[n("code",[s._v("SystemUser")]),s._v("对应数据表t_user数据，主要用于用户的CRUD等；")]),s._v(" "),n("li",[n("code",[s._v("FebsAuthUser")]),s._v("用于装载登录时，从t_user表里查询出来的数据。")])]),s._v(" "),n("p",[s._v("从前面的章节我们知道febs-auth模块下的"),n("code",[s._v("FebsUserDetailService")]),s._v("类的"),n("code",[s._v("loadUserByUsername")]),s._v("方法返回的类型为"),n("code",[s._v("UserDetails")]),s._v("，其为一个接口，Spring的"),n("code",[s._v("org.springframework.security.core.userdetails.User")]),s._v("实现了该接口，我们可以让"),n("code",[s._v("FebsAuthUser")]),s._v("继承"),n("code",[s._v("org.springframework.security.core.userdetails.User")]),s._v("，并添加一些字段，丰富用户信息（实际就是拓展了在线用户信息）。修改febs-common模块下的"),n("code",[s._v("FebsAuthUser")]),s._v("：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("package cc.mrbird.febs.common.entity;\n\nimport lombok.Data;\nimport lombok.EqualsAndHashCode;\nimport org.springframework.security.core.GrantedAuthority;\nimport org.springframework.security.core.userdetails.User;\n\nimport java.util.Collection;\nimport java.util.Date;\n\n@Data\n@EqualsAndHashCode(callSuper = true)\npublic class FebsAuthUser extends User {\n\n    private static final long serialVersionUID = -6411066541689297219L;\n\n    private Long userId;\n\n    private String avatar;\n\n    private String email;\n\n    private String mobile;\n\n    private String sex;\n\n    private Long deptId;\n\n    private String deptName;\n\n    private String roleId;\n\n    private String roleName;\n\n    private Date lastLoginTime;\n\n    private String description;\n\n    private String status;\n\n    public FebsAuthUser(String username, String password, Collection<? extends GrantedAuthority> authorities) {\n        super(username, password, authorities);\n    }\n\n    public FebsAuthUser(String username, String password, boolean enabled, boolean accountNonExpired, boolean credentialsNonExpired, boolean accountNonLocked, Collection<? extends GrantedAuthority> authorities) {\n        super(username, password, enabled, accountNonExpired, credentialsNonExpired, accountNonLocked, authorities);\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br")])]),n("p",[s._v("字段大致和"),n("code",[s._v("SystemUser")]),s._v("一致。")]),s._v(" "),n("p",[s._v("万事俱备后，我们最后来修改febs-auth模块下的"),n("code",[s._v("FebsUserDetailService")]),s._v("，因为之前的获取用户逻辑是我们模拟的，现在将它改造为通过查询数据库的方式获取：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Service\npublic class FebsUserDetailService implements UserDetailsService {\n\n    @Autowired\n    private PasswordEncoder passwordEncoder;\n    @Autowired\n    private UserManager userManager;\n\n    @Override\n    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {\n        SystemUser systemUser = userManager.findByName(username);\n        if (systemUser != null) {\n            String permissions = userManager.findUserPermissions(systemUser.getUsername());\n            boolean notLocked = false;\n            if (StringUtils.equals(SystemUser.STATUS_VALID, systemUser.getStatus()))\n                notLocked = true;\n            FebsAuthUser authUser = new FebsAuthUser(systemUser.getUsername(), systemUser.getPassword(), true, true, true, notLocked,\n                    AuthorityUtils.commaSeparatedStringToAuthorityList(permissions));\n\n            return transSystemUserToAuthUser(authUser,systemUser);\n        } else {\n            throw new UsernameNotFoundException("");\n        }\n    }\n\n    private FebsAuthUser transSystemUserToAuthUser(FebsAuthUser authUser, SystemUser systemUser) {\n        authUser.setAvatar(systemUser.getAvatar());\n        authUser.setDeptId(systemUser.getDeptId());\n        authUser.setDeptName(systemUser.getDeptName());\n        authUser.setEmail(systemUser.getEmail());\n        authUser.setMobile(systemUser.getMobile());\n        authUser.setRoleId(systemUser.getRoleId());\n        authUser.setRoleName(systemUser.getRoleName());\n        authUser.setSex(systemUser.getSex());\n        authUser.setUserId(systemUser.getUserId());\n        authUser.setLastLoginTime(systemUser.getLastLoginTime());\n        authUser.setDescription(systemUser.getDescription());\n        authUser.setStatus(systemUser.getStatus());\n        return authUser;\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br")])]),n("p",[s._v("上面主要的逻辑就是通过用户名从数据库中获取用户信息"),n("code",[s._v("SystemUser")]),s._v("和用户权限集合，然后通过"),n("code",[s._v("transSystemUserToAuthUser")]),s._v("方法将"),n("code",[s._v("SystemUser")]),s._v("里的值拷贝到"),n("code",[s._v("FebsAuthUser")]),s._v("中并返回。")]),s._v(" "),n("p",[s._v("两个实体类值的拷贝Spring给我们提供了相应的工具类，上面的代码可以简化为：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Service\npublic class FebsUserDetailService implements UserDetailsService {\n\n    @Autowired\n    private PasswordEncoder passwordEncoder;\n    @Autowired\n    private UserManager userManager;\n\n    @Override\n    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {\n        SystemUser systemUser = userManager.findByName(username);\n        if (systemUser != null) {\n            String permissions = userManager.findUserPermissions(systemUser.getUsername());\n            boolean notLocked = false;\n            if (StringUtils.equals(SystemUser.STATUS_VALID, systemUser.getStatus()))\n                notLocked = true;\n            FebsAuthUser authUser = new FebsAuthUser(systemUser.getUsername(), systemUser.getPassword(), true, true, true, notLocked,\n                    AuthorityUtils.commaSeparatedStringToAuthorityList(permissions));\n\n            BeanUtils.copyProperties(systemUser,authUser);\n            return authUser;\n        } else {\n            throw new UsernameNotFoundException("");\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br")])]),n("h2",{attrs:{id:"postman测试登录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#postman测试登录"}},[s._v("#")]),s._v(" PostMan测试登录")]),s._v(" "),n("p",[s._v("到这里，登录流程已经改造完毕，逐步启动febs-register、febs-gateway和febs-auth三个模块，然后使用PostMan获取令牌，看看是否正常：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/13/mCI4RP.png",alt:"84.png"}})])])}),[],!1,null,null,null);n.default=r.exports}}]);