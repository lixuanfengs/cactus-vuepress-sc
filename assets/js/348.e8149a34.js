(window.webpackJsonp=window.webpackJsonp||[]).push([[348],{697:function(e,s,n){"use strict";n.r(s);var t=n(0),a=Object(t.a)({},(function(){var e=this,s=e._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("p",[e._v("虽然上一节我们已经成功接入了Swagger，但是因为我们的资源都是受资源服务器保护的，所以Swagger并不能进行正常的接口测试。")]),e._v(" "),s("p",[e._v("比如我们用Swagger发送一笔用户查询请求，会看到请求返回401状态码：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/08/16/mZ9lzn.gif",alt:"106"}})]),e._v(" "),s("p",[e._v("要解决这个问题，我们只需要在Swagger里接入OAuth2认证即可。")]),e._v(" "),s("p",[e._v("我们在febs-auth模块里配置一个新的Client，专门用于Swagger令牌发放。在febs-auth模块的"),s("code",[e._v("febs-auth.properties")]),e._v("配置文件里添加如下配置:")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("febs.auth.clients[1].client=swagger\nfebs.auth.clients[1].secret=123456\nfebs.auth.clients[1].grantType=password\nfebs.auth.clients[1].scope=test\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])]),s("p",[e._v("此外，因为我们之前在认证流程里接入了图形验证码校验，而Swagger获取测试令牌时并不需要进行图形验证码校验，所以我们可以在图形验证码校验过滤器里添加如下逻辑：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Slf4j\n@Component\npublic class ValidateCodeFilter extends OncePerRequestFilter {\n\n    @Autowired\n    private ValidateCodeService validateCodeService;\n\n    @Override\n    protected void doFilterInternal(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, FilterChain filterChain) throws ServletException, IOException {\n        String header = httpServletRequest.getHeader("Authorization");\n        String clientId = getClientId(header, httpServletRequest);\n\n        RequestMatcher matcher = new AntPathRequestMatcher("/oauth/token", HttpMethod.POST.toString());\n        if (matcher.matches(httpServletRequest)\n                && StringUtils.equalsIgnoreCase(httpServletRequest.getParameter("grant_type"), "password")\n                && !StringUtils.equalsAnyIgnoreCase(clientId, "swagger")) {\n            try {\n                validateCode(httpServletRequest);\n                filterChain.doFilter(httpServletRequest, httpServletResponse);\n            } catch (ValidateCodeException e) {\n                FebsResponse febsResponse = new FebsResponse();\n                FebsUtil.makeResponse(httpServletResponse, MediaType.APPLICATION_JSON_UTF8_VALUE,\n                        HttpServletResponse.SC_INTERNAL_SERVER_ERROR, febsResponse.message(e.getMessage()));\n                log.error(e.getMessage(), e);\n            }\n        } else {\n            filterChain.doFilter(httpServletRequest, httpServletResponse);\n        }\n    }\n\n    private void validateCode(HttpServletRequest httpServletRequest) throws ValidateCodeException {\n        String code = httpServletRequest.getParameter("code");\n        String key = httpServletRequest.getParameter("key");\n        validateCodeService.check(key, code);\n    }\n\n    private String getClientId(String header, HttpServletRequest request) {\n        String clientId = "";\n        try {\n            byte[] base64Token = header.substring(6).getBytes(StandardCharsets.UTF_8);\n            byte[] decoded;\n            decoded = Base64.getDecoder().decode(base64Token);\n\n            String token = new String(decoded, StandardCharsets.UTF_8);\n            int delim = token.indexOf(":");\n            if (delim != -1) {\n                clientId = new String[]{token.substring(0, delim), token.substring(delim + 1)}[0];\n            }\n        } catch (Exception ignore) {\n        }\n        return clientId;\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br"),s("span",{staticClass:"line-number"},[e._v("24")]),s("br"),s("span",{staticClass:"line-number"},[e._v("25")]),s("br"),s("span",{staticClass:"line-number"},[e._v("26")]),s("br"),s("span",{staticClass:"line-number"},[e._v("27")]),s("br"),s("span",{staticClass:"line-number"},[e._v("28")]),s("br"),s("span",{staticClass:"line-number"},[e._v("29")]),s("br"),s("span",{staticClass:"line-number"},[e._v("30")]),s("br"),s("span",{staticClass:"line-number"},[e._v("31")]),s("br"),s("span",{staticClass:"line-number"},[e._v("32")]),s("br"),s("span",{staticClass:"line-number"},[e._v("33")]),s("br"),s("span",{staticClass:"line-number"},[e._v("34")]),s("br"),s("span",{staticClass:"line-number"},[e._v("35")]),s("br"),s("span",{staticClass:"line-number"},[e._v("36")]),s("br"),s("span",{staticClass:"line-number"},[e._v("37")]),s("br"),s("span",{staticClass:"line-number"},[e._v("38")]),s("br"),s("span",{staticClass:"line-number"},[e._v("39")]),s("br"),s("span",{staticClass:"line-number"},[e._v("40")]),s("br"),s("span",{staticClass:"line-number"},[e._v("41")]),s("br"),s("span",{staticClass:"line-number"},[e._v("42")]),s("br"),s("span",{staticClass:"line-number"},[e._v("43")]),s("br"),s("span",{staticClass:"line-number"},[e._v("44")]),s("br"),s("span",{staticClass:"line-number"},[e._v("45")]),s("br"),s("span",{staticClass:"line-number"},[e._v("46")]),s("br"),s("span",{staticClass:"line-number"},[e._v("47")]),s("br"),s("span",{staticClass:"line-number"},[e._v("48")]),s("br"),s("span",{staticClass:"line-number"},[e._v("49")]),s("br"),s("span",{staticClass:"line-number"},[e._v("50")]),s("br"),s("span",{staticClass:"line-number"},[e._v("51")]),s("br"),s("span",{staticClass:"line-number"},[e._v("52")]),s("br"),s("span",{staticClass:"line-number"},[e._v("53")]),s("br")])]),s("p",[s("code",[e._v("getClientId")]),e._v("这个方法用于从请求头部获取ClientId信息，这段代码是从Spring Cloud OAuth2源码中拷贝过来的，所以看不懂没关系，只要知道它的作用就行了。")]),e._v(" "),s("p",[e._v("获取了ClientId后，我们判断ClientId是否为"),s("code",[e._v("swagger")]),e._v("，是的话无需进行图形验证码校验。")]),e._v(" "),s("p",[e._v("febs-auth模块改造完毕后，我们开始往Swagger里接入OAuth2认证。")]),e._v(" "),s("p",[e._v("Swagger的"),s("code",[e._v("Docket")]),e._v("对象可以配置"),s("code",[e._v("securitySchemes")]),e._v("和"),s("code",[e._v("securityContexts")]),e._v("：")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("securitySchemes")]),e._v("：用于配置安全策略，比如配置认证模型，scope等内容；")]),e._v(" "),s("li",[s("code",[e._v("securityContexts")]),e._v("：用于配置安全上下文，只有配置了安全上下文的接口才能使用令牌获取资源。")])]),e._v(" "),s("p",[e._v("改造febs-server-system模块，在"),s("code",[e._v("FebsWebConfigure")]),e._v("配置类里添加Swagger OAuth2认证相关代码：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Configuration\n@EnableSwagger2\npublic class FebsWebConfigure {\n\n    @Autowired\n    private FebsServerSystemProperties properties;\n\n    ......\n\n    @Bean\n    public Docket swaggerApi() {\n        FebsSwaggerProperties swagger = properties.getSwagger();\n        return new Docket(DocumentationType.SWAGGER_2)\n                .select()\n                .apis(RequestHandlerSelectors.basePackage(swagger.getBasePackage()))\n                .paths(PathSelectors.any())\n                .build()\n                .apiInfo(apiInfo(swagger))\n                .securitySchemes(Collections.singletonList(securityScheme(swagger)))\n                .securityContexts(Collections.singletonList(securityContext(swagger)));\n    }\n\n    private ApiInfo apiInfo(FebsSwaggerProperties  swagger) {\n        return new ApiInfo(\n                swagger.getTitle(),\n                swagger.getDescription(),\n                swagger.getVersion(),\n                null,\n                new Contact(swagger.getAuthor(), swagger.getUrl(), swagger.getEmail()),\n                swagger.getLicense(), swagger.getLicenseUrl(), Collections.emptyList());\n    }\n\n    private SecurityScheme securityScheme(FebsSwaggerProperties swagger) {\n        GrantType grantType = new ResourceOwnerPasswordCredentialsGrant("http://localhost:8301/auth/oauth/token");\n\n        return new OAuthBuilder()\n                .name("febs_oauth_swagger")\n                .grantTypes(Collections.singletonList(grantType))\n                .scopes(Arrays.asList(scopes(swagger)))\n                .build();\n    }\n\n    private SecurityContext securityContext(FebsSwaggerProperties swagger) {\n        return SecurityContext.builder()\n                .securityReferences(Collections.singletonList(new SecurityReference("febs_oauth_swagger", scopes(swagger))))\n                .forPaths(PathSelectors.any())\n                .build();\n    }\n\n    private AuthorizationScope[] scopes(FebsSwaggerProperties swagger) {\n        return new AuthorizationScope[]{\n                new AuthorizationScope("test", "")\n        };\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br"),s("span",{staticClass:"line-number"},[e._v("24")]),s("br"),s("span",{staticClass:"line-number"},[e._v("25")]),s("br"),s("span",{staticClass:"line-number"},[e._v("26")]),s("br"),s("span",{staticClass:"line-number"},[e._v("27")]),s("br"),s("span",{staticClass:"line-number"},[e._v("28")]),s("br"),s("span",{staticClass:"line-number"},[e._v("29")]),s("br"),s("span",{staticClass:"line-number"},[e._v("30")]),s("br"),s("span",{staticClass:"line-number"},[e._v("31")]),s("br"),s("span",{staticClass:"line-number"},[e._v("32")]),s("br"),s("span",{staticClass:"line-number"},[e._v("33")]),s("br"),s("span",{staticClass:"line-number"},[e._v("34")]),s("br"),s("span",{staticClass:"line-number"},[e._v("35")]),s("br"),s("span",{staticClass:"line-number"},[e._v("36")]),s("br"),s("span",{staticClass:"line-number"},[e._v("37")]),s("br"),s("span",{staticClass:"line-number"},[e._v("38")]),s("br"),s("span",{staticClass:"line-number"},[e._v("39")]),s("br"),s("span",{staticClass:"line-number"},[e._v("40")]),s("br"),s("span",{staticClass:"line-number"},[e._v("41")]),s("br"),s("span",{staticClass:"line-number"},[e._v("42")]),s("br"),s("span",{staticClass:"line-number"},[e._v("43")]),s("br"),s("span",{staticClass:"line-number"},[e._v("44")]),s("br"),s("span",{staticClass:"line-number"},[e._v("45")]),s("br"),s("span",{staticClass:"line-number"},[e._v("46")]),s("br"),s("span",{staticClass:"line-number"},[e._v("47")]),s("br"),s("span",{staticClass:"line-number"},[e._v("48")]),s("br"),s("span",{staticClass:"line-number"},[e._v("49")]),s("br"),s("span",{staticClass:"line-number"},[e._v("50")]),s("br"),s("span",{staticClass:"line-number"},[e._v("51")]),s("br"),s("span",{staticClass:"line-number"},[e._v("52")]),s("br"),s("span",{staticClass:"line-number"},[e._v("53")]),s("br"),s("span",{staticClass:"line-number"},[e._v("54")]),s("br"),s("span",{staticClass:"line-number"},[e._v("55")]),s("br")])]),s("p",[e._v("上面代码中，我们通过"),s("code",[e._v("Docket")]),e._v("的"),s("code",[e._v("securitySchemes")]),e._v("和"),s("code",[e._v("securityContexts")]),e._v("方法设置了安全策略和安全上下文。")]),e._v(" "),s("p",[e._v("在"),s("code",[e._v("securityScheme")]),e._v("方法中，我们通过"),s("code",[e._v("OAuthBuilder")]),e._v("对象构建了安全策略，主要配置了认证类型为"),s("code",[e._v("ResourceOwnerPasswordCredentialsGrant")]),e._v("（即密码模式），认证地址为"),s("code",[e._v("http://localhost:8301/auth/oauth/token")]),e._v("（即通过网关转发到认证服务器），scope为test，和febs-auth模块里定义的一致。这个安全策略我们将其命名为"),s("code",[e._v("febs_oauth_swagger")]),e._v("。")]),e._v(" "),s("p",[e._v("在"),s("code",[e._v("securityContext")]),e._v("方法中，我们通过"),s("code",[e._v("febs_oauth_swagger")]),e._v("名称关联了上面定义的安全策略，并且通过"),s("code",[e._v("forPaths(PathSelectors.any())")]),e._v("设置所有API接口都用这个安全上下文。")])])}),[],!1,null,null,null);s.default=a.exports}}]);