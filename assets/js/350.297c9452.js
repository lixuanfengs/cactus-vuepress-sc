(window.webpackJsonp=window.webpackJsonp||[]).push([[350],{699:function(s,e,a){"use strict";a.r(e);var n=a(0),t=Object(n.a)({},(function(){var s=this,e=s._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("一个复杂的业务流程通常会被拆分多个微服务系统来完成，微服务间通过Feign来通信。当业务流程足够复杂时，一个完整的HTTP请求调用链一般会经过多个微服务系统，要通过日志来跟踪一整个调用链变得不再那么简单。我们可以通过Spring Cloud Sleuth来解决这个问题。")]),s._v(" "),e("p",[s._v("在前面的章节中，我们已经实现了通过Spring Cloud Feign来远程访问受保护的资源，这一节我们将演示如何通过Spring Cloud Sleuth来追踪这个过程，并借助Zipkin以图形化界面的方式展示。")]),s._v(" "),e("h2",{attrs:{id:"整合spring-cloud-sleuth"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#整合spring-cloud-sleuth"}},[s._v("#")]),s._v(" 整合Spring Cloud Sleuth")]),s._v(" "),e("p",[s._v("在febs-server模块的pom里引入sleuth依赖：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-sleuth</artifactId>\n</dependency>\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("然后在febs-server-test模块的"),e("code",[s._v("TestController")]),s._v("的"),e("code",[s._v("hello")]),s._v("方法里打印一条日志信息：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@Slf4j\n@RestController\npublic class TestController {\n\n    @Autowired\n    private IHelloService helloService;\n\n    @GetMapping("hello")\n    public String hello(String name) {\n        log.info("Feign调用febs-server-system的/hello服务");\n        return this.helloService.hello(name);\n    }\n    ......\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br")])]),e("p",[s._v("在febs-server-system模块的"),e("code",[s._v("TestController")]),s._v("的"),e("code",[s._v("hello")]),s._v("方法里也打印一条日志信息：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@Slf4j\n@RestController\npublic class TestController {\n\n    ......\n    @GetMapping("hello")\n    public String hello(String name) {\n        log.info("/hello服务被调用");\n        return "hello" + name;\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("p",[s._v("重启febs-server-system和febs-server-test模块，使用PostMan获取令牌后，访问 "),e("a",{attrs:{href:"localhost:8301/test/hello?name=%E5%A4%8F%E5%A4%A9"}},[s._v("localhost:8301/test/hello?name=夏天")]),s._v("：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/23/mDE4uq.png",alt:"130.png"}})]),s._v(" "),e("p",[s._v("这时候，观察febs-server-test打印的日志：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("2019-08-23 14:22:51.774  INFO [FEBS-Server-Test,72bb0469bee07104,72bb0469bee07104,false] 22728 --- [nio-8202-exec-1] c.m.f.s.test.controller.TestController   : Feign调用febs-server-system的/hello服务\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("febs-server-system模块也输出了一条日志：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("2019-08-23 14:22:52.469  INFO [FEBS-Server-System,72bb0469bee07104,43597a6edded6f2e,false] 812 --- [nio-8201-exec-2] c.m.f.s.s.controller.TestController      : /hello服务被调用\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("可以看到，日志里出现了"),e("code",[s._v("[FEBS-Server-Test,72bb0469bee07104,72bb0469bee07104,false]")]),s._v("信息，这些信息由Spring Cloud Sleuth生成，用于跟踪微服务请求链路。这些信息包含了4个部分的值，它们的含义如下：")]),s._v(" "),e("ol",[e("li",[e("code",[s._v("FEBS-Server-System")]),s._v("微服务的名称，与"),e("code",[s._v("spring.application.name")]),s._v("对应；")]),s._v(" "),e("li",[e("code",[s._v("72bb0469bee07104")]),s._v("称为Trace ID，在一条完整的请求链路中，这个值是固定的。观察上面的日志即可证实这一点；")]),s._v(" "),e("li",[e("code",[s._v("43597a6edded6f2e")]),s._v("称为Span ID，它表示一个基本的工作单元；")]),s._v(" "),e("li",[e("code",[s._v("false")]),s._v("表示是否要将该信息输出到Zipkin等服务中来收集和展示，这里我们还没有集成Zipkin，所以为false。")])]),s._v(" "),e("p",[s._v("现在我们要跟踪整条请求链路，就可以通过traceId来完成。但是，从海量日志里捞取traceId并追踪也不是一件轻松的事情，下面我们可以借助zipkin实现使用图形化界面的方式追踪请求链路。")]),s._v(" "),e("h2",{attrs:{id:"整合zipkin"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#整合zipkin"}},[s._v("#")]),s._v(" 整合Zipkin")]),s._v(" "),e("p",[s._v("在整合Zipkin之前，我们需要先搭建RabbitMQ。RabbitMQ用于收集Sleuth提供的追踪信息，然后Zipkin Server从RabbitMQ里获取，这样可以提升性能。")]),s._v(" "),e("p",[s._v("在安装RabbitMQ之前，需要先安装Erlang/OTP，下载地址为：http://www.erlang.org/downloads/，下载exe文件安装即可。")]),s._v(" "),e("p",[s._v("安装完毕后，下载RabbitMQ，下载地址为 http://www.rabbitmq.com/install-windows.html，下载exe文件安装即可。")]),s._v(" "),e("p",[s._v("安装完RabbitMQ之后，我们到RabbitMQ安装目录的sbin下执行如下命令：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("rabbitmq-plugins enable rabbitmq_management\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("然后在浏览器中输入"),e("a",{attrs:{href:"http://localhost:15672/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://localhost:15672"),e("OutboundLink")],1),s._v("，用户名和密码都是guest，登录后可看到：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/23/mDuW2F.png",alt:"131.png"}})]),s._v(" "),e("p",[s._v("点击Admin Tab页面，新增一个用户：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/23/mDKFG8.png",alt:"132.png"}})]),s._v(" "),e("p",[s._v("用户名为febs，密码为123456，角色为管理员。新添加的用户还是No access状态，需要进一步对该用户进行授权后，方可以远程通过该用户名访问。点击该新增用户名。进入授权页面，点击Set permission按钮，进行用户授权操作。")]),s._v(" "),e("p",[s._v("安装好RabbitMQ后，我们开始整合Zipkin。在较低版本的Spring Cloud中，我们可以自己搭建Zipkin Server，现在我们只能使用官方搭建好的Zipkin Server，地址为：https://github.com/openzipkin/zipkin")]),s._v(" "),e("p",[s._v("在cmd窗口下运行下面这条命令（windows下没有curl环境的话，可以在git bash中运行这条命令），下载zipkin.jar：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("curl -sSL https://zipkin.io/quickstart.sh | bash -s\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/23/mDQxr4.png",alt:"133.png"}})]),s._v(" "),e("p",[s._v("由于网络问题，下载速度极慢，可以复制图中的链接到迅雷下载中下载，下载后重命名为zipkin.jar即可。")]),s._v(" "),e("p",[s._v("zipkin支持将追踪信息保存到MySQL数据库，所以在运行zipkin.jar之前，我们先准备好相关库表，SQL脚本地址为：https://github.com/openzipkin/zipkin/blob/master/zipkin-storage/mysql-v1/src/main/resources/mysql.sql。")]),s._v(" "),e("p",[s._v("运行这些SQL后，数据库创建了三张新的表：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/23/mD1EYq.png",alt:"134.png"}})]),s._v(" "),e("p",[s._v("库表准备好后，运行下面这条命令启动zipkin.jar：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("java -jar zipkin.jar --server.port=8402 --zipkin.storage.type=mysql --zipkin.storage.mysql.db=febs_cloud_base --zipkin.storage.mysql.username=root --zipkin.storage.mysql.password=123456 --zipkin.storage.mysql.host=localhost --zipkin.storage.mysql.port=3306 --zipkin.collector.rabbitmq.addresses=localhost:5672 --zipkin.collector.rabbitmq.username=febs --zipkin.collector.rabbitmq.password=123456\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("上面命令指定了数据库链接和RabbitMQ链接信息。更多可选配置可以解压zipkin.jar，查看"),e("code",[s._v("zipkin\\BOOT-INF\\classes")]),s._v("路径下的"),e("code",[s._v("zipkin-server-shared.yml")]),s._v("配置类源码。")]),s._v(" "),e("p",[s._v("启动好zipkin.jar后，在febs-server模块的pom里引入如下依赖：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-zipkin</artifactId>\n</dependency>\n<dependency>\n    <groupId>org.springframework.amqp</groupId>\n    <artifactId>spring-rabbit</artifactId>\n</dependency>\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("然后在febs-server-system和febs-server-test模块的配置文件application.yml里添加如下配置:")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("spring:\n  zipkin:\n    sender:\n      type: rabbit\n  sleuth:\n    sampler:\n      probability: 1\n  rabbitmq:\n    host: localhost\n    port: 5672\n    username: febs\n    password: 123456\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("ul",[e("li",[e("code",[s._v("spring.zipkin.sender.type")]),s._v("指定了使用RabbitMQ收集追踪信息；")]),s._v(" "),e("li",[e("code",[s._v("spring.sleuth.sampler.probability")]),s._v("默认值为0.1，即采样率才1/10，发送10笔请求只有一笔会被采集。为了测试方便，我们可以将它设置为1，即100%采样；")]),s._v(" "),e("li",[e("code",[s._v("spring.rabbitmq")]),s._v("用于配置RabbitMQ连接信息，你可能会问，为什么刚刚RabbitMQ端口是15672，这里却配置为5672，是不是写错了呢？其实不是，15672是RabbitMQ的管理页面端口，5672是AMPQ端口。")])]),s._v(" "),e("p",[s._v("添加好配置后，重启febs-server-system和febs-server-test模块，发送一笔"),e("a",{attrs:{href:"localhost:8301/test/hello?name=%E5%A4%8F%E5%A4%A9"}},[s._v("localhost:8301/test/hello?name=夏天")]),s._v("请求后，使用浏览器访问http://localhost:8402/zipkin/链接（个人习惯使用Lens UI）：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/23/mDwFJg.png",alt:"135.png"}})]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/08/23/mDywkt.png",alt:"136.png"}})])])}),[],!1,null,null,null);e.default=t.exports}}]);