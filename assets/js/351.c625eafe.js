(window.webpackJsonp=window.webpackJsonp||[]).push([[351],{698:function(e,n,a){"use strict";a.r(n);var s=a(0),r=Object(s.a)({},(function(){var e=this,n=e._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("p",[e._v("目前系统日志输出在控制台中，重启项目后，之前的日志就丢失了，我们可以借助logback将系统日志保存到日志文件中。Spring Boot项目在引用了"),n("code",[e._v("spring-boot-starter-logging")]),e._v("依赖后，默认使用logback来记录日志。因为我们之前搭建的微服务系统都引用了"),n("code",[e._v("spring-boot-starter-web")]),e._v("依赖，该依赖包含了"),n("code",[e._v("spring-boot-starter-logging")]),e._v("，所以无需再次引入：")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/24/mylnNd.png",alt:"140.png"}})]),e._v(" "),n("p",[e._v("在各个微服务子系统里添加logback配置文件步骤都是一样的，所以这里以febs-server-system模块为例。在febs-server-system模块的resources下新建logback配置文件"),n("code",[e._v("logback-spring.xml")]),e._v("：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('<?xml version="1.0" encoding="UTF-8"?>\n<configuration scan="true" scanPeriod="60 seconds" debug="false">\n    <contextName>febs</contextName>\n    <springProperty scope="context" name="springAppName" source="spring.application.name"/>\n    <property name="log.path" value="log/febs-server-system" />\n    <property name="log.maxHistory" value="15" />\n    <property name="log.colorPattern" value="%magenta(%d{yyyy-MM-dd HH:mm:ss}) %highlight(%-5level) %boldCyan([${springAppName:-},%X{X-B3-TraceId:-},%X{X-B3-SpanId:-},%X{X-Span-Export:-}]) %yellow(%thread) %green(%logger) %msg%n"/>\n    <property name="log.pattern" value="%d{yyyy-MM-dd HH:mm:ss} %-5level [${springAppName:-},%X{X-B3-TraceId:-},%X{X-B3-SpanId:-},%X{X-Span-Export:-}] %thread %logger %msg%n"/>\n\n    \x3c!--输出到控制台--\x3e\n    <appender name="console" class="ch.qos.logback.core.ConsoleAppender">\n        <encoder>\n            <pattern>${log.colorPattern}</pattern>\n        </encoder>\n    </appender>\n\n    \x3c!--输出到文件--\x3e\n    <appender name="file_info" class="ch.qos.logback.core.rolling.RollingFileAppender">\n        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">\n            <fileNamePattern>${log.path}/info/info.%d{yyyy-MM-dd}.log</fileNamePattern>\n            <MaxHistory>${log.maxHistory}</MaxHistory>\n        </rollingPolicy>\n        <encoder>\n            <pattern>${log.pattern}</pattern>\n        </encoder>\n        <filter class="ch.qos.logback.classic.filter.LevelFilter">\n            <level>INFO</level>\n            <onMatch>ACCEPT</onMatch>\n            <onMismatch>DENY</onMismatch>\n        </filter>\n    </appender>\n\n    <appender name="file_error" class="ch.qos.logback.core.rolling.RollingFileAppender">\n        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">\n            <fileNamePattern>${log.path}/error/error.%d{yyyy-MM-dd}.log</fileNamePattern>\n        </rollingPolicy>\n        <encoder>\n            <pattern>${log.pattern}</pattern>\n        </encoder>\n        <filter class="ch.qos.logback.classic.filter.LevelFilter">\n            <level>ERROR</level>\n            <onMatch>ACCEPT</onMatch>\n            <onMismatch>DENY</onMismatch>\n        </filter>\n    </appender>\n\n    <root level="debug">\n        <appender-ref ref="console" />\n    </root>\n\n    <root level="info">\n        <appender-ref ref="file_info" />\n        <appender-ref ref="file_error" />\n    </root>\n</configuration>\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br"),n("span",{staticClass:"line-number"},[e._v("25")]),n("br"),n("span",{staticClass:"line-number"},[e._v("26")]),n("br"),n("span",{staticClass:"line-number"},[e._v("27")]),n("br"),n("span",{staticClass:"line-number"},[e._v("28")]),n("br"),n("span",{staticClass:"line-number"},[e._v("29")]),n("br"),n("span",{staticClass:"line-number"},[e._v("30")]),n("br"),n("span",{staticClass:"line-number"},[e._v("31")]),n("br"),n("span",{staticClass:"line-number"},[e._v("32")]),n("br"),n("span",{staticClass:"line-number"},[e._v("33")]),n("br"),n("span",{staticClass:"line-number"},[e._v("34")]),n("br"),n("span",{staticClass:"line-number"},[e._v("35")]),n("br"),n("span",{staticClass:"line-number"},[e._v("36")]),n("br"),n("span",{staticClass:"line-number"},[e._v("37")]),n("br"),n("span",{staticClass:"line-number"},[e._v("38")]),n("br"),n("span",{staticClass:"line-number"},[e._v("39")]),n("br"),n("span",{staticClass:"line-number"},[e._v("40")]),n("br"),n("span",{staticClass:"line-number"},[e._v("41")]),n("br"),n("span",{staticClass:"line-number"},[e._v("42")]),n("br"),n("span",{staticClass:"line-number"},[e._v("43")]),n("br"),n("span",{staticClass:"line-number"},[e._v("44")]),n("br"),n("span",{staticClass:"line-number"},[e._v("45")]),n("br"),n("span",{staticClass:"line-number"},[e._v("46")]),n("br"),n("span",{staticClass:"line-number"},[e._v("47")]),n("br"),n("span",{staticClass:"line-number"},[e._v("48")]),n("br"),n("span",{staticClass:"line-number"},[e._v("49")]),n("br"),n("span",{staticClass:"line-number"},[e._v("50")]),n("br"),n("span",{staticClass:"line-number"},[e._v("51")]),n("br"),n("span",{staticClass:"line-number"},[e._v("52")]),n("br"),n("span",{staticClass:"line-number"},[e._v("53")]),n("br"),n("span",{staticClass:"line-number"},[e._v("54")]),n("br"),n("span",{staticClass:"line-number"},[e._v("55")]),n("br")])]),n("p",[e._v("logback配置文件大致结构如下所示：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("<configuration>\n   <property/>\n   <appender/>\n   <root/>\n</configuration>\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br")])]),n("p",[e._v("下面详细介绍下这些标签的作用，介绍完后，再回来看这个配置文件，你应该就能看懂它的含义了。")]),e._v(" "),n("h3",{attrs:{id:"configuration"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#configuration"}},[e._v("#")]),e._v(" "),n("code",[e._v("<configuration>")])]),e._v(" "),n("p",[n("code",[e._v("<configuration>")]),e._v("为logback配置文件的根标签，该标签包含三个属性：")]),e._v(" "),n("ol",[n("li",[n("code",[e._v("scan")]),e._v("：当此属性设置为true时，配置文件如果发生改变，将会被重新加载，默认值为true。")]),e._v(" "),n("li",[n("code",[e._v("scanPeriod")]),e._v("：设置监测配置文件是否有修改的时间间隔，如果没有给出时间单位，默认单位是毫秒。当scan为true时，此属性生效。默认的时间间隔为1分钟。")]),e._v(" "),n("li",[n("code",[e._v("debug")]),e._v("：当此属性设置为true时，将打印出logback内部日志信息，实时查看logback运行状态。默认值为false。")])]),e._v(" "),n("h3",{attrs:{id:"property"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#property"}},[e._v("#")]),e._v(" "),n("code",[e._v("<property>")])]),e._v(" "),n("p",[e._v("用来定义变量值的标签，有两个属性，name和value；其中name的值是变量的名称，value的值时变量定义的值。通过定义的值会被插入到logger上下文中。定义变量后，可以使"),n("code",[e._v("${}")]),e._v("来使用变量。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('<springProperty scope="context" name="springAppName" source="spring.application.name"/>\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("p",[e._v("这段配置用于引用Spring上下文的变量。通过这段配置，我们可以在logback配置文件中使用"),n("code",[e._v("${springAppName}")]),e._v("来引用配置文件application.yml里的"),n("code",[e._v("spring.application.name")]),e._v("配置值，在febs-server-system模块中，该值为"),n("code",[e._v("FEBS-Server-System")]),e._v("。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('<property name="log.path" value="log/febs-server-system" />\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("p",[e._v("上面这段配置定义了"),n("code",[e._v("log.path")]),e._v("变量，用于指定日志文件存储路径。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('<property name="log.maxHistory" value="15" />\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("p",[e._v("上面这段配置定义了"),n("code",[e._v("log.maxHistory")]),e._v("变量，用于指定日志文件存储的天数，这里指定为15天。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v(' <property name="log.colorPattern" value="%magenta(%d{yyyy-MM-dd HH:mm:ss}) %highlight(%-5level) %boldCyan([${springAppName:-},%X{X-B3-TraceId:-},%X{X-B3-SpanId:-},%X{X-Span-Export:-}]) %yellow(%thread) %green(%logger) %msg%n"/>\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("p",[e._v("这段配置定义了彩色日志打印的格式。在logback配置文件中，我们可以使用"),n("code",[e._v("%magenta()")]),e._v("、"),n("code",[e._v("%boldCyan()")]),e._v("等标识指定日志的颜色；"),n("code",[e._v("%d{yyyy-MM-dd HH:mm:ss}")]),e._v("用于格式化日志打印时间；"),n("code",[e._v("%highlight(%-5level)")]),e._v("配置了不同日志级别使用不同的颜色高亮显示；"),n("code",[e._v("%X{X-B3-TraceId:-},%X{X-B3-SpanId:-},%X{X-Span-Export:-}")]),e._v("用于打印Spring Cloud Sleuth提供的"),n("code",[e._v("TraceId")]),e._v("和"),n("code",[e._v("SpanId")]),e._v("等信息，如果不配置这些信息，我们在上一章搭建的Zipkin Server就无法追踪我们的请求链了。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v(' <property name="log.pattern" value="%d{yyyy-MM-dd HH:mm:ss} %-5level [${springAppName:-},%X{X-B3-TraceId:-},%X{X-B3-SpanId:-},%X{X-Span-Export:-}] %thread %logger %msg%n"/>\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("p",[e._v("这段配置定义了普通日志打印格式，大体上和上面彩色日志配置差不多，却别就是去掉了颜色配置。")]),e._v(" "),n("p",[e._v("如果微服务项目没有使用Spring Cloud Sleuth进行请求追踪，那么"),n("code",[e._v("TraceId")]),e._v("和"),n("code",[e._v("SpanId")]),e._v("打印出来都是空的，可以用下面这段配置来替代：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('<property name="log.colorPattern" value="%magenta(%d{yyyy-MM-dd HH:mm:ss}) %highlight(%-5level) %yellow(%thread) %green(%logger) %msg%n"/>\n<property name="log.pattern" value="%d{yyyy-MM-dd HH:mm:ss} %-5level %thread %logger %msg%n"/>\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br")])]),n("h3",{attrs:{id:"appender"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#appender"}},[e._v("#")]),e._v(" "),n("code",[e._v("<appender>")])]),e._v(" "),n("p",[e._v("appender用来格式化日志输出节点，有俩个属性name和class，class用来指定哪种输出策略，常用就是控制台输出策略和文件输出策略。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('<appender name="console" class="ch.qos.logback.core.ConsoleAppender">\n    <encoder>\n        <pattern>${log.colorPattern}</pattern>\n    </encoder>\n</appender>\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br")])]),n("p",[e._v("上面这段配置用于指定日志输出到控制台，日志打印格式采用上面定义的彩色日志打印（IDEA控制台支持彩色日志输出），这样在开发的时候，控制台输出的日志会更为美观，易于分析问题。")])])}),[],!1,null,null,null);n.default=r.exports}}]);