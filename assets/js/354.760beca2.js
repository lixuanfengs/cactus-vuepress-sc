(window.webpackJsonp=window.webpackJsonp||[]).push([[354],{703:function(n,s,e){"use strict";e.r(s);var a=e(0),t=Object(a.a)({},(function(){var n=this,s=n._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[s("p",[n._v('在FEBS Cloud Web里，页面的跳转是由Vue Router（路由）来完成的，Vue路由用于配置URL和Vue组件的对应关系。"导航"的意思是路由将要发生改变，“守卫”的意思是对路由的跳转做一些保护的措施。')]),n._v(" "),s("p",[n._v("一个管理系统的前端一般包含登录页和主页两大部分内容，主页里又包含众多和业务逻辑相关的子页面。我们一般希望只有用户登录后才可以访问主页，否则引导用户到登录页面进行登录授权。这部分功能我们可以借助"),s("a",{attrs:{href:"https://router.vuejs.org/zh/guide/advanced/navigation-guards.html",target:"_blank",rel:"noopener noreferrer"}},[n._v("Vue的导航守卫"),s("OutboundLink")],1),n._v("来完成。")]),n._v(" "),s("h2",{attrs:{id:"全局前置守卫"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#全局前置守卫"}},[n._v("#")]),n._v(" 全局前置守卫")]),n._v(" "),s("p",[n._v("前置守卫就是在路由跳转前定义我们的操作逻辑。在FEBS Cloud Web项目的src/router/index.js里，我们通过如下代码配置了前置守卫：")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("......\n\nconst constRouter = [\n  {\n    path: '/redirect',\n    component: Layout,\n    hidden: true,\n    children: [\n      {\n        path: '/redirect/:path*',\n        component: () => import('@/views/redirect/index')\n      }\n    ]\n  },\n  {\n    path: '/404',\n    component: () => import('@/views/error-page/404'),\n    hidden: true\n  },\n  {\n    path: '/login',\n    name: '登录页',\n    component: () => import('@/views/login/index')\n  },\n  {\n    path: '/',\n    component: Layout,\n    redirect: '/dashboard',\n    children: [\n      {\n        path: 'dashboard',\n        component: () => import('@/views/dashboard/index'),\n        name: 'Dashboard',\n        meta: { title: 'dashboard', icon: 'dashboard', affix: true }\n      }\n    ]\n  },\n  {\n    path: '/profile',\n    component: Layout,\n    redirect: '/profile/index',\n    hidden: true,\n    children: [\n      {\n        path: 'index',\n        component: () => import('@/views/profile/index'),\n        name: 'Profile',\n        meta: { title: 'profile', icon: 'user', noCache: true }\n      }\n    ]\n  },\n  {\n    path: '/error',\n    component: Layout,\n    redirect: 'noRedirect',\n    name: 'ErrorPages',\n    meta: {\n      title: 'errorPages',\n      icon: '404'\n    },\n    children: [\n      {\n        path: '404',\n        component: () => import('@/views/error-page/404'),\n        name: 'Page404',\n        meta: { title: 'page404', noCache: true }\n      }\n    ]\n  }\n]\n\nconst router = new Router({\n  scrollBehavior: () => ({ y: 0 }),\n  routes: constRouter\n})\n\nconst whiteList = ['/login']\nlet asyncRouter\n\n// 前置守卫逻辑\nrouter.beforeEach((to, from, next) => {\n  NProgress.start()\n  if (whiteList.indexOf(to.path) !== -1) {\n    next()\n  } else {\n    const token = db.get('ACCESS_TOKEN')\n    const user = db.get('USER')\n    const userRouter = get('USER_ROUTER')\n    if (token.length && user) {\n      if (!asyncRouter) {\n        if (!userRouter) {\n          request.get(`system/menu/${user.username}`).then((res) => {\n            const permissions = res.data.data.permissions\n            store.commit('account/setPermissions', permissions)\n            asyncRouter = res.data.data.routes\n            store.commit('account/setRoutes', asyncRouter)\n            save('USER_ROUTER', asyncRouter)\n            go(to, next)\n          })\n        } else {\n          asyncRouter = userRouter\n          go(to, next)\n        }\n      } else {\n        next()\n      }\n    } else {\n      if (to.path === '/login') {\n        next()\n      } else {\n        next('/login')\n      }\n    }\n  }\n})\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br"),s("span",{staticClass:"line-number"},[n._v("39")]),s("br"),s("span",{staticClass:"line-number"},[n._v("40")]),s("br"),s("span",{staticClass:"line-number"},[n._v("41")]),s("br"),s("span",{staticClass:"line-number"},[n._v("42")]),s("br"),s("span",{staticClass:"line-number"},[n._v("43")]),s("br"),s("span",{staticClass:"line-number"},[n._v("44")]),s("br"),s("span",{staticClass:"line-number"},[n._v("45")]),s("br"),s("span",{staticClass:"line-number"},[n._v("46")]),s("br"),s("span",{staticClass:"line-number"},[n._v("47")]),s("br"),s("span",{staticClass:"line-number"},[n._v("48")]),s("br"),s("span",{staticClass:"line-number"},[n._v("49")]),s("br"),s("span",{staticClass:"line-number"},[n._v("50")]),s("br"),s("span",{staticClass:"line-number"},[n._v("51")]),s("br"),s("span",{staticClass:"line-number"},[n._v("52")]),s("br"),s("span",{staticClass:"line-number"},[n._v("53")]),s("br"),s("span",{staticClass:"line-number"},[n._v("54")]),s("br"),s("span",{staticClass:"line-number"},[n._v("55")]),s("br"),s("span",{staticClass:"line-number"},[n._v("56")]),s("br"),s("span",{staticClass:"line-number"},[n._v("57")]),s("br"),s("span",{staticClass:"line-number"},[n._v("58")]),s("br"),s("span",{staticClass:"line-number"},[n._v("59")]),s("br"),s("span",{staticClass:"line-number"},[n._v("60")]),s("br"),s("span",{staticClass:"line-number"},[n._v("61")]),s("br"),s("span",{staticClass:"line-number"},[n._v("62")]),s("br"),s("span",{staticClass:"line-number"},[n._v("63")]),s("br"),s("span",{staticClass:"line-number"},[n._v("64")]),s("br"),s("span",{staticClass:"line-number"},[n._v("65")]),s("br"),s("span",{staticClass:"line-number"},[n._v("66")]),s("br"),s("span",{staticClass:"line-number"},[n._v("67")]),s("br"),s("span",{staticClass:"line-number"},[n._v("68")]),s("br"),s("span",{staticClass:"line-number"},[n._v("69")]),s("br"),s("span",{staticClass:"line-number"},[n._v("70")]),s("br"),s("span",{staticClass:"line-number"},[n._v("71")]),s("br"),s("span",{staticClass:"line-number"},[n._v("72")]),s("br"),s("span",{staticClass:"line-number"},[n._v("73")]),s("br"),s("span",{staticClass:"line-number"},[n._v("74")]),s("br"),s("span",{staticClass:"line-number"},[n._v("75")]),s("br"),s("span",{staticClass:"line-number"},[n._v("76")]),s("br"),s("span",{staticClass:"line-number"},[n._v("77")]),s("br"),s("span",{staticClass:"line-number"},[n._v("78")]),s("br"),s("span",{staticClass:"line-number"},[n._v("79")]),s("br"),s("span",{staticClass:"line-number"},[n._v("80")]),s("br"),s("span",{staticClass:"line-number"},[n._v("81")]),s("br"),s("span",{staticClass:"line-number"},[n._v("82")]),s("br"),s("span",{staticClass:"line-number"},[n._v("83")]),s("br"),s("span",{staticClass:"line-number"},[n._v("84")]),s("br"),s("span",{staticClass:"line-number"},[n._v("85")]),s("br"),s("span",{staticClass:"line-number"},[n._v("86")]),s("br"),s("span",{staticClass:"line-number"},[n._v("87")]),s("br"),s("span",{staticClass:"line-number"},[n._v("88")]),s("br"),s("span",{staticClass:"line-number"},[n._v("89")]),s("br"),s("span",{staticClass:"line-number"},[n._v("90")]),s("br"),s("span",{staticClass:"line-number"},[n._v("91")]),s("br"),s("span",{staticClass:"line-number"},[n._v("92")]),s("br"),s("span",{staticClass:"line-number"},[n._v("93")]),s("br"),s("span",{staticClass:"line-number"},[n._v("94")]),s("br"),s("span",{staticClass:"line-number"},[n._v("95")]),s("br"),s("span",{staticClass:"line-number"},[n._v("96")]),s("br"),s("span",{staticClass:"line-number"},[n._v("97")]),s("br"),s("span",{staticClass:"line-number"},[n._v("98")]),s("br"),s("span",{staticClass:"line-number"},[n._v("99")]),s("br"),s("span",{staticClass:"line-number"},[n._v("100")]),s("br"),s("span",{staticClass:"line-number"},[n._v("101")]),s("br"),s("span",{staticClass:"line-number"},[n._v("102")]),s("br"),s("span",{staticClass:"line-number"},[n._v("103")]),s("br"),s("span",{staticClass:"line-number"},[n._v("104")]),s("br"),s("span",{staticClass:"line-number"},[n._v("105")]),s("br"),s("span",{staticClass:"line-number"},[n._v("106")]),s("br"),s("span",{staticClass:"line-number"},[n._v("107")]),s("br"),s("span",{staticClass:"line-number"},[n._v("108")]),s("br"),s("span",{staticClass:"line-number"},[n._v("109")]),s("br"),s("span",{staticClass:"line-number"},[n._v("110")]),s("br"),s("span",{staticClass:"line-number"},[n._v("111")]),s("br"),s("span",{staticClass:"line-number"},[n._v("112")]),s("br"),s("span",{staticClass:"line-number"},[n._v("113")]),s("br"),s("span",{staticClass:"line-number"},[n._v("114")]),s("br"),s("span",{staticClass:"line-number"},[n._v("115")]),s("br")])]),s("p",[n._v("上面代码中，我们创建了一个"),s("code",[n._v("constRouter")]),n._v("对象，该对象包含了用户的通用路由（比如登录页，个人信息页，异常页面等），并通过该对象构建了"),s("code",[n._v("router")]),n._v("。紧接着，我们通过"),s("code",[n._v("router")]),n._v("的"),s("code",[n._v("beforeEach")]),n._v("定义了导航守卫的逻辑，这段逻辑看着挺绕，我们可以通过下面这个流程图来理解这段代码：")]),n._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/08/28/m7F2cj.png",alt:"156.png"}})]),n._v(" "),s("p",[n._v("如上图所示，无论流程走那个分支，最终结果都是导向渲染组件这一步（如果最后一步是跳转到/login，因为路由发生了变化，所以他将重新触发前置守卫，因为/login包含在白名单中，所以也会导向渲染组件这一步），否则程序将进入死循环。")]),n._v(" "),s("p",[n._v("上面流程中需要详细说明的步骤有：")]),n._v(" "),s("ol",[s("li",[n._v("用户跳转到登录页后，用户登录逻辑将会在6.4节详细介绍；")]),n._v(" "),s("li",[n._v("当浏览器内存中不包含用户路由信息时，我们通过上一节创建并注册的Axios方法从后端获取用户路由信息（主要包含用户菜单和用户权限信息），这一步将在6.3节详细介绍；")]),n._v(" "),s("li",[n._v("当获取了用户路由信息后，将用户路由添加到动态路由中，实现这一步的主要代码有：")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("function go(to, next) {\n  asyncRouter = filterAsyncRouter(asyncRouter)\n  router.addRoutes(asyncRouter)\n  next({ ...to, replace: true })\n}\n\nfunction filterAsyncRouter(routes) {\n  return routes.filter((route) => {\n    const component = route.component\n    if (component) {\n      if (route.component === 'Layout') {\n        route.component = Layout\n      } else {\n        route.component = view(component)\n      }\n      if (route.children && route.children.length) {\n        route.children = filterAsyncRouter(route.children)\n      }\n      return true\n    }\n  })\n}\n\nfunction view(path) {\n  return function(resolve) {\n    import(`@/views/${path}.vue`).then(mod => {\n      resolve(mod)\n    })\n  }\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br")])]),s("p",[n._v("复制")]),n._v(" "),s("p",[n._v("在"),s("code",[n._v("go")]),n._v("函数中，我们通过"),s("code",[n._v("filterAsyncRouter")]),n._v("函数来构建动态路由对象。"),s("code",[n._v("filterAsyncRouter")]),n._v("函数主要逻辑是：遍历用户路由对象，通过"),s("code",[n._v("import")]),n._v("关键字引入用户路由存储的组件地址所对应的组件（按需引入，节省内存），如果路由包含子路由，则继续调用"),s("code",[n._v("filterAsyncRouter")]),n._v("函数处理（递归）。")]),n._v(" "),s("p",[n._v("构建好动态路由对象后，通过Vue提供的"),s("code",[n._v("router.addRoutes")]),n._v("方法，将其添加到全局路由中。")]),n._v(" "),s("h2",{attrs:{id:"全局后置钩子"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#全局后置钩子"}},[n._v("#")]),n._v(" 全局后置钩子")]),n._v(" "),s("p",[n._v("全局后置钩子的逻辑很简单：")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("router.afterEach(() => {\n  NProgress.done()\n})\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br")])]),s("p",[n._v("在全局前置守卫的第一行代码中，我们调用了"),s("code",[n._v("NProgress.start()")]),n._v("方法，效果是当路由发生变化时，页面顶部开始加载进度条，当页面加载结束（即路由跳转完毕）后，我们需要调用"),s("code",[n._v("NProgress.done()")]),n._v("方法，让进度条结束加载。")])])}),[],!1,null,null,null);s.default=t.exports}}]);