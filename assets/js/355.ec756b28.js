(window.webpackJsonp=window.webpackJsonp||[]).push([[355],{704:function(s,n,e){"use strict";e.r(n);var a=e(0),t=Object(a.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[s._v("在权限系统中，每个用户都拥有相应的角色，比如注册用户，管理员，普通用户等。每种角色都对应着不同的权限，换句话说，每个用户看到的系统菜单也不一样。在Vue构建的前端系统中，菜单是和Vue路由挂钩的，所以我们需要根据登录用户构建出与他角色相匹配的路由。")]),s._v(" "),n("p",[s._v("FEBS Cloud Web前端采用 vue element admin构建，它的路由结构如下所示：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("{\n  path: '/permission',\n  component: Layout,\n  redirect: '/permission/index', //重定向地址，在面包屑中点击会重定向去的地址\n  hidden: true, // 不在侧边栏线上\n  alwaysShow: true, //一直显示根路由\n  meta: { roles: ['admin','editor'] }, //你可以在根路由设置权限，这样它下面所以的子路由都继承了这个权限\n  children: [{\n    path: 'index',\n    component: ()=>import('permission/index'),\n    name: 'permission',\n    meta: {\n      title: 'permission',\n      icon: 'lock', //图标\n      role: ['admin','editor'], //或者你可以给每一个子路由设置自己的权限\n      noCache: true // 不会被 <keep-alive> 缓存\n    }\n  }]\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("p",[s._v("所以我们的目标是，通过用户的角色信息，查询出对应的菜单信息，然后构建如上所示结构的路由对象。")]),s._v(" "),n("h3",{attrs:{id:"完善febs-server-system"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#完善febs-server-system"}},[s._v("#")]),s._v(" 完善febs-server-system")]),s._v(" "),n("p",[s._v("根据上面的路由格式，我们创建一个与之对应的路由对象和meta对象。")]),s._v(" "),n("p",[s._v("在febs-common模块的cc.mrbird.febs.common.entity路径下新建router包，然后在该包下新建"),n("code",[s._v("RouterMeta")]),s._v("类:")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("@Data\n@AllArgsConstructor\n@JsonInclude(JsonInclude.Include.NON_NULL)\npublic class RouterMeta implements Serializable {\n\n    private static final long serialVersionUID = 5499925008927195914L;\n    /**\n     * 标题\n     */\n    private String title;\n    /**\n     * 图标\n     */\n    private String icon;\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("p",[s._v("因为权限是在后端控制的，所以我去掉了role属性。"),n("code",[s._v("@JsonInclude(JsonInclude.Include.NON_NULL)")]),s._v("表示，如果属性值是null的话，不参与序列化。")]),s._v(" "),n("p",[s._v("接着在该路径下继续创建路由对象"),n("code",[s._v("VueRouter")]),s._v("：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("@Data\n@JsonInclude(JsonInclude.Include.NON_NULL)\npublic class VueRouter<T> implements Serializable {\n\n    private static final long serialVersionUID = -3327478146308500708L;\n\n    @JsonIgnore\n    private String id;\n    @JsonIgnore\n    private String parentId;\n    /**\n     * 对应路由path\n     */\n    private String path;\n    /**\n     * 路由名称\n     */\n    private String name;\n    /**\n     * 对应路由组件component\n     */\n    private String component;\n    /**\n     * 重定向地址\n     */\n    private String redirect;\n    /**\n     * 路由元信息\n     */\n    private RouterMeta meta;\n    /**\n     * 是否渲染在菜单上\n     */\n    private Boolean hidden = false;\n    /**\n     * 是否一直显示根路由\n     */\n    private Boolean alwaysShow = false;\n    /**\n     * 子路由\n     */\n    private List<VueRouter<T>> children;\n\n    @JsonIgnore\n    private Boolean hasParent = false;\n\n    @JsonIgnore\n    private Boolean hasChildren = false;\n\n    public void initChildren(){\n        this.children = new ArrayList<>();\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br")])]),n("p",[s._v("路由对象定义好后，我们接下来需要实现根据用户获取菜单信息，并将菜单转换为包含上下级结构的路由信息的功能。")]),s._v(" "),n("p",[s._v("在febs-server-system模块的cc.mrbird.febs.server.system.mapper路径下新建"),n("code",[s._v("MenuMapper")]),s._v("：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("public interface MenuMapper extends BaseMapper<Menu> {\n\n    /**\n     * 通过用户名查询权限信息\n     *\n     * @param username 用户名称\n     * @return 权限信息\n     */\n    List<Menu> findUserPermissions(String username);\n\n    /**\n     * 通过用户名查询菜单信息\n     *\n     * @param username 用户名\n     * @return 菜单信息\n     */\n    List<Menu> findUserMenus(String username);\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("因为方法的具体实现涉及到关联查询，所以不能用Mybatis Plus来实现，需要创建相应的XML实现。在febs-server-system模块的resources/mapper/system路径下新建"),n("code",[s._v("MenuMapper.xml")]),s._v("：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">\n<mapper namespace="cc.mrbird.febs.server.system.mapper.MenuMapper">\n\n    <select id="findUserPermissions" resultType="menu">\n        select distinct m.perms\n        from t_role r\n                 left join t_user_role ur on (r.role_id = ur.role_id)\n                 left join t_user u on (u.user_id = ur.user_id)\n                 left join t_role_menu rm on (rm.role_id = r.role_id)\n                 left join t_menu m on (m.menu_id = rm.menu_id)\n        where u.username = #{userName}\n          and m.perms is not null\n          and m.perms &lt;&gt; \'\'\n    </select>\n\n    <select id="findUserMenus" resultType="menu">\n        select m.*\n        from t_menu m\n        where m.type &lt;&gt; 1\n          and m.MENU_ID in\n              (select distinct rm.menu_id\n               from t_role_menu rm\n                        left join t_role r on (rm.role_id = r.role_id)\n                        left join t_user_role ur on (ur.role_id = r.role_id)\n                        left join t_user u on (u.user_id = ur.user_id)\n               where u.username = #{userName})\n        order by m.order_num\n    </select>\n</mapper>\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br")])]),n("p",[s._v("SQL较为简单，这里不做过多说明。")]),s._v(" "),n("p",[s._v("创建好Dao层后，接着创建Service层。在febs-server-system模块的cc.mrbird.febs.server.system.service路径下新建"),n("code",[s._v("IMenuService")]),s._v("：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("public interface IMenuService extends IService<Menu> {\n\n    /**\n     * 通过用户名查询用户权限信息\n     *\n     * @param username 用户名\n     * @return 权限信息\n     */\n    Set<String> findUserPermissions(String username);\n\n    /**\n     * 通过用户名创建对应的 Vue路由信息\n     *\n     * @param username 用户名\n     * @return 路由信息\n     */\n    List<VueRouter<Menu>> getUserRouters(String username);\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("接着在该路径下的impl包下新建"),n("code",[s._v("IMenuService")]),s._v("的实现类"),n("code",[s._v("MenuServiceImpl")]),s._v("：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Slf4j\n@Service("menuService")\n@Transactional(propagation = Propagation.SUPPORTS, readOnly = true, rollbackFor = Exception.class)\npublic class MenuServiceImpl extends ServiceImpl<MenuMapper, Menu> implements IMenuService {\n\n    @Override\n    public Set<String> findUserPermissions(String username) {\n        List<Menu> userPermissions = this.baseMapper.findUserPermissions(username);\n        return userPermissions.stream().map(Menu::getPerms).collect(Collectors.toSet());\n    }\n\n    @Override\n    public List<VueRouter<Menu>> getUserRouters(String username) {\n        List<VueRouter<Menu>> routes = new ArrayList<>();\n        List<Menu> menus = this.baseMapper.findUserMenus(username);\n        menus.forEach(menu -> {\n            VueRouter<Menu> route = new VueRouter<>();\n            route.setId(menu.getMenuId().toString());\n            route.setParentId(menu.getParentId().toString());\n            route.setPath(menu.getPath());\n            route.setComponent(menu.getComponent());\n            route.setName(menu.getMenuName());\n            route.setMeta(new RouterMeta(menu.getMenuName(), menu.getIcon()));\n            routes.add(route);\n        });\n        return TreeUtil.buildVueRouter(routes);\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br")])]),n("p",[n("code",[s._v("findUserPermissions")]),s._v("方法的实现逻辑为：通过用户名查询出用户权限集合。"),n("code",[s._v("getUserRouters")]),s._v("方法的实现逻辑为：通过用户名查询出用户菜单集合，然后遍历集合，将菜单对象一一转换为路由对象，然后添加到路由集合中。这时候的路由集合是没有层级结构的，我们可以通过"),n("code",[s._v("TreeUtil")]),s._v("的"),n("code",[s._v("buildVueRouter")]),s._v("方法，将路由集合转换为包含层级结构的路由信息。")]),s._v(" "),n("p",[s._v("在febs-common模块的cc.mrbird.febs.common.utils路径下新建"),n("code",[s._v("TreeUtil")]),s._v("，代码如下所示：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('public class TreeUtil {\n\n    private final static String TOP_NODE_ID = "0";\n\n    /**\n     * 构造前端路由\n     *\n     * @param routes routes\n     * @param <T>    T\n     * @return ArrayList<VueRouter < T>>\n     */\n    public static <T> List<VueRouter<T>> buildVueRouter(List<VueRouter<T>> routes) {\n        if (routes == null) {\n            return null;\n        }\n        List<VueRouter<T>> topRoutes = new ArrayList<>();\n        VueRouter<T> router = new VueRouter<>();\n        routes.forEach(route -> {\n            String parentId = route.getParentId();\n            if (parentId == null || TOP_NODE_ID.equals(parentId)) {\n                topRoutes.add(route);\n                return;\n            }\n            for (VueRouter<T> parent : routes) {\n                String id = parent.getId();\n                if (id != null && id.equals(parentId)) {\n                    if (parent.getChildren() == null)\n                        parent.initChildren();\n                    parent.getChildren().add(route);\n                    parent.setAlwaysShow(true);\n                    parent.setHasChildren(true);\n                    route.setHasParent(true);\n                    parent.setHasParent(true);\n                    return;\n                }\n            }\n        });\n        VueRouter<T> router404 = new VueRouter<>();\n        router404.setName("404");\n        router404.setComponent("error-page/404");\n        router404.setPath("*");\n\n        topRoutes.add(router404);\n        return topRoutes;\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br")])]),n("p",[s._v("创建好Service层后，我们最后创建一个控制器，对外暴露服务。在febs-server-system模块的cc.mrbird.febs.server.system.controller路径下新建"),n("code",[s._v("MenuController")]),s._v("：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Slf4j\n@Validated\n@RestController\n@RequestMapping("/menu")\npublic class MenuController {\n\n    @Autowired\n    private IMenuService menuService;\n\n    @GetMapping("/{username}")\n    public FebsResponse getUserRouters(@NotBlank(message = "{required}") @PathVariable String username) {\n        Map<String, Object> result = new HashMap<>();\n        // 构建用户路由对象\n        List<VueRouter<Menu>> userRouters = this.menuService.getUserRouters(username);\n        // 获取用户权限信息\n        Set<String> userPermissions = this.menuService.findUserPermissions(username);\n        // 组装数据\n        result.put("routes", userRouters);\n        result.put("permissions", userPermissions);\n        return new FebsResponse().data(result);\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("p",[s._v("编写完后，分别启动febs-register、febs-gateway、febs-auth和febs-server-system模块，在启动过程中，可能会抛出如下异常：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("19:35:41,164 |-WARN in net.logstash.logback.appender.LogstashTcpSocketAppender[logstash] - Log destination 192.168.33.10:4560: connection failed. java.net.SocketTimeoutException: connect timed out\n\tat java.net.SocketTimeoutException: connect timed out\n\tat \tat java.net.DualStackPlainSocketImpl.waitForConnect(Native Method)\n\tat \tat java.net.DualStackPlainSocketImpl.socketConnect(DualStackPlainSocketImpl.java:85)\n\tat \tat java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)\n\tat \tat java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)\n\tat \tat java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)\n\tat \tat java.net.PlainSocketImpl.connect(PlainSocketImpl.java:172)\n\tat \tat java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)\n\tat \tat java.net.Socket.connect(Socket.java:589)\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("这是因为我们在上一章配置了ELK日志收集，而我这时候并没有启动ELK服务，所以报超时异常，忽略即可。")]),s._v(" "),n("p",[s._v("启动后，使用PostMan获取令牌，然后发送 "),n("a",{attrs:{href:"localhost:8301/system/menu/mrbird"}},[s._v("localhost:8301/system/menu/mrbird")]),s._v("请求：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/28/mHp2fH.png",alt:"157.png"}})]),s._v(" "),n("p",[s._v("响应数据格式如下所示：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('{\n    "data": {\n        "routes": [\n            {\n                "path": "/system",\n                "name": "系统管理",\n                "component": "Layout",\n                "meta": {\n                    "title": "系统管理",\n                    "icon": "el-icon-set-up"\n                },\n                "hidden": false,\n                "alwaysShow": true,\n                "children": [\n                    {\n                        "path": "/system/user",\n                        "name": "用户管理",\n                        "component": "febs/system/user/Index",\n                        "meta": {\n                            "title": "用户管理",\n                            "icon": ""\n                        },\n                        "hidden": false,\n                        "alwaysShow": false\n                    }\n                ]\n            },\n            {\n                "path": "*",\n                "name": "404",\n                "component": "error-page/404",\n                "hidden": false,\n                "alwaysShow": false\n            }\n        ],\n        "permissions": [\n            "user:view",\n            "user:add",\n            "user:delete",\n            "user:update"\n        ]\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br")])]),n("p",[s._v("可以看到，响应数据包含了用户路由routes和权限permissions信息，并且路由信息已具有层级结构。通过上一节的导航守卫功能，用户路由就可以动态添加到全局路由中了，这就实现了不同用户拥有不同路由的功能。")])])}),[],!1,null,null,null);n.default=t.exports}}]);