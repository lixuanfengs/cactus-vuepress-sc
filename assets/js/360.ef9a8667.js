(window.webpackJsonp=window.webpackJsonp||[]).push([[360],{710:function(s,n,a){"use strict";a.r(n);var e=a(0),t=Object(e.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[s._v("这一节，我们将使用Docker Compose一键部署我们的微服务。主要分为三部分：部署ELK、部署第三方服务（MySQL、Redis和RabbitMQ）、部署自己编写的微服务（也就是上一节中打包创建Docker镜像那些服务）。")]),s._v(" "),n("p",[s._v("因为我之前重启过CentOS虚拟机，所以需要重新启动在第五章搭建的ELK服务。将目录切换到/febs/elk，然后运行下面这条命令启动ELK服务：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("docker-compose start\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("查看是否启动成功：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/30/mOrKFe.png",alt:"176.png"}})]),s._v(" "),n("p",[s._v("可以看到ELK三个容器都在运行中了。")]),s._v(" "),n("h2",{attrs:{id:"部署第三方服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#部署第三方服务"}},[s._v("#")]),s._v(" 部署第三方服务")]),s._v(" "),n("p",[s._v("创建一个存储第三方服务Docker Compose文件目录：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("mkdir -p /febs/third-part\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("然后在该目录下新建一个docker-compose.yml文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("vim /febs/third-part/docker-compose.yml\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("内容如下所示：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("version: '3'\n\nservices:\n  mysql:\n    image: mysql:5.7.24\n    container_name: mysql\n    environment:\n      MYSQL_ROOT_PASSWORD: 123456\n    ports:\n      - 3306:3306\n    volumes:\n      - /febs/mysql/data:/var/lib/mysql #挂载 MySQL数据\n  redis:\n    image: redis:4.0.14\n    container_name: redis\n    command: redis-server /usr/local/etc/redis/redis.conf --appendonly yes\n    volumes:\n      - /febs/redis/data:/data #挂载 Redis数据\n      - /febs/redis/conf/redis.conf:/usr/local/etc/redis/redis.conf #挂载 Redis配置\n    ports:\n      - 6379:6379\n  rabbitmq:\n    image: rabbitmq:3.7.15-management\n    container_name: rabbitmq\n    volumes:\n      - /febs/rabbitmq/data:/var/lib/rabbitmq #挂载 RabbitMQ数据\n      - /febs/rabbitmq/log:/var/log/rabbitmq #挂载 RabbitMQ日志\n    ports:\n      - 5672:5672\n      - 15672:15672\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br")])]),n("p",[s._v("接着创建上面docker-compose.yml里定义的挂载目录：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("mkdir -p /febs/mysql/data /febs/redis/data /febs/redis/conf \\\n /febs/rabbitmq/data /febs/rabbitmq/log\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("创建Redis配置文件"),n("code",[s._v("redis.conf")]),s._v("：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("touch /febs/redis/conf/redis.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("因为我使用的是Redis默认配置，所以并没有在该配置文件里编写任何内容。")]),s._v(" "),n("p",[s._v("准备完毕后，将目录切换到/febs/third-part，然后运行"),n("code",[s._v("docker-compose up -d")]),s._v("启动：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/30/mO6Fzj.png",alt:"177.png"}})]),s._v(" "),n("p",[s._v("可以看到，MySQL、Redis和RabbitMQ这三个容器都启动了。")]),s._v(" "),n("p",[s._v("使用Navicat连接MySQL：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/30/mO6tw6.png",alt:"178.png"}})]),s._v(" "),n("p",[s._v("然后创建数据库：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/30/mO6BSH.png",alt:"179.png"}})]),s._v(" "),n("p",[s._v("最后导入febs_cloud_base SQL和zipkin相关SQL，导入后库表如下所示：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/30/mOcKBt.png",alt:"180.png"}})]),s._v(" "),n("p",[s._v("MySQL准备完毕后，使用Redis Desktop Manager看看能否成功连接Redis：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/30/mOchE6.png",alt:"181.png"}})]),s._v(" "),n("p",[s._v("连接成功。")]),s._v(" "),n("p",[s._v("最后，我们需要登录RabbitMQ控制台创建一个新的账号。使用浏览器访问http://192.168.33.10:15672/，默认用户名和密码都为guest。在Admin标签页里新建一个用户，用户名为febs，密码为123456，角色为管理员：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/30/mO2oXd.png",alt:"182.png"}})]),s._v(" "),n("p",[s._v("然后对febs用户授权，点击febs用户：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/30/mORx56.png",alt:"183.png"}})]),s._v(" "),n("p",[s._v("点击Set Permission按钮：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/30/mOWQMQ.png",alt:"184.png"}})]),s._v(" "),n("p",[s._v("至此第三方服务都准备完毕，接下来开始部署我们自己的微服务。")]),s._v(" "),n("h2",{attrs:{id:"部署微服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#部署微服务"}},[s._v("#")]),s._v(" 部署微服务")]),s._v(" "),n("p",[s._v("新建一个目录，用于存放Docker Compose文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("mkdir -p /febs/febs-cloud\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("然后在该目录下新建一个docker-compose.yml文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("vim /febs/febs-cloud/docker-compose.yml\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("内容如下所示：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('version: \'3\'\n\nservices:\n  febs-register:\n    image: febs-register:latest # 指定基础镜像，就是上一节中我们自己构建的镜像\n    container_name: febs-register # 容器名称\n    volumes:\n      - "/febs/log:/log" #日志挂载\n    command:\n      - "--febs-register=192.168.33.10" # 通过command指定地址变量值\n      - "--febs-monitor-admin=192.168.33.10"\n    ports:\n      - 8001:8001 # 端口映射\n  febs-monitor-admin:\n    image: febs-monitor-admin:latest\n    container_name: febs-monitor-admin\n    volumes:\n      - "/febs/log:/log"\n    ports:\n      - 8401:8401\n  febs-gateway:\n    image: febs-gateway:latest\n    container_name: febs-gateway\n    depends_on:\n      - febs-register\n    volumes:\n      - "/febs/log:/log"\n    command:\n      - "--febs-register=192.168.33.10"\n      - "--febs-monitor-admin=192.168.33.10"\n    ports:\n      - 8301:8301\n  febs-auth:\n    image: febs-auth:latest\n    container_name: febs-auth\n    depends_on:\n      - febs-register\n    volumes:\n      - "/febs/log:/log"\n    command:\n      - "--mysql.url=192.168.33.10"\n      - "--redis.url=192.168.33.10"\n      - "--febs-register=192.168.33.10"\n      - "--febs-monitor-admin=192.168.33.10"\n  febs-server-system:\n    image: febs-server-system:latest\n    container_name: febs-server-system\n    depends_on:\n      - febs-register\n    volumes:\n      - "/febs/log:/log"\n    command:\n      - "--mysql.url=192.168.33.10"\n      - "--rabbitmq.url=192.168.33.10"\n      - "--febs-register=192.168.33.10"\n      - "--febs-monitor-admin=192.168.33.10"\n      - "--febs-gateway=192.168.33.10"\n  febs-server-test:\n    image: febs-server-test:latest\n    container_name: febs-server-test\n    depends_on:\n      - febs-register\n    volumes:\n      - "/febs/log:/log"\n    command:\n      - "--rabbitmq.url=192.168.33.10"\n      - "--febs-register=192.168.33.10"\n      - "--febs-monitor-admin=192.168.33.10"\n      - "--febs-gateway=192.168.33.10"\n  zipkin-server:\n    image: zipkin-server\n    container_name: zipkin-server\n    command:\n      - "--server.port=8402"\n      - "--zipkin.storage.type=mysql"\n      - "--zipkin.storage.mysql.db=febs_cloud_base"\n      - "--zipkin.storage.mysql.username=root"\n      - "--zipkin.storage.mysql.password=123456"\n      - "--zipkin.storage.mysql.host=192.168.33.10"\n      - "--zipkin.storage.mysql.port=3306"\n      - "--zipkin.collector.rabbitmq.addresses=192.168.33.10:5672"\n      - "--zipkin.collector.rabbitmq.username=febs"\n      - "--zipkin.collector.rabbitmq.password=123456"\n    ports:\n      - 8402:8402\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br")])]),n("p",[s._v("在当前目录下运行"),n("code",[s._v("docker-compose up -d")]),s._v("启动服务：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/30/mOzGwt.png",alt:"185.png"}})]),s._v(" "),n("p",[s._v("查看正在运行的容器：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/30/mXtq5n.png",alt:"186.png"}})]),s._v(" "),n("p",[s._v("因为启动的微服务较多，所以需要等待一段时间。一段时间过后，使用浏览器访问http://192.168.33.10:8001/register/，查看微服务是否都顺利注册到了febs-register：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/30/mXNYM8.png",alt:"187.png"}})]),s._v(" "),n("p",[s._v("可以看到，微服务都注册成功。接着使用浏览器访问"),n("a",{attrs:{href:"http://192.168.33.10:8401/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://192.168.33.10:8401"),n("OutboundLink")],1),s._v("，看看微服务是否都运行成功：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/08/30/mXNHsO.png",alt:"188.png"}})]),s._v(" "),n("p",[s._v("可以看到，受febs-monitor-admin监控的这几个微服务运行正常。接下来我们使用PostMan测试令牌获取等功能是否正常。")]),s._v(" "),n("h2",{attrs:{id:"postman测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#postman测试"}},[s._v("#")]),s._v(" PostMan测试")]),s._v(" "),n("p",[s._v("首先通过浏览器访问http://192.168.33.10:8301/auth/captcha?key=777774396，获取图形验证码：")])])}),[],!1,null,null,null);n.default=t.exports}}]);