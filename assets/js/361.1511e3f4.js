(window.webpackJsonp=window.webpackJsonp||[]).push([[361],{711:function(e,n,t){"use strict";t.r(n);var s=t(0),r=Object(s.a)({},(function(){var e=this,n=e._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h2",{attrs:{id:"redistokenstore"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#redistokenstore"}},[e._v("#")]),e._v(" RedisTokenStore")]),e._v(" "),n("p",[e._v("在第一章搭建认证服务器的时候，我们使用的是RedisTokenStore令牌存储策略。使用这种策略时，用户的access_token将存储到Redis中，退出登录后，Redis中存储的令牌也会被清除。")]),e._v(" "),n("p",[e._v("除了这种令牌存储策略外，Spring还提供了InMemoryTokenStore、JdbcTokenStore和JwtTokenStore三种存储策略：")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/09/12/n0Gia6.png",alt:"295.png"}})]),e._v(" "),n("h2",{attrs:{id:"inmemorytokenstore"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#inmemorytokenstore"}},[e._v("#")]),e._v(" InMemoryTokenStore")]),e._v(" "),n("p",[e._v("该策略将令牌存储到内存中，优点就是无需依赖第三方存储，对于开发小型服务是不错的选择；缺点是认证服务器故障重启后，之前存储的令牌就丢失。")]),e._v(" "),n("p",[e._v("假如您要使用该策略存储令牌，只需要修改febs-auth模块下认证服务器配置类"),n("code",[e._v("FebsAuthorizationServerConfigure")]),e._v("的"),n("code",[e._v("TokenStore")]),e._v("就行：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("@Bean\npublic TokenStore tokenStore() {\n    return new InMemoryTokenStore();\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br")])]),n("h2",{attrs:{id:"jdbctokenstore"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#jdbctokenstore"}},[e._v("#")]),e._v(" JdbcTokenStore")]),e._v(" "),n("p",[e._v("顾名思义，该策略使用数据库来存储令牌。在使用这种策略之前，我们需要先准备好库表。Spring Security OAuth仓库可以找到相应的脚本：https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/test/resources/schema.sql。该脚本为HSQL，而我们使用的是MySQL数据库，并且当前项目中，只需要使用到"),n("code",[e._v("oauth_access_token")]),e._v("和"),n("code",[e._v("oauth_refresh_token")]),e._v("数据表，所以将创建这两个库表的语句改为MySQL语句：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("CREATE TABLE oauth_access_token (\n\ttoken_id VARCHAR ( 256 ),\n\ttoken BLOB,\n\tauthentication_id VARCHAR ( 256 ),\n\tuser_name VARCHAR ( 256 ),\n\tclient_id VARCHAR ( 256 ),\n\tauthentication BLOB,\n\trefresh_token VARCHAR ( 256 ) \n);\nCREATE TABLE oauth_refresh_token ( token_id VARCHAR ( 256 ), token BLOB, authentication BLOB );\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br")])]),n("p",[e._v("在febs_cloud_base数据库中执行上面的脚本即可。")]),e._v(" "),n("p",[e._v("创建好库表后，修改febs-auth模块的认证服务器配置类"),n("code",[e._v("FebsAuthorizationServerConfigure")]),e._v("的"),n("code",[e._v("TokenStore")]),e._v("：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("@Configuration\n@EnableAuthorizationServer\npublic class FebsAuthorizationServerConfigure extends AuthorizationServerConfigurerAdapter {\n\n    @Autowired\n    private DataSource dataSource;\n\n    ......\n\n    @Bean\n    public TokenStore tokenStore() {\n        return new JdbcTokenStore(dataSource);\n    }\n    ......\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br")])]),n("p",[e._v("在创建"),n("code",[e._v("JdbcTokenStore")]),e._v("的时候需要指定数据源，因为当前febs-auth模块中只配置了一个数据源，所以可以直接注入使用。如果您使用MyBatis Plus配置了多数据源，需要获取指定名称数据源的话，可以使用下面这段代码获取：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('@Configuration\n@EnableAuthorizationServer\npublic class FebsAuthorizationServerConfigure extends AuthorizationServerConfigurerAdapter {\n\n    ......\n    \n    @Autowired\n    private DynamicRoutingDataSource dynamicRoutingDataSource;\n\n    @Bean\n    public TokenStore tokenStore() {\n        DataSource febsCloudBase = dynamicRoutingDataSource.getDataSource("febs_cloud_base");\n        return new JdbcTokenStore(febsCloudBase);\n    }\n    ......\n}\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br")])]),n("p",[e._v("改造好后，分别启动febs-register、febs-gateway、febs-auth和febs-sever-system模块，然后使用PostMan获取令牌：")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/09/12/n0f5AP.png",alt:"296.png"}})]),e._v(" "),n("p",[e._v("令牌获取成功，查看库表是否存储了相关信息：")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/09/12/n0hZAx.png",alt:"297.png"}})]),e._v(" "),n("p",[e._v("使用PostMan进行登出操作:")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/09/12/n0hK3D.png",alt:"298.png"}})]),e._v(" "),n("p",[e._v("登出成功后再次查看数据库：")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/09/12/n0hUC8.png",alt:"299.png"}})]),e._v(" "),n("p",[e._v("数据库记录也已经被删除。")]),e._v(" "),n("h2",{attrs:{id:"jwttokenstore"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#jwttokenstore"}},[e._v("#")]),e._v(" JwtTokenStore")]),e._v(" "),n("p",[e._v("前面三种存储策略生成的令牌都是使用UUID生成的无意义字符串，我们也可以使用"),n("code",[e._v("JwtTokenStore")]),e._v("生成JWT格式令牌。")]),e._v(" "),n("p",[e._v("在febs-auth模块下认证服务器配置类"),n("code",[e._v("FebsAuthorizationServerConfigure")]),e._v("中配置"),n("code",[e._v("JwtTokenStore")]),e._v("：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('@Configuration\n@EnableAuthorizationServer\npublic class FebsAuthorizationServerConfigure extends AuthorizationServerConfigurerAdapter {\n\n    ......\n\n    @Bean\n    public TokenStore tokenStore() {\n        return new JwtTokenStore(jwtAccessTokenConverter());\n    }\n\n   @Bean\n   public JwtAccessTokenConverter jwtAccessTokenConverter() {\n       JwtAccessTokenConverter accessTokenConverter = new JwtAccessTokenConverter();\n       DefaultAccessTokenConverter defaultAccessTokenConverter = (DefaultAccessTokenConverter) accessTokenConverter.getAccessTokenConverter();\n       DefaultUserAuthenticationConverter userAuthenticationConverter = new DefaultUserAuthenticationConverter();\n       userAuthenticationConverter.setUserDetailsService(userDetailService);\n       defaultAccessTokenConverter.setUserTokenConverter(userAuthenticationConverter);\n       accessTokenConverter.setSigningKey("febs");\n       return accessTokenConverter;\n    }\n    ......\n}\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br")])]),n("p",[e._v("创建"),n("code",[e._v("JwtTokenStore")]),e._v("的时候需要指定"),n("code",[e._v("JwtAccessTokenConverter")]),e._v("，所以我们"),n("code",[e._v("FebsAuthorizationServerConfigure")]),e._v("中也创建了"),n("code",[e._v("jwtAccessTokenConverter")]),e._v("Bean，该Bean指定了JWT的密钥，防止我们的令牌在传输途中被篡改。")]),e._v(" "),n("p",[e._v("除了在创建"),n("code",[e._v("JwtTokenStore")]),e._v("的时候需要指定"),n("code",[e._v("JwtAccessTokenConverter")]),e._v("外，我们还需要在"),n("code",[e._v("FebsAuthorizationServerConfigure")]),e._v("的"),n("code",[e._v("configure")]),e._v("方法中也指定该"),n("code",[e._v("JwtAccessTokenConverter")]),e._v("，用于后续JWT校验：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('@Configuration\n@EnableAuthorizationServer\npublic class FebsAuthorizationServerConfigure extends AuthorizationServerConfigurerAdapter {\n\n    ......\n\n    @Override\n    @SuppressWarnings("all")\n    public void configure(AuthorizationServerEndpointsConfigurer endpoints) {\n        endpoints.tokenStore(tokenStore())\n                ......\n                .accessTokenConverter(jwtAccessTokenConverter());\n    }\n\n    @Bean\n    public TokenStore tokenStore() {\n        return new JwtTokenStore(jwtAccessTokenConverter());\n    }\n\n   @Bean\n   public JwtAccessTokenConverter jwtAccessTokenConverter() {\n       JwtAccessTokenConverter accessTokenConverter = new JwtAccessTokenConverter();\n       DefaultAccessTokenConverter defaultAccessTokenConverter = (DefaultAccessTokenConverter) accessTokenConverter.getAccessTokenConverter();\n       DefaultUserAuthenticationConverter userAuthenticationConverter = new DefaultUserAuthenticationConverter();\n       userAuthenticationConverter.setUserDetailsService(userDetailService);\n       defaultAccessTokenConverter.setUserTokenConverter(userAuthenticationConverter);\n       accessTokenConverter.setSigningKey("febs");\n       return accessTokenConverter;\n    }\n    ......\n}\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br"),n("span",{staticClass:"line-number"},[e._v("25")]),n("br"),n("span",{staticClass:"line-number"},[e._v("26")]),n("br"),n("span",{staticClass:"line-number"},[e._v("27")]),n("br"),n("span",{staticClass:"line-number"},[e._v("28")]),n("br"),n("span",{staticClass:"line-number"},[e._v("29")]),n("br"),n("span",{staticClass:"line-number"},[e._v("30")]),n("br"),n("span",{staticClass:"line-number"},[e._v("31")]),n("br")])]),n("p",[e._v("此外，这里有个小插曲：在"),n("code",[e._v("DefaultTokenServices")]),e._v("中配置了"),n("code",[e._v("JwtTokenStore")]),e._v("类型的TokenStore貌似并不生效，所以就索性去掉了，然后把令牌有效时间的设置配置在了"),n("code",[e._v("configure(ClientDetailsServiceConfigurer clients)")]),e._v("方法中。至此，完整的"),n("code",[e._v("FebsAuthorizationServerConfigure")]),e._v("代码如下所示：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('@Configuration\n@EnableAuthorizationServer\npublic class FebsAuthorizationServerConfigure extends AuthorizationServerConfigurerAdapter {\n\n    @Autowired\n    private AuthenticationManager authenticationManager;\n    @Autowired\n    private FebsUserDetailService userDetailService;\n    @Autowired\n    private PasswordEncoder passwordEncoder;\n    @Autowired\n    private FebsAuthProperties authProperties;\n    @Autowired\n    private FebsWebResponseExceptionTranslator exceptionTranslator;\n\n    @Override\n    public void configure(ClientDetailsServiceConfigurer clients) throws Exception {\n        FebsClientsProperties[] clientsArray = authProperties.getClients();\n        InMemoryClientDetailsServiceBuilder builder = clients.inMemory();\n        if (ArrayUtils.isNotEmpty(clientsArray)) {\n            for (FebsClientsProperties client : clientsArray) {\n                if (StringUtils.isBlank(client.getClient())) {\n                    throw new Exception("client不能为空");\n                }\n                if (StringUtils.isBlank(client.getSecret())) {\n                    throw new Exception("secret不能为空");\n                }\n                String[] grantTypes = StringUtils.splitByWholeSeparatorPreserveAllTokens(client.getGrantType(), ",");\n                builder.withClient(client.getClient())\n                        .secret(passwordEncoder.encode(client.getSecret()))\n                        .authorizedGrantTypes(grantTypes)\n                        .scopes(client.getScope())\n                        .accessTokenValiditySeconds(authProperties.getAccessTokenValiditySeconds())\n                        .refreshTokenValiditySeconds(authProperties.getRefreshTokenValiditySeconds());\n            }\n        }\n    }\n\n    @Override\n    @SuppressWarnings("all")\n    public void configure(AuthorizationServerEndpointsConfigurer endpoints) {\n        endpoints.tokenStore(tokenStore())\n                .accessTokenConverter(jwtAccessTokenConverter())\n                .userDetailsService(userDetailService)\n                .authenticationManager(authenticationManager)\n                .exceptionTranslator(exceptionTranslator);\n    }\n\n    @Bean\n    public TokenStore tokenStore() {\n        return new JwtTokenStore(jwtAccessTokenConverter());\n    }\n\n    @Bean\n    public JwtAccessTokenConverter jwtAccessTokenConverter() {\n        JwtAccessTokenConverter accessTokenConverter = new JwtAccessTokenConverter();\n        DefaultAccessTokenConverter defaultAccessTokenConverter = (DefaultAccessTokenConverter) accessTokenConverter.getAccessTokenConverter();\n        DefaultUserAuthenticationConverter userAuthenticationConverter = new DefaultUserAuthenticationConverter();\n        userAuthenticationConverter.setUserDetailsService(userDetailService);\n        defaultAccessTokenConverter.setUserTokenConverter(userAuthenticationConverter);\n        accessTokenConverter.setSigningKey("febs");\n        return accessTokenConverter;\n    }\n}\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br"),n("span",{staticClass:"line-number"},[e._v("25")]),n("br"),n("span",{staticClass:"line-number"},[e._v("26")]),n("br"),n("span",{staticClass:"line-number"},[e._v("27")]),n("br"),n("span",{staticClass:"line-number"},[e._v("28")]),n("br"),n("span",{staticClass:"line-number"},[e._v("29")]),n("br"),n("span",{staticClass:"line-number"},[e._v("30")]),n("br"),n("span",{staticClass:"line-number"},[e._v("31")]),n("br"),n("span",{staticClass:"line-number"},[e._v("32")]),n("br"),n("span",{staticClass:"line-number"},[e._v("33")]),n("br"),n("span",{staticClass:"line-number"},[e._v("34")]),n("br"),n("span",{staticClass:"line-number"},[e._v("35")]),n("br"),n("span",{staticClass:"line-number"},[e._v("36")]),n("br"),n("span",{staticClass:"line-number"},[e._v("37")]),n("br"),n("span",{staticClass:"line-number"},[e._v("38")]),n("br"),n("span",{staticClass:"line-number"},[e._v("39")]),n("br"),n("span",{staticClass:"line-number"},[e._v("40")]),n("br"),n("span",{staticClass:"line-number"},[e._v("41")]),n("br"),n("span",{staticClass:"line-number"},[e._v("42")]),n("br"),n("span",{staticClass:"line-number"},[e._v("43")]),n("br"),n("span",{staticClass:"line-number"},[e._v("44")]),n("br"),n("span",{staticClass:"line-number"},[e._v("45")]),n("br"),n("span",{staticClass:"line-number"},[e._v("46")]),n("br"),n("span",{staticClass:"line-number"},[e._v("47")]),n("br"),n("span",{staticClass:"line-number"},[e._v("48")]),n("br"),n("span",{staticClass:"line-number"},[e._v("49")]),n("br"),n("span",{staticClass:"line-number"},[e._v("50")]),n("br"),n("span",{staticClass:"line-number"},[e._v("51")]),n("br"),n("span",{staticClass:"line-number"},[e._v("52")]),n("br"),n("span",{staticClass:"line-number"},[e._v("53")]),n("br"),n("span",{staticClass:"line-number"},[e._v("54")]),n("br"),n("span",{staticClass:"line-number"},[e._v("55")]),n("br"),n("span",{staticClass:"line-number"},[e._v("56")]),n("br"),n("span",{staticClass:"line-number"},[e._v("57")]),n("br"),n("span",{staticClass:"line-number"},[e._v("58")]),n("br"),n("span",{staticClass:"line-number"},[e._v("59")]),n("br"),n("span",{staticClass:"line-number"},[e._v("60")]),n("br"),n("span",{staticClass:"line-number"},[e._v("61")]),n("br"),n("span",{staticClass:"line-number"},[e._v("62")]),n("br"),n("span",{staticClass:"line-number"},[e._v("63")]),n("br"),n("span",{staticClass:"line-number"},[e._v("64")]),n("br")])]),n("p",[e._v("重启febs-auth，使用PostMan获取令牌：")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/09/12/nB9Co6.png",alt:"300.png"}})]),e._v(" "),n("p",[e._v("可以看到access_token的格式变了，将它复制到https://jwt.io/网站可以解析出详细的JSON格式内容：")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/09/12/nBP9PK.png",alt:"301.png"}})]),e._v(" "),n("p",[e._v("可以看到，该令牌包含了过期时间，用户名和用户权限等信息。")]),e._v(" "),n("p",[e._v("使用该令牌访问受保护的接口，观察是否可以正常获取到信息：")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/09/12/nBPqFP.png",alt:"302.png"}})]),e._v(" "),n("p",[e._v("注销该令牌：")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/09/12/nBis1S.png",alt:"303.png"}})]),e._v(" "),n("p",[e._v("提示成功，可是再次用这个令牌去获取受保护的资源，你会发现还是能够正常获取：")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/09/12/nBFS1O.png",alt:"304.png"}})]),e._v(" "),n("p",[e._v("虽然我们通过"),n("code",[e._v("ConsumerTokenServices.revokeToken")]),e._v("注销了JWT令牌，但实际上该令牌还是有效的，这是因为"),n("strong",[e._v("JWT是无状态的，即它不受服务端的控制，其自身包含了过期的时间")]),e._v("。所以虽然我们注销了JWT令牌，但它内部包含的过期时间并没有改变。变通的做法是，我们可以在客户端上清除（从客户端存储的地方删掉，比如localstorage，cookie等）该令牌让其“失效”。")]),e._v(" "),n("h2",{attrs:{id:"总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[e._v("#")]),e._v(" 总结")]),e._v(" "),n("p",[e._v("下面对这四种令牌存储策略做个总结：")]),e._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"left"}},[e._v("存储策略")]),e._v(" "),n("th",{staticStyle:{"text-align":"left"}},[e._v("存储位置")]),e._v(" "),n("th",{staticStyle:{"text-align":"left"}},[e._v("是否可注销")]),e._v(" "),n("th",{staticStyle:{"text-align":"left"}},[e._v("优点")]),e._v(" "),n("th",{staticStyle:{"text-align":"left"}},[e._v("缺点")])])]),e._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"left"}},[e._v("RedisTokenStore")]),e._v(" "),n("td",{staticStyle:{"text-align":"left"}},[e._v("Redis")]),e._v(" "),n("td",{staticStyle:{"text-align":"left"}},[e._v("是")]),e._v(" "),n("td",{staticStyle:{"text-align":"left"}},[e._v("重启不丢失，速度快，多个认证服务器可以通过共享Redis来共享令牌")]),e._v(" "),n("td",{staticStyle:{"text-align":"left"}},[e._v("同一个账号在不同的地点获取令牌是一样的，所以当其中一个用户退出登录后，另一个用户的令牌也会失效")])]),e._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[e._v("InMemoryTokenStore")]),e._v(" "),n("td",{staticStyle:{"text-align":"left"}},[e._v("系统内存")]),e._v(" "),n("td",{staticStyle:{"text-align":"left"}},[e._v("是")]),e._v(" "),n("td",{staticStyle:{"text-align":"left"}},[e._v("速度快，适合小型应用")]),e._v(" "),n("td",{staticStyle:{"text-align":"left"}},[e._v("重启后丢失，同时也具有和RedisTokenStore一样的缺点")])]),e._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[e._v("JdbcTokenStore")]),e._v(" "),n("td",{staticStyle:{"text-align":"left"}},[e._v("关系型数据库")]),e._v(" "),n("td",{staticStyle:{"text-align":"left"}},[e._v("是")]),e._v(" "),n("td",{staticStyle:{"text-align":"left"}},[e._v("重启不丢失，多个认证服务器可以通过共享数据库来共享令牌")]),e._v(" "),n("td",{staticStyle:{"text-align":"left"}},[e._v("速度不及上面两个，同时也具有和上面两种策略一样的缺点")])]),e._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[e._v("JwtTokenStore")]),e._v(" "),n("td",{staticStyle:{"text-align":"left"}},[e._v("无状态")]),e._v(" "),n("td",{staticStyle:{"text-align":"left"}},[e._v("否")]),e._v(" "),n("td",{staticStyle:{"text-align":"left"}},[e._v("可以在令牌中拓展信息，因为无状态，所以并不存在重启丢失一说")]),e._v(" "),n("td",{staticStyle:{"text-align":"left"}},[e._v("不能从服务端注销，令牌长度过长")])])])]),e._v(" "),n("p",[e._v("关于RedisTokenStore的缺点，我们可以在配置TokenStore时，添加下面这段代码解决：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("@Bean\npublic TokenStore tokenStore() {\n   \n      RedisTokenStore redisTokenStore = new RedisTokenStore(redisConnectionFactory);\n      // 解决每次生成的 token都一样的问题\n      redisTokenStore.setAuthenticationKeyGenerator(oAuth2Authentication -> UUID.randomUUID().toString());\n      return redisTokenStore;\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br")])])])}),[],!1,null,null,null);n.default=r.exports}}]);