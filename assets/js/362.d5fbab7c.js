(window.webpackJsonp=window.webpackJsonp||[]).push([[362],{715:function(s,e,n){"use strict";n.r(e);var a=n(0),t=Object(a.a)({},(function(){var s=this,e=s._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("这一节，我们将使用Spring Cloud Gateway构建一个全新的微服务网关，代替之前通过Spring Cloud Zuul构建的微服务网关。和Zuul相比，Spring Cloud Gateway具有如下优势：")]),s._v(" "),e("ol",[e("li",[s._v("基于Reactor模型的WebFlux构建，运行在Netty上，具有更好的性能；")]),s._v(" "),e("li",[s._v("可拓展性高，内置了非常丰富的转发规则，除此之外，我们也可以定义自己的转发规则。")])]),s._v(" "),e("p",[s._v("对于WebFlux不熟悉的同学可以在学完本节后阅读我的博文：https://mrbird.cc/tags/WebFlux/。下面我们开始通过Spring Cloud Gateway搭建网关。")]),s._v(" "),e("p",[s._v("首先，我们删除febs-gateway模块下相关内容，如下图所示：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nxAC0H.png",alt:"305.png"}})]),s._v(" "),e("p",[s._v("然后清空febs-gateway模块的pom文件，在里面添加如下内容：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('<?xml version="1.0" encoding="UTF-8"?>\n<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">\n    <modelVersion>4.0.0</modelVersion>\n    <parent>\n        <groupId>cc.mrbird</groupId>\n        <artifactId>febs-cloud</artifactId>\n        <version>1.0-SNAPSHOT</version>\n        <relativePath>../febs-cloud/pom.xml</relativePath>\n    </parent>\n    <artifactId>febs-gateway</artifactId>\n    <version>1.0-SNAPSHOT</version>\n    <name>FEBS-Gateway</name>\n    <description>FEBS-Gateway服务网关模块</description>\n\n    <dependencies>\n        <dependency>\n            <groupId>cc.mrbird</groupId>\n            <artifactId>febs-common</artifactId>\n            <version>1.0-SNAPSHOT</version>\n            <exclusions>\n                <exclusion>\n                    <groupId>org.springframework.boot</groupId>\n                    <artifactId>spring-boot-starter-web</artifactId>\n                </exclusion>\n                <exclusion>\n                    <groupId>com.baomidou</groupId>\n                    <artifactId>mybatis-plus-boot-starter</artifactId>\n                </exclusion>\n                <exclusion>\n                    <groupId>org.springframework.boot</groupId>\n                    <artifactId>spring-boot-starter-data-redis</artifactId>\n                </exclusion>\n                <exclusion>\n                    <groupId>org.springframework.cloud</groupId>\n                    <artifactId>spring-cloud-starter-oauth2</artifactId>\n                </exclusion>\n                <exclusion>\n                    <groupId>org.springframework.cloud</groupId>\n                    <artifactId>spring-cloud-starter-security</artifactId>\n                </exclusion>\n            </exclusions>\n        </dependency>\n        <dependency>\n            <groupId>org.springframework.cloud</groupId>\n            <artifactId>spring-cloud-starter-gateway</artifactId>\n        </dependency>\n        <dependency>\n            <groupId>net.logstash.logback</groupId>\n            <artifactId>logstash-logback-encoder</artifactId>\n            <version>6.1</version>\n        </dependency>\n    </dependencies>\n\n    <build>\n        <plugins>\n            <plugin>\n                <groupId>org.springframework.boot</groupId>\n                <artifactId>spring-boot-maven-plugin</artifactId>\n            </plugin>\n        </plugins>\n    </build>\n</project>\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br")])]),e("p",[s._v("在pom中，我们引入了"),e("code",[s._v("spring-cloud-starter-gateway")]),s._v("Spring Cloud Gateway依赖和"),e("code",[s._v("febs-common")]),s._v("模块。并且通过"),e("code",[s._v("exclusion")]),s._v("标签从febs-common中排除了以下依赖：")]),s._v(" "),e("ol",[e("li",[e("code",[s._v("spring-boot-starter-web")]),s._v("：因为Spring Cloud Gateway不是基于Servlet编程模型，而是基于webflux。如果非要web支持的话需要导入"),e("code",[s._v("spring-boot-starter-webflux")]),s._v("而不是"),e("code",[s._v("spring-boot-start-web")]),s._v("；")]),s._v(" "),e("li",[s._v("网关模块没有使用到数据库和Redis，所以排除"),e("code",[s._v("mybatis-plus-boot-starter")]),s._v("和"),e("code",[s._v("spring-boot-starter-data-redis")]),s._v("依赖；")]),s._v(" "),e("li",[s._v("因为网关只是做请求转发，认证授权由认证服务器和资源服务器完成，所以我们排除了"),e("code",[s._v("spring-cloud-starter-oauth2")]),s._v("和"),e("code",[s._v("spring-cloud-starter-security")]),s._v("依赖。")])]),s._v(" "),e("p",[s._v("pom文件编写好后，我们在febs-gateway模块下的cc.mrbird.febs.gateway下新建启动类"),e("code",[s._v("FebsGatewayApplication")]),s._v("：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("@SpringBootApplication\npublic class FebsGatewayApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(FebsGatewayApplication.class, args);\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("接着在resources目录下新建"),e("code",[s._v("application.yml")]),s._v("配置文件，内容如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("server:\n  port: 8301\nspring:\n  application:\n    name: FEBS-Gateway\n  boot:\n    admin:\n      client:\n        url: http://${febs-monitor-admin}:8401\n        username: febs\n        password: 123456\n\neureka:\n  instance:\n    lease-renewal-interval-in-seconds: 20\n  client:\n    register-with-eureka: true\n    fetch-registry: true\n    instance-info-replication-interval-seconds: 30\n    registry-fetch-interval-seconds: 3\n    serviceUrl:\n      defaultZone: http://febs:123456@${febs-register}:8001/register/eureka/\n\nmanagement:\n  endpoint:\n    health:\n      show-details: ALWAYS\n  endpoints:\n    web:\n      exposure:\n        include: health,info,gateway\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br")])]),e("p",[s._v("上面配置文件定义了程序的端口为8301，应用名称为FEBS-Gateway，剩下的配置为Spring Boot Admin和Eureka的相关配置，在前面章节中已经介绍过了，这里就不再赘述了。准备好这些后，我们开始编写路由转发规则。")]),s._v(" "),e("h2",{attrs:{id:"转发规则"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#转发规则"}},[s._v("#")]),s._v(" 转发规则")]),s._v(" "),e("p",[s._v("Spring Cloud Gateway两大核心概念为："),e("strong",[s._v("谓词工厂")]),s._v("和"),e("strong",[s._v("过滤器工厂")]),s._v("，谓词工厂用于定义转发规则，过滤器工厂用于修改请求和响应。Spring Cloud Gateway内置的谓词工厂和过滤器工厂可以参考：https://cloud.spring.io/spring-cloud-gateway/reference/html/#gateway-request-predicates-factories和https://cloud.spring.io/spring-cloud-gateway/reference/html/#gatewayfilter-factories。")]),s._v(" "),e("blockquote",[e("p",[s._v("谓词其实是"),e("code",[s._v("Predicate")]),s._v("的中文翻译，是Java 8提供的一个函数式接口，简单来说就是传入一个条件，返回true或者false。")])]),s._v(" "),e("p",[s._v("了解了这些后，我们在febs-gateway模块的配置文件application.yml中添加如下配置：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("spring:\n  cloud:\n    gateway:\n      routes:\n        - id: FEBS-Auth\n          uri: lb://FEBS-Auth\n          predicates:\n            - Path=/auth/**\n          filters:\n            - StripPrefix=1\n        - id: FEBS-Server-System\n          uri: lb://FEBS-Server-System\n          predicates:\n            - Path=/system/**\n          filters:\n            - StripPrefix=1\n        - id: FEBS-Server-test\n          uri: lb://FEBS-Server-Test\n          predicates:\n            - Path=/test/**\n          filters:\n            - StripPrefix=1\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br")])]),e("p",[e("code",[s._v("spring.cloud.gateway.routes")]),s._v("定义了路由转发规则，配置含义如下：")]),s._v(" "),e("ol",[e("li",[e("code",[s._v("id")]),s._v("，路由ID，保持唯一即可；")]),s._v(" "),e("li",[e("code",[s._v("uri")]),s._v("，路由的目标地址，可以指定为HTTP地址，也可以通过"),e("code",[s._v("lb://{微服务名称}")]),s._v("来指定。"),e("code",[s._v("lb")]),s._v("为load balance的缩写，微服务名称为注册中心中对应的微服务名称。比如将uri配置为"),e("code",[s._v("lb://FEBS-Auth")]),s._v("的含义是，满足转发条件后，请求将均衡的转发到"),e("code",[s._v("FEBS-Auth")]),s._v("微服务上；")]),s._v(" "),e("li",[e("code",[s._v("predicates")]),s._v("就是上面所说的谓词工厂。值为"),e("code",[s._v("- Path=/auth/**")]),s._v("表示请求Path以"),e("code",[s._v("/auth")]),s._v("开头的都会被匹配，然后转发到"),e("code",[s._v("FEBS-Auth")]),s._v("服务上；")]),s._v(" "),e("li",[e("code",[s._v("filters")]),s._v("为过滤器工厂，配置为"),e("code",[s._v("- StripPrefix=1")]),s._v("的意思是，请求转发前，将Path的内容截去前面一位。比如"),e("code",[s._v("/auth/hello")]),s._v("会被截取为"),e("code",[s._v("/hello")]),s._v("。")])]),s._v(" "),e("p",[s._v("上面定义的三个路由转发规则都配置了下面这一段：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("filters:\n  - StripPrefix=1\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("我们可以通过"),e("code",[s._v("default-filters")]),s._v("来指定全局的过滤器，将上面的配置内容改为如下所示：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("spring:\n  cloud:\n    gateway:\n      routes:\n        - id: FEBS-Auth\n          uri: lb://FEBS-Auth\n          predicates:\n            - Path=/auth/**\n        - id: FEBS-Server-System\n          uri: lb://FEBS-Server-System\n          predicates:\n            - Path=/system/**\n        - id: FEBS-Server-test\n          uri: lb://FEBS-Server-Test\n          predicates:\n            - Path=/test/**\n      default-filters:\n        - StripPrefix=1\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("p",[s._v("配置好路由转发规则后，我们接着完善微服务网关。")]),s._v(" "),e("h2",{attrs:{id:"定义全局过滤器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#定义全局过滤器"}},[s._v("#")]),s._v(" 定义全局过滤器")]),s._v(" "),e("p",[s._v("在使用Zuul搭建的网关中，我们通过过滤器实现了一些功能，现在我们将这些功能移植到新的网关上。")]),s._v(" "),e("h3",{attrs:{id:"微服务防护"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#微服务防护"}},[s._v("#")]),s._v(" 微服务防护")]),s._v(" "),e("p",[s._v("在自定义Zuul过滤器中，我们在请求发送前获取了请求对象，并在请求对象头部添加了网关密钥，目标服务感知到这是从网关发送过来的请求。这样做可以防止客户端绕过网关，直接请求微服务。现在我们在Spring Cloud Gateway搭建的网关中也添加这个功能。")]),s._v(" "),e("p",[s._v("在Spring Cloud Gateway中定义全局过滤器很简单，只需要实现"),e("code",[s._v("org.springframework.cloud.gateway.filter.GlobalFilter")]),s._v("接口即可。在fesb-gateway模块的cc.mrbird.febs.gateway路径下新建filter包，然后在该包下新建"),e("code",[s._v("FebsGatewayRequestFilter")]),s._v("：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("@Slf4j\n@Component\npublic class FebsGatewayRequestFilter implements GlobalFilter {\n    @Override\n    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {\n        // 自定义逻辑\n        return chain.filter(exchange);\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("p",[s._v("在"),e("code",[s._v("filter")]),s._v("方法中，我们可以定义具体的业务逻辑，代码如下所示：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("@Slf4j\n@Component\npublic class FebsGatewayRequestFilter implements GlobalFilter {\n    @Override\n    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {\n        ServerHttpRequest request = exchange.getRequest();\n        ServerHttpResponse response = exchange.getResponse();\n\n        byte[] token = Base64Utils.encode((FebsConstant.ZUUL_TOKEN_VALUE).getBytes());\n        ServerHttpRequest build = request.mutate().header(FebsConstant.ZUUL_TOKEN_HEADER, new String(token)).build();\n        ServerWebExchange newExchange = exchange.mutate().request(build).build();\n        return chain.filter(newExchange);\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br")])]),e("p",[s._v("我们可以通过"),e("code",[s._v("ServerWebExchange")]),s._v("对象获取到"),e("code",[s._v("ServerHttpRequest")]),s._v("请求和"),e("code",[s._v("ServerHttpResponse")]),s._v("响应对象。通过"),e("code",[s._v("ServerHttpRequest")]),s._v("的"),e("code",[s._v("mutate")]),s._v("方法可以修改请求，在请求头部添加了之前定义的Zuul网关密钥（因为现在网关不再由Zuul构建，所以 这个常量的名字可以自己修改为别的，我这里就不修改了）。修改了"),e("code",[s._v("ServerHttpRequest")]),s._v("对象后，需要将它设置到"),e("code",[s._v("ServerWebExchange")]),s._v("对象中。同样的，我们可以调用"),e("code",[s._v("ServerWebExchange")]),s._v("的"),e("code",[s._v("mutate")]),s._v("方法来修改"),e("code",[s._v("ServerWebExchange")]),s._v("，然后将新的"),e("code",[s._v("ServerWebExchange")]),s._v("添加到"),e("code",[s._v("GatewayFilterChain")]),s._v("过滤器链中。")]),s._v(" "),e("h3",{attrs:{id:"定义禁止客户端访问资源"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#定义禁止客户端访问资源"}},[s._v("#")]),s._v(" 定义禁止客户端访问资源")]),s._v(" "),e("p",[s._v("在Zuul网关中，我们还在过滤器中实现了控制客户端禁止访问的资源功能，比如禁止客户端访问微服务的"),e("code",[s._v("/actuator/**")]),s._v("资源。")]),s._v(" "),e("p",[s._v("在febs-gateway模块的cc.mrbird.febs.gateway路径下新建properties包，然后创建"),e("code",[s._v("FebsGatewayProperties")]),s._v("：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@Data\n@SpringBootConfiguration\n@PropertySource(value = {"classpath:febs-gateway.properties"})\n@ConfigurationProperties(prefix = "febs.gateway")\npublic class FebsGatewayProperties {\n    /**\n     * 禁止外部访问的 URI，多个值的话以逗号分隔\n     */\n    private String forbidRequestUri;\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[s._v("接着在"),e("code",[s._v("FebsGatewayRequestFilter")]),s._v("过滤器中添加"),e("code",[s._v("checkForbidUri")]),s._v("方法：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@Slf4j\n@Component\npublic class FebsGatewayRequestFilter implements GlobalFilter {\n\n    @Autowired\n    private FebsGatewayProperties properties;\n    private AntPathMatcher pathMatcher = new AntPathMatcher();\n    \n    @Override\n    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {\n        ......\n    }\n\n    private Mono<Void> checkForbidUri(ServerHttpRequest request, ServerHttpResponse response) {\n        String uri = request.getPath().toString();\n        boolean shouldForward = true;\n        String forbidRequestUri = properties.getForbidRequestUri();\n        String[] forbidRequestUris = StringUtils.splitByWholeSeparatorPreserveAllTokens(forbidRequestUri, ",");\n        if (forbidRequestUris != null && ArrayUtils.isNotEmpty(forbidRequestUris)) {\n            for (String u : forbidRequestUris) {\n                if (pathMatcher.match(u, uri)) {\n                    shouldForward = false;\n                }\n            }\n        }\n        if (!shouldForward) {\n            FebsResponse febsResponse = new FebsResponse().message("该URI不允许外部访问");\n            return makeResponse(response, febsResponse);\n        }\n        return null;\n    }\n\n    private Mono<Void> makeResponse(ServerHttpResponse response, FebsResponse febsResponse) {\n        response.setStatusCode(HttpStatus.FORBIDDEN);\n        response.getHeaders().add(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_UTF8_VALUE);\n        DataBuffer dataBuffer = response.bufferFactory().wrap(JSONObject.toJSONString(febsResponse).getBytes());\n        return response.writeWith(Mono.just(dataBuffer));\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br")])]),e("p",[s._v("逻辑和之前Zuul中的一致，所以就不在赘述了。接着将这个方法添加到"),e("code",[s._v("filter")]),s._v("方法中：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("@Slf4j\n@Component\npublic class FebsGatewayRequestFilter implements GlobalFilter {\n\n    @Autowired\n    private FebsGatewayProperties properties;\n    private AntPathMatcher pathMatcher = new AntPathMatcher();\n\n    @Override\n    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {\n        ServerHttpRequest request = exchange.getRequest();\n        ServerHttpResponse response = exchange.getResponse();\n\n        // 禁止客户端的访问资源逻辑\n        Mono<Void> checkForbidUriResult = checkForbidUri(request, response);\n        if (checkForbidUriResult != null) {\n            return checkForbidUriResult;\n        }\n\n        byte[] token = Base64Utils.encode((FebsConstant.ZUUL_TOKEN_VALUE).getBytes());\n        ServerHttpRequest build = request.mutate().header(FebsConstant.ZUUL_TOKEN_HEADER, new String(token)).build();\n        ServerWebExchange newExchange = exchange.mutate().request(build).build();\n        return chain.filter(newExchange);\n    }\n\n    ......\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br")])]),e("h3",{attrs:{id:"打印转发日志"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#打印转发日志"}},[s._v("#")]),s._v(" 打印转发日志")]),s._v(" "),e("p",[s._v("我们还可以在过滤器中打印一些网关转发的日志，在"),e("code",[s._v("FebsGatewayRequestFilter")]),s._v("中添加"),e("code",[s._v("printLog")]),s._v("方法：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@Slf4j\n@Component\npublic class FebsGatewayRequestFilter implements GlobalFilter {\n\n    ......\n\n    private void printLog(ServerWebExchange exchange) {\n        URI url = exchange.getAttribute(GATEWAY_REQUEST_URL_ATTR);\n        Route route = exchange.getAttribute(GATEWAY_ROUTE_ATTR);\n        LinkedHashSet<URI> uris = exchange.getAttribute(GATEWAY_ORIGINAL_REQUEST_URL_ATTR);\n        URI originUri = null;\n        if (uris != null) {\n            originUri = uris.stream().findFirst().orElse(null);\n        }\n        if (url != null && route != null && originUri != null) {\n            log.info("转发请求：{}://{}{} --\x3e 目标服务：{}，目标地址：{}://{}{}，转发时间：{}",\n                    originUri.getScheme(), originUri.getAuthority(), originUri.getPath(),\n                    route.getId(), url.getScheme(), url.getAuthority(), url.getPath(), LocalDateTime.now()\n            );\n        }\n    }\n\n   ......\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br")])]),e("p",[e("code",[s._v("printLog")]),s._v("方法的主要逻辑是：通过"),e("code",[s._v("ServerWebExchange")]),s._v("对象的"),e("code",[s._v("getAttribute")]),s._v("方法获取各种信息，比如请求URI信息，路由信息等。可用的key值可以查看"),e("code",[s._v("ServerWebExchangeUtils")]),s._v("类中的属性值：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nxdnJI.png",alt:"307.png"}})]),s._v(" "),e("p",[s._v("至于通过属性获取到的对象是什么类型，可以通过Debug来查看。")]),s._v(" "),e("p",[s._v("接着将"),e("code",[s._v("printLog")]),s._v("添加到过滤器的"),e("code",[s._v("filter")]),s._v("方法中：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@Slf4j\n@Component\npublic class FebsGatewayRequestFilter implements GlobalFilter {\n\n    @Autowired\n    private FebsGatewayProperties properties;\n    private AntPathMatcher pathMatcher = new AntPathMatcher();\n\n    @Override\n    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {\n        ServerHttpRequest request = exchange.getRequest();\n        ServerHttpResponse response = exchange.getResponse();\n\n        // 禁止客户端的访问资源逻辑\n        Mono<Void> checkForbidUriResult = checkForbidUri(request, response);\n        if (checkForbidUriResult != null) {\n            return checkForbidUriResult;\n        }\n\n        //日志打印\n        printLog(exchange);\n\n        byte[] token = Base64Utils.encode((FebsConstant.ZUUL_TOKEN_VALUE).getBytes());\n        ServerHttpRequest build = request.mutate().header(FebsConstant.ZUUL_TOKEN_HEADER, new String(token)).build();\n        ServerWebExchange newExchange = exchange.mutate().request(build).build();\n        return chain.filter(newExchange);\n    }\n\n    private void printLog(ServerWebExchange exchange) {\n        URI url = exchange.getAttribute(GATEWAY_REQUEST_URL_ATTR);\n        Route route = exchange.getAttribute(GATEWAY_ROUTE_ATTR);\n        LinkedHashSet<URI> uris = exchange.getAttribute(GATEWAY_ORIGINAL_REQUEST_URL_ATTR);\n        URI originUri = null;\n        if (uris != null) {\n            originUri = uris.stream().findFirst().orElse(null);\n        }\n        if (url != null && route != null && originUri != null) {\n            log.info("转发请求：{}://{}{} --\x3e 目标服务：{}，目标地址：{}://{}{}，转发时间：{}",\n                    originUri.getScheme(), originUri.getAuthority(), originUri.getPath(),\n                    route.getId(), url.getScheme(), url.getAuthority(), url.getPath(), LocalDateTime.now()\n            );\n        }\n    }\n\n    ......\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br")])]),e("p",[s._v("到这里，我们需要在过滤器中添加的逻辑都完成了，启动febs-register、febs-gateway、febs-auth和febs-server-system模块，使用PostMan测试路由转发是否符合预期。（因为没有启动ELK环境，所以需要将各个模块的logback-spring.xml中配置的logstash的appender注释掉：）。")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nxuazn.png",alt:"306.png"}})]),s._v(" "),e("p",[s._v("在浏览器中输访问http://localhost:8301/auth/captcha?key=123，观察是否可以成功获取到验证码：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nxwPts.png",alt:"308.png"}})]),s._v(" "),e("p",[s._v("使用PostMan获取令牌：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nxwMN9.png",alt:"309.png"}})]),s._v(" "),e("p",[s._v("测试调用febs-server-system方法：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nxwIg0.png",alt:"310.png"}})]),s._v(" "),e("p",[s._v("可见访问都是正常的，和之前使用Zuul搭建的网关功能上没有区别。")]),s._v(" "),e("p",[s._v("观察febs-gateway模块的日志：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nx0CDO.png",alt:"311.png"}})]),s._v(" "),e("p",[s._v("使用浏览器访问http://localhost:8301/auth/actuator/health：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nx0VPA.png",alt:"312.png"}})]),s._v(" "),e("p",[s._v("使用PostMan发送"),e("a",{attrs:{href:"localhost:8201/info"}},[s._v("localhost:8201/info")]),s._v("请求：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nx0lVg.png",alt:"313.png"}})]),s._v(" "),e("p",[s._v("可以看到，我们在全局过滤器中添加的逻辑都已经生效。")]),s._v(" "),e("h2",{attrs:{id:"自定义异常处理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#自定义异常处理"}},[s._v("#")]),s._v(" 自定义异常处理")]),s._v(" "),e("p",[s._v("停止febs-auth模块，再次获取验证码：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nxRT7q.png",alt:"314.png"}})]),s._v(" "),e("p",[s._v("使用浏览器发送http://localhost:8301/xx/oo：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nxWCAx.png",alt:"315.png"}})]),s._v(" "),e("p",[s._v("Spring Cloud Gateway默认使用"),e("code",[s._v("DefaultErrorWebExceptionHandler")]),s._v("构建异常信息对象，该类的实现结构如下图所示:")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nxfLy4.png",alt:"316.png"}})]),s._v(" "),e("p",[s._v("在"),e("code",[s._v("ErrorWebFluxAutoConfiguration")]),s._v("配置类中，Spring Cloud Gateway通过下面这段代码注册了"),e("code",[s._v("DefaultErrorWebExceptionHandler")]),s._v("对象：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nxhntP.png",alt:"317.png"}})]),s._v(" "),e("p",[s._v("该Bean声明方法上，使用了"),e("code",[s._v("ConditionalOnMissingBean")]),s._v("注解标注，言外之意就是我们可以注册一个"),e("code",[s._v("ErrorWebExceptionHandler")]),s._v("类型的Bean来覆盖这段配置。")]),s._v(" "),e("p",[s._v("在febs-gateway模块的cc.mrbird.febs.gateway逻辑下新建handler包，然后在该包下新建"),e("code",[s._v("FebsGatewayExceptionHandler")]),s._v("：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@Slf4j\npublic class FebsGatewayExceptionHandler extends DefaultErrorWebExceptionHandler {\n\n    public FebsGatewayExceptionHandler(ErrorAttributes errorAttributes, ResourceProperties resourceProperties,\n                                       ErrorProperties errorProperties, ApplicationContext applicationContext) {\n        super(errorAttributes, resourceProperties, errorProperties, applicationContext);\n    }\n\n    /**\n     * 异常处理，定义返回报文格式\n     */\n    @Override\n    protected Map<String, Object> getErrorAttributes(ServerRequest request, boolean includeStackTrace) {\n        Throwable error = super.getError(request);\n        log.error(\n                "请求发生异常，请求URI：{}，请求方法：{}，异常信息：{}",\n                request.path(), request.methodName(), error.getMessage()\n        );\n        String errorMessage;\n        if (error instanceof NotFoundException) {\n            String serverId = StringUtils.substringAfterLast(error.getMessage(), "Unable to find instance for ");\n            serverId = StringUtils.replace(serverId, "\\"", StringUtils.EMPTY);\n            errorMessage = String.format("无法找到%s服务", serverId);\n        } else if (StringUtils.containsIgnoreCase(error.getMessage(), "connection refused")) {\n            errorMessage = "目标服务拒绝连接";\n        } else if (error instanceof TimeoutException) {\n            errorMessage = "访问服务超时";\n        } else if (error instanceof ResponseStatusException\n                && StringUtils.containsIgnoreCase(error.getMessage(), HttpStatus.NOT_FOUND.toString())) {\n            errorMessage = "未找到该资源";\n        } else {\n            errorMessage = "网关转发异常";\n        }\n        Map<String, Object> errorAttributes = new HashMap<>(3);\n        errorAttributes.put("message", errorMessage);\n        return errorAttributes;\n    }\n\n    @Override\n    @SuppressWarnings("all")\n    protected RouterFunction<ServerResponse> getRoutingFunction(ErrorAttributes errorAttributes) {\n        return RouterFunctions.route(RequestPredicates.all(), this::renderErrorResponse);\n    }\n\n    @Override\n    protected HttpStatus getHttpStatus(Map<String, Object> errorAttributes) {\n        return HttpStatus.INTERNAL_SERVER_ERROR;\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br")])]),e("p",[e("code",[s._v("FebsGatewayExceptionHandler")]),s._v("类的代码参考"),e("code",[s._v("DefaultErrorWebExceptionHandler")]),s._v("类的源码实现。在"),e("code",[s._v("getHttpStatus")]),s._v("方法中，我们定义了状态码为500（你也可以通过不同的异常类型来返回不同的状态码）；在"),e("code",[s._v("getErrorAttributes")]),s._v("方法中，我们根据异常的类型或者异常的错误信息来归类，构建了响应的异常信息对象。")]),s._v(" "),e("p",[s._v("创建好"),e("code",[s._v("FebsGatewayExceptionHandler")]),s._v("后，我们需要将它注册到IOC容器中。在febs-gateway模块的cc.mrbird.febs.gateway路径下新建configure包，然后在该包下新建"),e("code",[s._v("FebsGatewayErrorConfigure")]),s._v("异常配置类：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("@Configuration\npublic class FebsGatewayErrorConfigure {\n\n    private final ServerProperties serverProperties;\n    private final ApplicationContext applicationContext;\n    private final ResourceProperties resourceProperties;\n    private final List<ViewResolver> viewResolvers;\n    private final ServerCodecConfigurer serverCodecConfigurer;\n\n    public FebsGatewayErrorConfigure(ServerProperties serverProperties,\n                                     ResourceProperties resourceProperties,\n                                     ObjectProvider<List<ViewResolver>> viewResolversProvider,\n                                     ServerCodecConfigurer serverCodecConfigurer,\n                                     ApplicationContext applicationContext) {\n        this.serverProperties = serverProperties;\n        this.applicationContext = applicationContext;\n        this.resourceProperties = resourceProperties;\n        this.viewResolvers = viewResolversProvider.getIfAvailable(Collections::emptyList);\n        this.serverCodecConfigurer = serverCodecConfigurer;\n    }\n\n    @Bean\n    @Order(Ordered.HIGHEST_PRECEDENCE)\n    public ErrorWebExceptionHandler errorWebExceptionHandler(ErrorAttributes errorAttributes) {\n        FebsGatewayExceptionHandler exceptionHandler = new FebsGatewayExceptionHandler(\n                errorAttributes,\n                this.resourceProperties,\n                this.serverProperties.getError(),\n                this.applicationContext);\n        exceptionHandler.setViewResolvers(this.viewResolvers);\n        exceptionHandler.setMessageWriters(this.serverCodecConfigurer.getWriters());\n        exceptionHandler.setMessageReaders(this.serverCodecConfigurer.getReaders());\n        return exceptionHandler;\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br")])]),e("p",[s._v("该类代码参考"),e("code",[s._v("ErrorWebFluxAutoConfiguration")]),s._v("实现，主要逻辑是注册了"),e("code",[s._v("FebsGatewayExceptionHandler")]),s._v("Bean。")]),s._v(" "),e("p",[s._v("自定义异常处理编写好后，重新启动febs-gateway模块，使用浏览器访问http://localhost:8301/auth/captcha?key=123：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nxIPpV.png",alt:"318.png"}})]),s._v(" "),e("p",[s._v("接着使用浏览器访问：http://localhost:8301/xx/oo")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nxIufx.png",alt:"319.png"}})]),s._v(" "),e("p",[s._v("可以看到我们定义的异常处理已经生效了。")]),s._v(" "),e("h2",{attrs:{id:"熔断回退"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#熔断回退"}},[s._v("#")]),s._v(" 熔断回退")]),s._v(" "),e("p",[s._v("先来做个实验：以debug的方式启动febs-server-system模块，然后在febs-server-system模块"),e("code",[s._v("TestController")]),s._v("的"),e("code",[s._v("test")]),s._v("方法里打个断点：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nxopHH.png",alt:"320.png"}})]),s._v(" "),e("p",[s._v("然后使用PostMan发送"),e("a",{attrs:{href:"localhost:8301/system/info"}},[s._v("localhost:8301/system/info")]),s._v("请求：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nxoEgf.png",alt:"321.png"}})]),s._v(" "),e("p",[s._v("可以看到，PostMan会一直等待响应，并不会释放该请求。所以，假如我们没有在网关设置熔断，那么在高并发情况下网关很可能会被目标微服务的故障导致没有额外的线程资源来处理新的请求了。")]),s._v(" "),e("p",[s._v("要解决这个问题，我们可以在网关中加入Hystrix熔断处理。在febs-gateway模块的applicaiton.yml中的路由配置中添加Hystrix过滤器工厂：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("spring:\n  cloud:\n    gateway:\n      routes:\n        - id: FEBS-Auth\n          uri: lb://FEBS-Auth\n          predicates:\n            - Path=/auth/**\n          filters:\n            - name: Hystrix\n              args:\n                name: authfallback\n                fallbackUri: forward:/fallback/FEBS-Auth\n        - id: FEBS-Server-System\n          uri: lb://FEBS-Server-System\n          predicates:\n            - Path=/system/**\n          filters:\n            - name: Hystrix\n              args:\n                name: systemfallback\n                fallbackUri: forward:/fallback/FEBS-Server-System\n        - id: FEBS-Server-test\n          uri: lb://FEBS-Server-Test\n          predicates:\n            - Path=/test/**\n          filters:\n            - name: Hystrix\n              args:\n                name: testfallback\n                fallbackUri: forward:/fallback/FEBS-Server-Test\n      default-filters:\n        - StripPrefix=1\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br")])]),e("p",[s._v("以FEBS-Auth为例子：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(".......\n          filters:\n            - name: Hystrix\n              args:\n                name: authfallback\n                fallbackUri: forward:/fallback/FEBS-Server-Test\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("通过"),e("code",[s._v("- name: Hystrix")]),s._v("指定添加Hystrix过滤器，通过"),e("code",[s._v("name: authfallback")]),s._v("指定HystrixCommandKey为"),e("code",[s._v("authfallback")]),s._v("，"),e("code",[s._v("fallbackUri")]),s._v("指定了回退的重定向地址。")]),s._v(" "),e("p",[s._v("配置了Hystrix过滤器后，我们就可以添加超时时间了，在application.yml中添加全局超时时间：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("hystrix:\n  command:\n    default:\n      execution:\n        isolation:\n          thread:\n            timeoutInMilliseconds: 3000\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("如果要针对不同的路由设置不同的超时时间，可以按照"),e("code",[s._v("hystrix.command.HystrixCommandKey.execution.isolation.thread.timeoutinMilliseconds")]),s._v("格式配置。")]),s._v(" "),e("p",[s._v("接着定义处理回退的Controller。在febs-gateway模块的cc.mrbird.febs.gateway路径下新建"),e("code",[s._v("controller")]),s._v("包，然后在该包下新建"),e("code",[s._v("FallbackController")]),s._v("：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@RestController\npublic class FallbackController {\n\n    @RequestMapping("fallback/{name}")\n    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)\n    public Mono<FebsResponse> systemFallback(@PathVariable String name) {\n        String response = String.format("访问%s超时或者服务不可用", name);\n        return Mono.just(new FebsResponse().message(response));\n    }\n\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("p",[s._v("创建好回退方法后，重启febs-gateway模块，再次使用PostMan发送"),e("a",{attrs:{href:"localhost:8301/system/info"}},[s._v("localhost:8301/system/info")]),s._v("请求：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nxqSk4.png",alt:"322.png"}})]),s._v(" "),e("p",[s._v("通过接口耗时可以看到，这次3秒后没有响应就直接熔断了。")]),s._v(" "),e("h2",{attrs:{id:"跨域设置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#跨域设置"}},[s._v("#")]),s._v(" 跨域设置")]),s._v(" "),e("p",[s._v("在febs-gateway模块的cc.mrbird.febs.gateway.configure路径下新建"),e("code",[s._v("FebsGateWayCorsConfigure")]),s._v("配置类:")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('import org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.web.cors.CorsConfiguration;\nimport org.springframework.web.cors.reactive.CorsWebFilter;\nimport org.springframework.web.cors.reactive.UrlBasedCorsConfigurationSource;\nimport org.springframework.web.util.pattern.PathPatternParser;\n\n@Configuration\npublic class FebsGateWayCorsConfigure {\n\n    @Bean\n    public CorsWebFilter corsFilter() {\n        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource(new PathPatternParser());\n        CorsConfiguration cors = new CorsConfiguration();\n        cors.setAllowCredentials(true);\n        cors.addAllowedOrigin(CorsConfiguration.ALL);\n        cors.addAllowedHeader(CorsConfiguration.ALL);\n        cors.addAllowedMethod(CorsConfiguration.ALL);\n        source.registerCorsConfiguration("/**", cors);\n        return new CorsWebFilter(source);\n    }\n\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br")])]),e("p",[s._v("上面代码中我特意贴出了"),e("code",[s._v("import")]),s._v("部分的内容，配置的含义和在Zuul网关中定义的跨域配置一样，区别是"),e("code",[s._v("CorsWebFilter")]),s._v("等资源引用的都是"),e("code",[s._v("org.springframework.web.cors.reactive")]),s._v("路径下的。再次强调，Spirng Cloud Gateway不是基于Servlet，而是基于Reactive编程模型的WebFlux。")]),s._v(" "),e("h2",{attrs:{id:"资源限流"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#资源限流"}},[s._v("#")]),s._v(" 资源限流")]),s._v(" "),e("p",[s._v("截至目前为止，Spring Cloud Alibaba Sentinel控制台还不支持WebFlux编程模型，所以我们使用的是Sentinel提供的Spring Cloud Gateway适配依赖"),e("code",[s._v("sentinel-spring-cloud-gateway-adapter")]),s._v("。在febs-gateway模块的pom中添加该依赖：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("<dependency>\n    <groupId>com.alibaba.csp</groupId>\n    <artifactId>sentinel-spring-cloud-gateway-adapter</artifactId>\n    <version>1.6.3</version>\n</dependency>\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("然后在febs-gateway模块的cc.mrbird.febs.gateway.configure路径下新建"),e("code",[s._v("FebsGatewaySentinelConfigure")]),s._v("配置类:")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@Configuration\npublic class FebsGatewaySentinelConfigure {\n    private final List<ViewResolver> viewResolvers;\n    private final ServerCodecConfigurer serverCodecConfigurer;\n\n    public FebsGatewaySentinelConfigure(ObjectProvider<List<ViewResolver>> viewResolversProvider,\n                                        ServerCodecConfigurer serverCodecConfigurer) {\n        this.viewResolvers = viewResolversProvider.getIfAvailable(Collections::emptyList);\n        this.serverCodecConfigurer = serverCodecConfigurer;\n    }\n\n    @Bean\n    @Order(Ordered.HIGHEST_PRECEDENCE)\n    public SentinelGatewayBlockExceptionHandler sentinelGatewayBlockExceptionHandler() {\n        return new SentinelGatewayBlockExceptionHandler(viewResolvers, serverCodecConfigurer);\n    }\n\n    @Bean\n    @Order(-1)\n    public GlobalFilter sentinelGatewayFilter() {\n        return new SentinelGatewayFilter();\n    }\n\n    @PostConstruct\n    public void doInit() {\n        initGatewayRules();\n    }\n\n    private void initGatewayRules() {\n        Set<ApiDefinition> definitions = new HashSet<>();\n        Set<ApiPredicateItem> predicateItems = new HashSet<>();\n\n        predicateItems.add(new ApiPathPredicateItem().setPattern("/auth/captcha"));\n        ApiDefinition definition = new ApiDefinition("captcha")\n                .setPredicateItems(predicateItems);\n        definitions.add(definition);\n        GatewayApiDefinitionManager.loadApiDefinitions(definitions);\n\n        Set<GatewayFlowRule> rules = new HashSet<>();\n\n        rules.add(new GatewayFlowRule("captcha")\n                .setResourceMode(SentinelGatewayConstants.RESOURCE_MODE_CUSTOM_API_NAME)\n                .setParamItem(\n                        new GatewayParamFlowItem()\n                                .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)\n                                .setFieldName("key")\n                                .setMatchStrategy(SentinelGatewayConstants.PARAM_MATCH_STRATEGY_EXACT)\n                                .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_CLIENT_IP)\n                )\n                .setCount(10)\n                .setIntervalSec(60)\n        );\n        GatewayRuleManager.loadRules(rules);\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br")])]),e("p",[s._v("复制")]),s._v(" "),e("p",[s._v("上面配置和之前介绍的Sentinel验证码限流代码是一模一样的，所以这里就不再赘述配置的含义了，如果有不懂的地方可以复习下那一小节。")]),s._v(" "),e("p",[s._v("重启febs-gateway模块，使用浏览器快速地多次访问验证码获取请求，当访问到第11次的时候，浏览器输出如下所示:")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nxOeWd.png",alt:"323.png"}})]),s._v(" "),e("p",[s._v("可以看到，请求被限流了。但是返回的异常描述不太符合要求，我们查看febs-gateway的控制台，发现它抛出了"),e("code",[s._v("ParamFlowException")]),s._v("异常：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nxODTU.png",alt:"324.png"}})]),s._v(" "),e("p",[s._v("所以我们可以在"),e("code",[s._v("FebsGatewayExceptionHandler")]),s._v("中添加该类型的异常处理逻辑：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nxjE2d.png",alt:"325.png"}})]),s._v(" "),e("p",[s._v("重启febs-gateway，再次使用浏览器快速地多次访问验证码获取请求，当访问到第11次的时候，浏览器输出如下所示:")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nxjIRH.png",alt:"326.png"}})]),s._v(" "),e("p",[s._v("到这里我们已经成功将Zuul网关的功能使用Spring Cloud Gateway实现了。")])])}),[],!1,null,null,null);e.default=t.exports}}]);