(window.webpackJsonp=window.webpackJsonp||[]).push([[363],{712:function(s,a,n){"use strict";n.r(a);var e=n(0),t=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[a("a",{attrs:{href:"https://nacos.io/zh-cn/index.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Nacos"),a("OutboundLink")],1),s._v("是Alibaba提供的服务管理软件，可以无缝地和Spring Cloud结合，现已经整合到了Spring Cloud Alibaba模块中。这一节我们将使用Spring Cloud Alibaba Nacos来代替Spring Cloud Eureka。")]),s._v(" "),a("h2",{attrs:{id:"搭建nacos服务端"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#搭建nacos服务端"}},[s._v("#")]),s._v(" 搭建Nacos服务端")]),s._v(" "),a("p",[s._v("通过https://github.com/alibaba/nacos/releases链接可以下载Nacos的最新发行版，这里我们选择1.1.3版本的Nacos：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nzSGkV.png",alt:"327.png"}})]),s._v(" "),a("p",[s._v("下载后解压：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nzSLcQ.png",alt:"328.png"}})]),s._v(" "),a("p",[s._v("bin目录下为启动和关停脚本，conf下为nacos的配置文件，target目录下为nacos的fat jar。")]),s._v(" "),a("p",[s._v("修改conf/application.properties配置文件，将应用端口改为8001（和之前的febs-register端口一致）：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("server.port=8001\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("然后双击bin/startup.cmd启动nacos服务端：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nzQpp4.png",alt:"329.png"}})]),s._v(" "),a("p",[s._v("启动后使用浏览器访问：http://localhost:8001/nacos：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nzQu1H.png",alt:"330.png"}})]),s._v(" "),a("p",[s._v("用户名密码都为nacos：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nzQlnI.png",alt:"331.png"}})]),s._v(" "),a("p",[s._v("至此，nacos服务端启动成功。")]),s._v(" "),a("h2",{attrs:{id:"微服务整合nacos"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#微服务整合nacos"}},[s._v("#")]),s._v(" 微服务整合Nacos")]),s._v(" "),a("p",[s._v("在febs-cloud模块的pom中添加Spring Cloud Alibaba依赖管理：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('<?xml version="1.0" encoding="UTF-8"?>\n<project xmlns="http://maven.apache.org/POM/4.0.0"\n         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">\n    <modelVersion>4.0.0</modelVersion>\n\n    <groupId>cc.mrbird</groupId>\n    <artifactId>febs-cloud</artifactId>\n    <version>1.0-SNAPSHOT</version>\n    <packaging>pom</packaging>\n\n    <modules>\n        <module>../febs-common</module>\n        <module>../febs-auth</module>\n        <module>../febs-gateway</module>\n        <module>../febs-server</module>\n        <module>../febs-monitor</module>\n    </modules>\n\n    <name>FEBS-Cloud</name>\n    <description>FEBS-Cloud：Spring Cloud，Spring Security OAuth2 微服务权限管理系统</description>\n\n    <parent>\n        <groupId>org.springframework.boot</groupId>\n        <artifactId>spring-boot-starter-parent</artifactId>\n        <version>2.1.6.RELEASE</version>\n        <relativePath/> \x3c!-- lookup parent from repository --\x3e\n    </parent>\n\n    <properties>\n        <spring-cloud.version>Greenwich.SR1</spring-cloud.version>\n        <spring-cloud-alibaba.version>0.9.0.RELEASE</spring-cloud-alibaba.version>\n    </properties>\n\n    <dependencyManagement>\n        <dependencies>\n            <dependency>\n                <groupId>org.springframework.cloud</groupId>\n                <artifactId>spring-cloud-dependencies</artifactId>\n                <version>${spring-cloud.version}</version>\n                <type>pom</type>\n                <scope>import</scope>\n            </dependency>\n            <dependency>\n                <groupId>org.springframework.cloud</groupId>\n                <artifactId>spring-cloud-alibaba-dependencies</artifactId>\n                <version>${spring-cloud-alibaba.version}</version>\n                <type>pom</type>\n                <scope>import</scope>\n            </dependency>\n        </dependencies>\n    </dependencyManagement>\n\n</project>\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br")])]),a("p",[s._v("截至2019年9月21日18点41分，spring-cloud-alibaba-dependencies的最新版本为0.9.0.RELEASE：https://search.maven.org/artifact/org.springframework.cloud/spring-cloud-alibaba-dependencies/0.9.0.RELEASE/pom")]),s._v(" "),a("p",[s._v("然后删掉febs-register模块，并且删掉febs-common模块pom中的"),a("code",[s._v("spring-cloud-starter-netflix-eureka-client")]),s._v("依赖，添加"),a("code",[s._v("spring-cloud-starter-alibaba-nacos-discovery")]),s._v("依赖：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>\n</dependency>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("因为在febs-auth、febs-gateway、febs-server-system和febs-server-test模块中整合Nacos服务注册与发现的步骤是一样的，所以这里以febs-auth模块为例，剩下的模块照着操作就行。")]),s._v(" "),a("p",[s._v("首先删掉febs-auth模块application.yml中和Eureka相关的配置（下面这段）：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("eureka:\n  instance:\n    lease-renewal-interval-in-seconds: 20\n  client:\n    register-with-eureka: true\n    fetch-registry: true\n    instance-info-replication-interval-seconds: 30\n    registry-fetch-interval-seconds: 3\n    serviceUrl:\n      defaultZone: http://febs:123456@${febs-register}:8001/register/eureka/\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("然后在applicaiton.yml中添加Nacos配置：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("spring:\n  cloud:\n    nacos:\n      discovery:\n        server-addr: ${nacos.url}:8001\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("这段配置指定了刚刚启动的Nacos注册中心IP和端口，其中IP采用"),a("code",[s._v("${nacos.url}")]),s._v("指定，所以我们需要在IDEA环境变量中添加这个配置：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nz3djH.png",alt:"332.png"}})]),s._v(" "),a("p",[s._v("接着删除febs-auth启动类"),a("code",[s._v("FebsAuthApplication")]),s._v("上的"),a("code",[s._v("@EnableDiscoveryClient")]),s._v("注解，因为Nacos不需要这个注解也能开启服务注册与发现。")]),s._v(" "),a("p",[s._v("到这里febs-auth微服务已经整合好了Nacos注册中心，是不是很简单？剩下的febs-gateway、febs-server-system和febs-server-test参照着febs-auth整合方式整合即可。")]),s._v(" "),a("p",[s._v("febs-auth、febs-gateway、febs-server-system和febs-server-test四个微服务都整合好后，启动这几个微服务。在启动febs-gateway模块的时候发现控制台报错了：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("Description:\n\nAn attempt was made to call a method that does not exist. The attempt was made from the following location:\n\n    com.alibaba.csp.sentinel.adapter.gateway.common.rule.GatewayRuleManager$GatewayRulePropertyListener.applyToConvertedParamMap(GatewayRuleManager.java:207)\n\nThe following method did not exist:\n\n    com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowRuleUtil.buildParamRuleMap(Ljava/util/List;)Ljava/util/Map;\n\nThe method's class, com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowRuleUtil, is available from the following locations:\n\n    jar:file:/D:/Maven%20Repository/intellij/com/alibaba/csp/sentinel-parameter-flow-control/1.5.2/sentinel-parameter-flow-control-1.5.2.jar!/com/alibaba/csp/sentinel/slots/block/flow/param/ParamFlowRuleUtil.class\n\nIt was loaded from the following location:\n\n    file:/D:/Maven%20Repository/intellij/com/alibaba/csp/sentinel-parameter-flow-control/1.5.2/sentinel-parameter-flow-control-1.5.2.jar\n\n\nAction:\n\nCorrect the classpath of your application so that it contains a single, compatible version of com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowRuleUtil\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("p",[s._v("这是因为我们在febs-gateway模块中，引入了"),a("code",[s._v("sentinel-spring-cloud-gateway-adapter")]),s._v("依赖，版本为1.6.3，而"),a("code",[s._v("spring-cloud-alibaba-dependencies.0.9.0.RELEASE")]),s._v("中定义的sentinel版本还是1.5.2的：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nz3L2F.png",alt:"333.png"}})]),s._v(" "),a("p",[s._v("所以，解决办法是在febs-gateway模块的pom中，添加如下依赖来覆盖默认的版本：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("<dependency>\n    <groupId>com.alibaba.csp</groupId>\n    <artifactId>sentinel-core</artifactId>\n    <version>1.6.3</version>\n</dependency>\n<dependency>\n    <groupId>com.alibaba.csp</groupId>\n    <artifactId>sentinel-parameter-flow-control</artifactId>\n    <version>1.6.3</version>\n</dependency>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("添加后，重新启动febs-gateway模块即可。")]),s._v(" "),a("p",[s._v('微服务都启动好后，观察Nacos控制台的"服务列表"菜单：')]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nz8pUx.png",alt:"334.png"}})]),s._v(" "),a("p",[s._v("可以看到，我们的微服务都已经注册上了。")]),s._v(" "),a("p",[s._v("使用PostMan测试令牌获取：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nz8kxe.png",alt:"335.png"}})]),s._v(" "),a("p",[s._v("测试Feign调用：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/09/21/nz8nat.png",alt:"336.png"}})]),s._v(" "),a("p",[s._v("剩下的接口可以自己测试。")])])}),[],!1,null,null,null);a.default=t.exports}}]);