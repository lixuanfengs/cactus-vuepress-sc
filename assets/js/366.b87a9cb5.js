(window.webpackJsonp=window.webpackJsonp||[]).push([[366],{716:function(s,a,e){"use strict";e.r(a);var n=e(0),t=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[a("a",{attrs:{href:"http://skywalking.apache.org/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Skywalking"),a("OutboundLink")],1),s._v("是由国人吴晟开发的一款分布式追踪软件，后面成功孵化为Apache的顶级项目。Skywalking主要包括了分布式追踪、性能指标分析、应用和服务依赖分析等功能，使用体验后个人感觉比zipkin更为直观，是替代zipkin的一个不错的选择。")]),s._v(" "),a("p",[s._v("Skywalking的主要结构图如下所示:")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/10/20/Kutat0.png",alt:"384.png"}})]),s._v(" "),a("p",[s._v("从上图可以看出Skywalking主要分为四个模块：agent、collector、webapp-ui和storage。我们可以使用Skywalking agent探针无侵入地接入Spring Cloud应用，然后通过HTTP或者GRPC将应用数据采集到collector收集器。collector中的数据存储与storage，支持MySQL、H2、Elasticsearch等存储，最终这些数据集中在webapp-ui以图形化的方式呈现。")]),s._v(" "),a("h2",{attrs:{id:"搭建skywalking"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#搭建skywalking"}},[s._v("#")]),s._v(" 搭建Skywalking")]),s._v(" "),a("p",[s._v("这里我们选择在Vagrant搭建的Centos虚拟机中（我的IP为192.168.33.10）使用Docker Compose搭建Skywalking，数据存储我们选择性能更高的Elasticsearch，虽然我们之前在搭建ELK的时候已经部署过了Elasticsearch，但必须在之前的基础上添加一些Elasticsearch配置，否则会出现collector无法访问Elasticsearch的情况，所以这小节将重新搭建一个Elasticsearch数据库。")]),s._v(" "),a("p",[s._v("完整的docker-compose.yml如下所示：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('version: \'3\'\n\nservices:\n  elasticsearch:\n    image: elasticsearch:6.4.1\n    container_name: elasticsearch\n    restart: always\n    environment:\n      - cluster.name=elasticsearch\n      - xpack.security.enabled=false\n      - "ES_JAVA_OPTS=-Xms216m -Xmx216m"\n      - node.name=elasticsearch_node_1\n      - "TZ=Asia/Shanghai"\n    volumes:\n      - /febs/elasticsearch/data:/usr/share/elasticsearch/data\n      - /febs/elasticsearch/logs:/usr/share/elasticsearch/logs\n      - /febs/elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml\n    ports:\n      - 9200:9200\n      - 9300:9300\n\n  skywalking-oap:\n    image: apache/skywalking-oap-server:6.4.0\n    container_name: skywalking-oap\n    depends_on:\n      - elasticsearch\n    links:\n      - elasticsearch\n    restart: always\n    ports:\n      - 11800:11800\n      - 12800:12800\n    environment:\n      - "TZ=Asia/Shanghai"\n    volumes:\n      - /febs/skywalking/config:/apache-skywalking-apm-bin/config:ro\n\n  skywalking-ui:\n    image: apache/skywalking-ui:6.4.0\n    container_name: skywalking-ui\n    depends_on:\n      - skywalking-oap\n    links:\n      - skywalking-oap\n    restart: always\n    ports:\n      - 8080:8080\n    environment:\n      - "collector.ribbon.listOfServers=skywalking-oap:12800"\n      - "TZ=Asia/Shanghai"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br")])]),a("p",[s._v("上面部署了三个容器：Elasticsearch、skywalking-oap（即collector）和skywalking-ui（即webapp-ui）。")]),s._v(" "),a("p",[s._v("创建Elasticsearch的挂载目录和配置文件：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# 创建Elasticsearch的挂载目录\nmkdir -p /febs/elasticsearch/data /febs/elasticsearch/logs\n\n# 创建Elasticsearch的配置文件elasticsearch.yml\nvim /febs/elasticsearch/elasticsearch.yml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("配置文件elasticsearch.yml内容如下所示：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('http.host: 0.0.0.0\nhttp.cors.enabled: true\nhttp.cors.allow-origin: "*"\ntransport.host: 0.0.0.0\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("对Elasticsearch的挂载目录授予最高权限：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("chmod 777 -R /febs/elasticsearch\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("接着创建skywalking-oap的挂载目录和配置文件：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# 创建skywalking-oap的挂载目录\nmkdir -p /febs/skywalking/config\n\n# 创建skywalking-oap的配置文件skywalking.yml\ntouch /febs/skywalking/config/skywalking.yml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("skywalking.yml内容如下所示：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('# Licensed to the Apache Software Foundation (ASF) under one\n# or more contributor license agreements.  See the NOTICE file\n# distributed with this work for additional information\n# regarding copyright ownership.  The ASF licenses this file\n# to you under the Apache License, Version 2.0 (the\n# "License"); you may not use this file except in compliance\n# with the License.  You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an "AS IS" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\n\ncluster:\n  standalone:\n  # Please check your ZooKeeper is 3.5+, However, it is also compatible with ZooKeeper 3.4.x. Replace the ZooKeeper 3.5+\n  # library the oap-libs folder with your ZooKeeper 3.4.x library.\n#  zookeeper:\n#    nameSpace: ${SW_NAMESPACE:""}\n#    hostPort: ${SW_CLUSTER_ZK_HOST_PORT:localhost:2181}\n#    #Retry Policy\n#    baseSleepTimeMs: ${SW_CLUSTER_ZK_SLEEP_TIME:1000} # initial amount of time to wait between retries\n#    maxRetries: ${SW_CLUSTER_ZK_MAX_RETRIES:3} # max number of times to retry\n#  kubernetes:\n#    watchTimeoutSeconds: ${SW_CLUSTER_K8S_WATCH_TIMEOUT:60}\n#    namespace: ${SW_CLUSTER_K8S_NAMESPACE:default}\n#    labelSelector: ${SW_CLUSTER_K8S_LABEL:app=collector,release=skywalking}\n#    uidEnvName: ${SW_CLUSTER_K8S_UID:SKYWALKING_COLLECTOR_UID}\n#  consul:\n#    serviceName: ${SW_SERVICE_NAME:"SkyWalking_OAP_Cluster"}\n#     Consul cluster nodes, example: 10.0.0.1:8500,10.0.0.2:8500,10.0.0.3:8500\n#    hostPort: ${SW_CLUSTER_CONSUL_HOST_PORT:localhost:8500}\ncore:\n  default:\n    # Mixed: Receive agent data, Level 1 aggregate, Level 2 aggregate\n    # Aggregator: Level 2 aggregate\n    role: ${SW_CORE_ROLE:Mixed} # Mixed/Receiver/Aggregator\n    restHost: ${SW_CORE_REST_HOST:0.0.0.0}\n    restPort: ${SW_CORE_REST_PORT:12800}\n    restContextPath: ${SW_CORE_REST_CONTEXT_PATH:/}\n    gRPCHost: ${SW_CORE_GRPC_HOST:0.0.0.0}\n    gRPCPort: ${SW_CORE_GRPC_PORT:11800}\n    downsampling:\n      - Hour\n      - Day\n      - Month\n    # Set a timeout on metric data. After the timeout has expired, the metric data will automatically be deleted.\n    recordDataTTL: ${SW_CORE_RECORD_DATA_TTL:90} # Unit is minute\n    minuteMetricsDataTTL: ${SW_CORE_MINUTE_METRIC_DATA_TTL:90} # Unit is minute\n    hourMetricsDataTTL: ${SW_CORE_HOUR_METRIC_DATA_TTL:36} # Unit is hour\n    dayMetricsDataTTL: ${SW_CORE_DAY_METRIC_DATA_TTL:45} # Unit is day\n    monthMetricsDataTTL: ${SW_CORE_MONTH_METRIC_DATA_TTL:18} # Unit is month\nstorage:\n  elasticsearch:\n    # set the namespace in elasticsearch\n    clusterNodes: ${SW_STORAGE_ES_CLUSTER_NODES:elasticsearch:9200}\n    indexShardsNumber: ${SW_STORAGE_ES_INDEX_SHARDS_NUMBER:2}\n    indexReplicasNumber: ${SW_STORAGE_ES_INDEX_REPLICAS_NUMBER:0}\n    # Batch process setting, refer to https://www.elastic.co/guide/en/elasticsearch/client/java-api/5.5/java-docs-bulk-processor.html\n    bulkActions: ${SW_STORAGE_ES_BULK_ACTIONS:2000} # Execute the bulk every 2000 requests\n    bulkSize: ${SW_STORAGE_ES_BULK_SIZE:20} # flush the bulk every 20mb\n    flushInterval: ${SW_STORAGE_ES_FLUSH_INTERVAL:10} # flush the bulk every 10 seconds whatever the number of requests\n    concurrentRequests: ${SW_STORAGE_ES_CONCURRENT_REQUESTS:2} # the number of concurrent requests\n    metadataQueryMaxSize: ${SW_STORAGE_ES_QUERY_MAX_SIZE:5000}\n    segmentQueryMaxSize: ${SW_STORAGE_ES_QUERY_SEGMENT_SIZE:200}\n#  h2:\n#    driver: ${SW_STORAGE_H2_DRIVER:org.h2.jdbcx.JdbcDataSource}\n#    url: ${SW_STORAGE_H2_URL:jdbc:h2:mem:skywalking-oap-db}\n#    user: ${SW_STORAGE_H2_USER:sa}\n#    metadataQueryMaxSize: ${SW_STORAGE_H2_QUERY_MAX_SIZE:5000}\n#  mysql:\n#    metadataQueryMaxSize: ${SW_STORAGE_H2_QUERY_MAX_SIZE:5000}\nreceiver-sharing-server:\n  default:\nreceiver-register:\n  default:\nreceiver-trace:\n  default:\n    bufferPath: ${SW_RECEIVER_BUFFER_PATH:../trace-buffer/}  # Path to trace buffer files, suggest to use absolute path\n    bufferOffsetMaxFileSize: ${SW_RECEIVER_BUFFER_OFFSET_MAX_FILE_SIZE:100} # Unit is MB\n    bufferDataMaxFileSize: ${SW_RECEIVER_BUFFER_DATA_MAX_FILE_SIZE:500} # Unit is MB\n    bufferFileCleanWhenRestart: ${SW_RECEIVER_BUFFER_FILE_CLEAN_WHEN_RESTART:false}\n    sampleRate: ${SW_TRACE_SAMPLE_RATE:10000} # The sample rate precision is 1/10000. 10000 means 100% sample in default.\n    slowDBAccessThreshold: ${SW_SLOW_DB_THRESHOLD:default:200,mongodb:100} # The slow database access thresholds. Unit ms.\nreceiver-jvm:\n  default:\nservice-mesh:\n  default:\n    bufferPath: ${SW_SERVICE_MESH_BUFFER_PATH:../mesh-buffer/}  # Path to trace buffer files, suggest to use absolute path\n    bufferOffsetMaxFileSize: ${SW_SERVICE_MESH_OFFSET_MAX_FILE_SIZE:100} # Unit is MB\n    bufferDataMaxFileSize: ${SW_SERVICE_MESH_BUFFER_DATA_MAX_FILE_SIZE:500} # Unit is MB\n    bufferFileCleanWhenRestart: ${SW_SERVICE_MESH_BUFFER_FILE_CLEAN_WHEN_RESTART:false}\nistio-telemetry:\n  default:\nenvoy-metric:\n  default:\n# receiver_zipkin:\n#   default:\n#     host: ${SW_RECEIVER_ZIPKIN_HOST:0.0.0.0}\n#     port: ${SW_RECEIVER_ZIPKIN_PORT:9411}\n#     contextPath: ${SW_RECEIVER_ZIPKIN_CONTEXT_PATH:/}\nquery:\n  graphql:\n    path: ${SW_QUERY_GRAPHQL_PATH:/graphql}\nalarm:\n  default:\ntelemetry:\n  none:\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br"),a("span",{staticClass:"line-number"},[s._v("86")]),a("br"),a("span",{staticClass:"line-number"},[s._v("87")]),a("br"),a("span",{staticClass:"line-number"},[s._v("88")]),a("br"),a("span",{staticClass:"line-number"},[s._v("89")]),a("br"),a("span",{staticClass:"line-number"},[s._v("90")]),a("br"),a("span",{staticClass:"line-number"},[s._v("91")]),a("br"),a("span",{staticClass:"line-number"},[s._v("92")]),a("br"),a("span",{staticClass:"line-number"},[s._v("93")]),a("br"),a("span",{staticClass:"line-number"},[s._v("94")]),a("br"),a("span",{staticClass:"line-number"},[s._v("95")]),a("br"),a("span",{staticClass:"line-number"},[s._v("96")]),a("br"),a("span",{staticClass:"line-number"},[s._v("97")]),a("br"),a("span",{staticClass:"line-number"},[s._v("98")]),a("br"),a("span",{staticClass:"line-number"},[s._v("99")]),a("br"),a("span",{staticClass:"line-number"},[s._v("100")]),a("br"),a("span",{staticClass:"line-number"},[s._v("101")]),a("br"),a("span",{staticClass:"line-number"},[s._v("102")]),a("br"),a("span",{staticClass:"line-number"},[s._v("103")]),a("br"),a("span",{staticClass:"line-number"},[s._v("104")]),a("br"),a("span",{staticClass:"line-number"},[s._v("105")]),a("br"),a("span",{staticClass:"line-number"},[s._v("106")]),a("br"),a("span",{staticClass:"line-number"},[s._v("107")]),a("br"),a("span",{staticClass:"line-number"},[s._v("108")]),a("br"),a("span",{staticClass:"line-number"},[s._v("109")]),a("br"),a("span",{staticClass:"line-number"},[s._v("110")]),a("br"),a("span",{staticClass:"line-number"},[s._v("111")]),a("br")])]),a("p",[s._v("上面配置中，存储选择了Elasticsearch代替默认的H2，其他配置均为skywalking-oap的默认配置。")]),s._v(" "),a("p",[s._v("上面docker-compose.yml中我们通过"),a("code",[s._v("TZ=Asia/Shanghai")]),s._v("设置了时区，如果不指定时区的话默认是UTC时区，你会看到收集到的数据会比实际早8个小时。")]),s._v(" "),a("p",[s._v("在启动之前我们还需要通过"),a("code",[s._v("sysctl -w vm.max_map_count=262144")]),s._v("命令设置内存权限，"),a("code",[s._v("262144")]),s._v("是构建Elasticsearch的最小内存。")]),s._v(" "),a("p",[s._v("使用"),a("code",[s._v("docker-compose up -d")]),s._v("启动这几个容器：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/10/20/Kuw3ee.png",alt:"385.png"}})]),s._v(" "),a("p",[s._v("稍等片刻后，在浏览器中访问http://192.168.33.10:9200/地址，如下所示表示Elasticsearch已经启动成功：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/10/20/KuwhOU.png",alt:"386.png"}})]),s._v(" "),a("p",[s._v("接着访问Skywalking的UI界面：http://192.168.33.10:8080/")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/10/20/Ku0110.png",alt:"387.png"}})]),s._v(" "),a("p",[s._v("因为还没有整合agent所以现在还没有数据，界面是空的。")]),s._v(" "),a("h2",{attrs:{id:"spring-cloud应用整合skywalking"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#spring-cloud应用整合skywalking"}},[s._v("#")]),s._v(" Spring Cloud应用整合Skywalking")]),s._v(" "),a("p",[s._v("我们到http://skywalking.apache.org/downloads/地址下载Skywalking的压缩包：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/10/20/Ku0B1x.png",alt:"388.png"}})]),s._v(" "),a("p",[s._v("下载解压后将agent文件夹复制到桌面，agent文件夹下的内容如下所示:")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/10/20/KuBKbD.png",alt:"389.png"}})]),s._v(" "),a("p",[s._v("然后时候IDEA打开上一小节的源码，在febs-auth、febs-gateway、febs-server-system、febs-server-test和febs-monitor-admin的启动配置中添加Skywalking agent探针配置。以febs-auth为例子：点击IDEA的Edit Configurations...，然后选择Environment -> VM Options，添加如下脚本：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/10/20/KuB7xx.png",alt:"390.png"}})]),s._v(" "),a("p",[s._v("内容如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("-javaagent:C:\\Users\\wuyou\\Desktop\\agent\\skywalking-agent.jar\n-Dskywalking.agent.service_name=febs-auth\n-Dskywalking.collector.backend_service=192.168.33.10:11800\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("其中"),a("code",[s._v("-javaagent:C:\\Users\\wuyou\\Desktop\\agent\\skywalking-agent.jar")]),s._v("指定了探针应用agent的地址，即刚刚复制到桌面的agent文件夹下的skywalking-agent.jar应用；"),a("code",[s._v("-Dskywalking.agent.service_name=febs-auth")]),s._v("指定了被收集的应用名称为febs-auth；"),a("code",[s._v("-Dskywalking.collector.backend_service=192.168.33.10:11800")]),s._v("指定了收集器的地址，即刚刚我们使用Docker Compose构建的skywalking-oap。")]),s._v(" "),a("p",[s._v("剩下几个应用也照着febs-auth修改，只需要将"),a("code",[s._v("-Dskywalking.agent.service_name=")]),s._v("换成相对应的即可。")]),s._v(" "),a("p",[s._v("添加好启动参数后，启动febs-auth、febs-gateway、febs-server-system、febs-server-test和febs-monitor-admin，使用Postman获取令牌，然后多次发送http://localhost:8301/test/hello?name=夏天get请求：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/10/20/KuyO1A.png",alt:"391.png"}})]),s._v(" "),a("p",[s._v("回到Skywalking UI界面：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/10/20/Ku6eBV.png",alt:"392.png"}})]),s._v(" "),a("p",[s._v("查看拓扑图：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/10/20/Ku6UAO.png",alt:"393.png"}})]),s._v(" "),a("p",[s._v("请求链路追踪，选择刚刚访问的/hello接口：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/10/20/Ku6cHf.png",alt:"394.png"}})]),s._v(" "),a("p",[s._v("可以清晰的看到完整的请求调用链。查看一笔失败的调用，可以看到失败的具体异常堆栈：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/10/20/KucIiD.png",alt:"395.png"}})]),s._v(" "),a("p",[s._v("点击仪表盘页面的Service，可以看到一些服务相关的信息，如平均响应时间、平均吞吐量、平均时延统计，如下图所示：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/10/20/KugsTf.png",alt:"396.png"}})]),s._v(" "),a("p",[s._v("点击仪表盘页面的Endpoint，可以看到一些端点相关的信息，如下图所示：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/10/20/Ku2UEV.png",alt:"397.png"}})]),s._v(" "),a("p",[s._v("点击仪表盘页面的Instance，可以看到一些JVM相关的信息，如下图所示：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/10/20/Ku2d4U.png",alt:"398.png"}})]),s._v(" "),a("p",[s._v("在上方的选择下拉选也可以选择查看别的监控端点：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.ax1x.com/2019/10/20/Ku2cHx.png",alt:"399.png"}})]),s._v(" "),a("p",[s._v("至此，我们的微服务已经成功整合Skywalking。因为整合了Skywalking的agent，所以微服务的Dockerfile需要做出相应的调整，以febs-auth为例，其调整后的Dockerfile如下所示：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('FROM openjdk:8u212-jre\nMAINTAINER MrBird 852252810@qq.com\n\nCOPY febs-auth-1.0-SNAPSHOT.jar /febs/febs-auth-1.0-SNAPSHOT.jar\nADD agent/ /febs/sky-agent/agent\nENTRYPOINT ["java","-javaagent:/febs/sky-agent/agent/skywalking-agent.jar","-Dskywalking.agent.service_name=febs-auth","-Dskywalking.collector.backend_service=x.x.x.x:11800", "-Xmx256m", "-jar", "/febs/febs-auth-1.0-SNAPSHOT.jar"]\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])])])}),[],!1,null,null,null);a.default=t.exports}}]);