(window.webpackJsonp=window.webpackJsonp||[]).push([[370],{730:function(e,s,a){"use strict";a.r(s);var n=a(0),t=Object(n.a)({},(function(){var e=this,s=e._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("p",[e._v("Kubernetes从1.4版本开始后就引入了kubeadm用于简化集群搭建的过程，在Kubernetes 1.13版本中，kubeadm工具进入GA阶段，可用于生产环境Kubernetes集群搭建。本节将使用Kubeadm搭建Kubernetes1.16.2集群，宿主机使用9.1里搭建的master、node1、node2、node3四台虚拟机，即一主三从的K8S集群结构。")]),e._v(" "),s("h2",{attrs:{id:"安装准备"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装准备"}},[e._v("#")]),e._v(" 安装准备")]),e._v(" "),s("p",[e._v("在搭建K8S集群之前，我们需要对虚拟机进行一些操作。"),s("strong",[e._v("下面这些操作需要在master、node1、node2、node3四台虚拟机上执行，这里以master为例")]),e._v("。")]),e._v(" "),s("p",[s("strong",[e._v("1.安装必要软件")]),e._v("：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("yum install -y net-tools.x86_64 wget\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[s("strong",[e._v("2.配置hosts")]),e._v("：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("vi /etc/hosts\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("内容如下所示：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("192.168.33.11 master\n192.168.33.12 node1\n192.168.33.13 node2\n192.168.33.14 node3\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])]),s("p",[s("strong",[e._v("3.关闭防火墙")]),e._v("：")]),e._v(" "),s("p",[e._v("为了避免kubernetes的Master节点和各个工作节点的Node节点间的通信出现问题，我们可以关闭本地搭建的Centos虚拟机的防火墙。")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("systemctl disable firewalld\nsystemctl stop firewalld\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br")])]),s("p",[s("strong",[e._v("4.禁用SELinux，让容器可以顺利地读取主机文件系统")]),e._v("：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("setenforce 0\n\nsed -i 's/^SELINUX=enforcing$/SELINUX=disabled/' /etc/selinux/config\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br")])]),s("p",[s("strong",[e._v("5.修改Docker配置")]),e._v("：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("vi /etc/docker/daemon.json\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("在"),s("code",[e._v("{}")]),e._v("内追加如下内容：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('"exec-opts": ["native.cgroupdriver=systemd"]\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/07/Qtq6O0.png",alt:"537.png"}})]),e._v(" "),s("p",[e._v("重启docker：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("systemctl daemon-reload\nsystemctl restart docker\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br")])]),s("p",[s("strong",[e._v("6.将桥接的IPv4流量传递到iptables的链")]),e._v("：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("cat > /etc/sysctl.d/k8s.conf << EOF\n   net.bridge.bridge-nf-call-ip6tables = 1\n   net.bridge.bridge-nf-call-iptables = 1\nEOF\nsysctl --system\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br")])]),s("p",[s("strong",[e._v("7.关闭swap")])]),e._v(" "),s("p",[e._v("Swap是操作系统在内存吃紧的情况申请的虚拟内存，按照Kubernetes官网的说法，Swap会对Kubernetes的性能造成影响，不推荐使用Swap。")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('echo "vm.swappiness = 0">> /etc/sysctl.conf \nswapoff -a\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br")])]),s("h2",{attrs:{id:"安装kubeadm等工具"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装kubeadm等工具"}},[e._v("#")]),e._v(" 安装kubeadm等工具")]),e._v(" "),s("p",[e._v("准备工作完毕后，接着在master、node1、node2、node3四台虚拟机上安装kubeadm相关工具。"),s("strong",[e._v("下面这些操作需要在master、node1、node2、node3四台虚拟机上执行，这里以master为例")]),e._v("。")]),e._v(" "),s("p",[s("strong",[e._v("1.配置国内的kubernetes源")]),e._v("：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("cat <<EOF > /etc/yum.repos.d/kubernetes.repo\n\n[kubernetes]\nname=Kubernetes\nbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\n\nEOF\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br")])]),s("p",[s("strong",[e._v("2.安装kubelet、kubeadm和kubectl工具")]),e._v("：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[s("strong",[e._v("3.启动kubelet并设置开机自启")]),e._v("：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("systemctl enable kubelet && systemctl start kubelet\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("h2",{attrs:{id:"安装master"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装master"}},[e._v("#")]),e._v(" 安装Master")]),e._v(" "),s("p",[e._v("安装好kubeadm等相关工具后，接着在master虚拟机上执行以下操作：")]),e._v(" "),s("p",[e._v("使用下面这条命令启动master：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("kubeadm init --kubernetes-version=v1.16.2 \\\n--pod-network-cidr=10.244.0.0/16 \\\n--service-cidr=10.1.0.0/16 \\\n--apiserver-advertise-address=192.168.33.11 \\\n--image-repository registry.aliyuncs.com/google_containers\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br")])]),s("p",[e._v("配置含义如下：")]),e._v(" "),s("ul",[s("li",[e._v("kubernetes-version: 用于指定k8s版本，这里指定为最新的1.16.2版本；")]),e._v(" "),s("li",[e._v("apiserver-advertise-address：用于指定kube-apiserver监听的ip地址，就是master本机IP地址。")]),e._v(" "),s("li",[e._v("pod-network-cidr：因为后面我们选择flannel作为Pod的网络插件，所以这里需要指定Pod的网络范围为10.244.0.0/16")]),e._v(" "),s("li",[e._v("service-cidr：用于指定SVC的网络范围；")]),e._v(" "),s("li",[e._v("image-repository: 其中默认的镜像仓库k8s.gcr.io没有科学上网的话无法访问，我们可以将它修改为国内的阿里镜像仓库"),s("a",{attrs:{href:"https://www.kancloud.cn/mrbird/spring-cloud/registry.aliyuncs.com/google_containers",target:"_blank",rel:"noopener noreferrer"}},[e._v("registry.aliyuncs.com/google_containers"),s("OutboundLink")],1)])]),e._v(" "),s("p",[e._v("启动时，需要拉取镜像，过程比较缓慢耐心等待即可。如果你想先拉好镜像再启动，你可以使用"),s("code",[e._v("kubeadm config images list")]),e._v("命令列出需要拉取的镜像。")]),e._v(" "),s("p",[e._v("启动成功后，你会看到类似如下提示:")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('Your Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  mkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\nYou should now deploy a pod network to the cluster.\nRun "kubectl apply -f [podnetwork].yaml" with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join 192.168.33.11:6443 --token mqruxq.3t7wxduuui6v0b4f \\\n    --discovery-token-ca-cert-hash sha256:8d6ed21bfd24e3baf027fa00db65ab87aec9c78f9256a34080c13e7bbd84bc2b\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br")])]),s("p",[e._v("意思是，初始化成功，要开始使用K8S集群的话，需要执行以下命令：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("mkdir -p $HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nsudo chown $(id -u):$(id -g) $HOME/.kube/config\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br")])]),s("p",[e._v("而下面这段则是用于工作节点Node加入Master集群用的，后面会使用到：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("kubeadm join 192.168.33.11:6443 --token mqruxq.3t7wxduuui6v0b4f \\\n    --discovery-token-ca-cert-hash sha256:8d6ed21bfd24e3baf027fa00db65ab87aec9c78f9256a34080c13e7bbd84bc2b\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br")])]),s("h2",{attrs:{id:"安装node节点-加入集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装node节点-加入集群"}},[e._v("#")]),e._v(" 安装Node节点，加入集群")]),e._v(" "),s("p",[e._v("在node1、node2和node3节点上执行下面这条命令，加入Master：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("kubeadm join 192.168.33.11:6443 --token mqruxq.3t7wxduuui6v0b4f \\\n    --discovery-token-ca-cert-hash sha256:8d6ed21bfd24e3baf027fa00db65ab87aec9c78f9256a34080c13e7bbd84bc2b\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br")])]),s("p",[e._v("当输出如下内容是说明加入成功：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/07/QtXne0.png",alt:"538.png"}})]),e._v(" "),s("h2",{attrs:{id:"安装网络插件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装网络插件"}},[e._v("#")]),e._v(" 安装网络插件")]),e._v(" "),s("p",[e._v("在master上执行kubectl get nodes命令，会发现Kubernetes提示Master为NotReady状态，这是因为还没有安装网络插件：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/07/Qtx6X9.png",alt:"539.png"}})]),e._v(" "),s("p",[e._v("对于网络插件，可以有许多选择，请参考https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#pod-network的说明。这里我选择的flannel。")]),e._v(" "),s("p",[e._v("在master虚拟机上下载flannel配置文件：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("wget https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("修改kube-flannel.yml：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("vi kube-flannel.yml\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("修改的地方如下所示：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("......\ncontainers:\n      - name: kube-flannel\n        image: quay.io/coreos/flannel:v0.11.0-amd64\n        command:\n        - /opt/bin/flanneld\n        args:\n        - --ip-masq\n        - --kube-subnet-mgr\n        - --iface=eth1 # 新增部分\n......\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/09/Qwy12T.png",alt:"540.png"}})]),e._v(" "),s("p",[e._v("Vagrant 在多主机模式下有多个网卡，eth0 网卡用于nat转发访问公网，而eth1网卡才是主机真正的IP，在这种情况下直接部署k8s flannel 插件会导致CoreDNS无法工作，所以我们需要添加上面这条配置强制flannel使用eth1。")]),e._v(" "),s("p",[e._v("安装flannel：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("kubectl create -f kube-flannel.yml\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("输出如下所示时，表示安装成功：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/07/QNSKG8.png",alt:"541.png"}})]),e._v(" "),s("p",[e._v("稍等片刻后，再次查看节点状态：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("kubectl get nodes\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/07/QNStI0.png",alt:"542.png"}})]),e._v(" "),s("p",[e._v("可以看到所有节点都是Ready状态。")]),e._v(" "),s("p",[e._v("执行"),s("code",[e._v("kubectl get pods --all-namespaces")]),e._v("，验证Kubernetes集群的相关Pod是否都正常创建并运行：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/07/QNSwzF.png",alt:"543.png"}})]),e._v(" "),s("p",[e._v("到这里通过Kubeadm安装Kubernetes 1.16.2集群已经成功了。")])])}),[],!1,null,null,null);s.default=t.exports}}]);