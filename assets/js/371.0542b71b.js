(window.webpackJsonp=window.webpackJsonp||[]).push([[371],{722:function(s,n,e){"use strict";e.r(n);var a=e(0),t=Object(a.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[s._v("在K8S中，我们虽然可以使用volume将容器内目录挂载到宿主机目录上，但由于Pod调度的不确定性，这种数据存储方式是不牢靠的。对于有状态的应用，我们希望无论Pod被调度到哪个节点上，它们的数据总能够完整地恢复，这时候我们就不能用volume挂载了，而应该使用“网络共享存储”。")]),s._v(" "),n("p",[s._v("K8S支持众多类型的“网络共享存储”：https://kubernetes.io/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes。因为NFS类型存储演示起来方便，所以这里选择使用NFS作为存储提供者。")]),s._v(" "),n("h2",{attrs:{id:"搭建nfs"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#搭建nfs"}},[s._v("#")]),s._v(" 搭建NFS")]),s._v(" "),n("p",[s._v("登录nfs虚拟机，然后切换到root账户，执行以下命令：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 创建目录\nmkdir /nfs\n\n# 修改权限\nchmod 777 /nfs\n\n# 创建exports文件\nvi /etc/exports\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("exports内容如下所示：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/nfs *(rw,insecure,sync,no_subtree_check,no_root_squash)\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("让配置生效：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("exportfs -r\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("启动NFS：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("systemctl enable nfs\nsystemctl enable rpcbind\nsystemctl restart nfs\nsystemctl restart rpcbind\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h2",{attrs:{id:"测试nfs"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试nfs"}},[s._v("#")]),s._v(" 测试NFS")]),s._v(" "),n("p",[s._v("在master虚拟机的/home/vagrant目录下新建test-nfs.yml：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("apiVersion: v1\nkind: Pod\nmetadata:\n  name: test-nfs-pod\nspec:\n  containers:\n    - name: busybox\n      image: busybox\n      command:\n        - sh\n        - -c\n        - 'echo hello world > /mnt/hello'\n      imagePullPolicy: IfNotPresent\n      volumeMounts:\n        - mountPath: \"/mnt\"\n          name: nfs\n  volumes:\n    - name: nfs\n      nfs: # 使用NFS存储\n        path: /nfs # NFS存储路径\n        server: 192.168.33.15 # NFS服务器地址\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("p",[s._v("复制")]),s._v(" "),n("p",[s._v("上面busybox的逻辑就是将“hello world”写入/mnt/hello文件中，而/mnt目录和NFS挂载，所以理论上，nfs虚拟机的/nfs目录下也会有个hello文件。")]),s._v(" "),n("p",[s._v("创建后，运行"),n("code",[s._v("kubectl apply -f test-nfs.yml")]),s._v("：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/07/QNC2iq.png",alt:"544.png"}})]),s._v(" "),n("p",[s._v("回到nfs虚拟机，查看/nfs目录下是否有hello文件：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/07/QNPQkn.png",alt:"545.png"}})]),s._v(" "),n("p",[s._v("说明我们的NFS服务器搭建是成功的。测试成功后，可以删除hello文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rm -rf /nfs/hello\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("回到master虚拟机，执行以下命令删除刚刚的测试Pod：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("kubectl delete -f test-nfs.yml\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);