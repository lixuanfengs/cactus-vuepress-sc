(window.webpackJsonp=window.webpackJsonp||[]).push([[379],{729:function(s,n,a){"use strict";a.r(n);var e=a(0),t=Object(e.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"rocketmq简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#rocketmq简介"}},[s._v("#")]),s._v(" RocketMQ简介")]),s._v(" "),n("p",[s._v("目前流行的消息中间件如RabbitMQ、Kafka、RocketMQ等，只有RocketMQ支持事务消息。RocketMQ的事务消息模型借鉴了2PC模式，整个交互流程如下图所示：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lMlhss.png",alt:"662.png"}})]),s._v(" "),n("p",[s._v("图来自于http://rocketmq.apache.org/rocketmq/the-design-of-transactional-message。")]),s._v(" "),n("ol",[n("li",[s._v("事务发起方首先发送一条半消息到MQ；")]),s._v(" "),n("li",[s._v("MQ通知事务发起方，表示成功收到了这条半消息；")]),s._v(" "),n("li",[s._v("事务发起方执行本地事务；")]),s._v(" "),n("li",[s._v("根据本地事务执行结果向MQ反馈结果是commit或者是rollback，如果消息是rollback，MQ将删除该半消息不进行下发，如果是commit消息，MQ将会把这个消息发送给consumer端。")]),s._v(" "),n("li",[s._v("如果第4步没有成功反馈，MQ会发送状态回查确认；")]),s._v(" "),n("li",[s._v("事务发起方检查本地事务状态；")]),s._v(" "),n("li",[s._v("将第6步结果反馈给MQ。")])]),s._v(" "),n("h2",{attrs:{id:"rocketmq安装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#rocketmq安装"}},[s._v("#")]),s._v(" RocketMQ安装")]),s._v(" "),n("p",[s._v("因为截至2019年12月30日，org.apache.rocketmq:rocketmq-spring-boot-starter依赖的最新版本为2.0.4，其内部的RocketMQ版本为4.5.2，所以我们也下载这个版本的RocketMQ。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lMgfl4.png",alt:"663.png"}})]),s._v(" "),n("p",[s._v("下载地址：http://rocketmq.apache.org/dowloading/releases/，下载4.5.2 release Binary版本：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lMgImR.png",alt:"664.png"}})]),s._v(" "),n("p",[s._v("下载后解压，然后配置Windows环境变量：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lM2KA0.png",alt:"665.png"}})]),s._v(" "),n("p",[s._v("修改RocketMQ bin文件夹下的runbroker.cmd文件，修改内容如下图所示:")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lM2ovQ.png",alt:"666.png"}})]),s._v(" "),n("p",[s._v("然后在bin目录下执行CMD命令：")]),s._v(" "),n("p",[s._v("1.执行"),n("code",[s._v("start mqnamesrv.cmd")]),s._v("，启动NAMESERVER，页面弹出如下内容时，表示启动成功：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lMRTJK.png",alt:"667.png"}})]),s._v(" "),n("p",[s._v("2.执行"),n("code",[s._v("start mqbroker.cmd -n 127.0.0.1:9876 autoCreateTopicEnable=true")]),s._v("，启动BROKER：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lMWNY6.png",alt:"668.png"}})]),s._v(" "),n("p",[s._v("其中9876为RocketMQ默认端口号。这样RocketMQ就启动好了，Linux/Unix环境操作可以参考：http://rocketmq.apache.org/docs/quick-start/。")]),s._v(" "),n("h2",{attrs:{id:"项目准备"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#项目准备"}},[s._v("#")]),s._v(" 项目准备")]),s._v(" "),n("p",[s._v("项目的话我们接着使用8.7节的源码，不过需要适当的修改。")]),s._v(" "),n("p",[s._v("使用IDEA导入8.7节的源码。因为我们在8.6节引入了Skywalking微服务追踪功能，所以之前引入的Zipkin、Sleuth和RabbitMQ依赖就可以去掉了（个人觉得Skywalking比Zipkin强大）。删除febs-server pom下面这几个依赖：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-sleuth</artifactId>\n</dependency>\n<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-zipkin</artifactId>\n</dependency>\n<dependency>\n    <groupId>org.springframework.amqp</groupId>\n    <artifactId>spring-rabbit</artifactId>\n</dependency>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("因为我们删除了Zipkin、Sleuth和RabbitMQ依赖，所以我们需要修改Nacos中febs-server-system.yaml和febs-server-test.yaml的配置文件内容，将下面这段删除掉：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("spring:\n  zipkin:\n    sender:\n      type: rabbit\n  sleuth:\n    sampler:\n      probability: 1\n  rabbitmq:\n    host: ${rabbitmq.url}\n    port: 5672\n    username: febs\n    password: 123456\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("此外，因为后续需要在febs-server-test下操作数据库，所以"),n("strong",[s._v("去掉")]),s._v("febs-server-test.yaml中排除数据库自动装配的配置：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("spring:\n  autoconfigure:\n    exclude: org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration,com.baomidou.dynamic.datasource.spring.boot.autoconfigure.DynamicDataSourceAutoConfiguration\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("并添加数据源配置：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("spring:\n  datasource:\n    dynamic:\n      p6spy: true\n      hikari:\n        connection-timeout: 30000\n        max-lifetime: 1800000\n        max-pool-size: 15\n        min-idle: 5\n        connection-test-query: select 1\n        pool-name: FebsHikariCP\n      primary: base\n      datasource:\n        base:\n          username: root\n          password: 123456\n          driver-class-name: com.mysql.cj.jdbc.Driver\n          url: jdbc:mysql://${mysql.url}:3306/febs_cloud_base?useUnicode=true&characterEncoding=UTF-8&useJDBCCompliantTimezoneShift=true&useLegacyDatetimeCode=false&serverTimezone=GMT%2b8\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("添加MyBatis Plus配置：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("mybatis-plus:\n  type-aliases-package: cc.mrbird.febs.common.entity.system\n  mapper-locations: classpath:mapper/*/*.xml\n  configuration:\n    jdbc-type-for-null: null\n  global-config:\n    banner: false\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("在febs-server-test的启动类中添加Mapper扫描注解"),n("code",[s._v('@MapperScan("cc.mrbird.febs.server.test.mapper")')]),s._v("和事务控制注解"),n("code",[s._v("@EnableTransactionManagement")]),s._v("。")]),s._v(" "),n("p",[s._v("至此，Nacos中完整的febs-server-test.yaml内容如下所示：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('server:\n  port: 8202\n\nspring:\n  boot:\n    admin:\n      client:\n        url: http://${febs-monitor-admin}:8401\n        username: febs\n        password: 123456\n  datasource:\n    dynamic:\n      p6spy: true\n      hikari:\n        connection-timeout: 30000\n        max-lifetime: 1800000\n        max-pool-size: 15\n        min-idle: 5\n        connection-test-query: select 1\n        pool-name: FebsHikariCP\n      primary: base\n      datasource:\n        base:\n          username: root\n          password: 123456\n          driver-class-name: com.mysql.cj.jdbc.Driver\n          url: jdbc:mysql://${mysql.url}:3306/febs_cloud_base?useUnicode=true&characterEncoding=UTF-8&useJDBCCompliantTimezoneShift=true&useLegacyDatetimeCode=false&serverTimezone=GMT%2b8\n  autoconfigure:\n    exclude: org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration\n\nsecurity:\n  oauth2:\n    resource:\n      id: ${spring.application.name}\n      user-info-uri: http://${febs-gateway}:8301/auth/user\n\nfeign:\n  hystrix:\n    enabled: true\n\nhystrix:\n  shareSecurityContext: true\n\ninfo:\n  app:\n    name: ${spring.application.name}\n    description: "@project.description@"\n    version: "@project.version@"\n\nmanagement:\n  endpoints:\n    web:\n      exposure:\n        include: \'*\'\n  endpoint:\n    health:\n      show-details: ALWAYS\n\nmybatis-plus:\n  type-aliases-package: cc.mrbird.febs.common.entity.system\n  mapper-locations: classpath:mapper/*/*.xml\n  configuration:\n    jdbc-type-for-null: null\n  global-config:\n    banner: false\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br")])]),n("p",[s._v("复制")]),s._v(" "),n("p",[s._v("这节就先到这里了，下节开始使用RocketMQ事务消息解决分布式事务问题。")])])}),[],!1,null,null,null);n.default=t.exports}}]);