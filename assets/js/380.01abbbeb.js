(window.webpackJsonp=window.webpackJsonp||[]).push([[380],{732:function(e,s,a){"use strict";a.r(s);var n=a(0),r=Object(n.a)({},(function(){var e=this,s=e._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h2",{attrs:{id:"微服务引入rocketmq"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#微服务引入rocketmq"}},[e._v("#")]),e._v(" 微服务引入RocketMQ")]),e._v(" "),s("p",[e._v("在上一节源码的基础上，往febs-server的pom中添加RocketMQ依赖：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("<dependency>\n    <groupId>org.apache.rocketmq</groupId>\n    <artifactId>rocketmq-spring-boot-starter</artifactId>\n    <version>2.0.4</version>\n</dependency>\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br")])]),s("p",[e._v("接着在Nacos控制台上修改febs-server-system.yaml，添加RocketMQ配置:")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("rocketmq:\n  name-server: ${rocketmq.url}:9876\n  producer:\n    group: test-group\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])]),s("p",[e._v("上面配置中，我们使用"),s("code",[e._v("${rocketmq.url}")]),e._v("变量表示RocketMQ的地址，所以需要在IDEA的环境变量中添加"),s("code",[e._v("rocketmq.url=127.0.0.1")]),e._v("配置。")]),e._v(" "),s("p",[e._v("接着在Nacos的febs-server-test.yaml配置文件中也添加RocketMQ配置：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("rocketmq:\n  name-server: ${rocketmq.url}:9876\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br")])]),s("p",[e._v("同样的，别忘了在IDEA的环境变量中添加"),s("code",[e._v("rocketmq.url=127.0.0.1")]),e._v("。")]),e._v(" "),s("p",[e._v("接下来我们要实现如下所示的流程：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lMqZGj.png",alt:"669.png"}})]),e._v(" "),s("p",[e._v("febs-server-system往RocketMQ发送消息，febs-server-test消费这条消息，例子采用购物流程作为演示。")]),e._v(" "),s("p",[e._v("在febs_cloud_base数据库中添加购物日志表t_trade_log：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("CREATE TABLE `t_trade_log`  (\n  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'ID',\n  `goods_id` int(11) NOT NULL COMMENT '商品ID',\n  `goods_name` varchar(50) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT '商品名称',\n  `status` varchar(50) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT '状态',\n  `create_time` datetime(0) NOT NULL COMMENT '创建时间',\n  PRIMARY KEY (`id`) USING BTREE\n) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;\n\nSET FOREIGN_KEY_CHECKS = 1;\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br")])]),s("p",[e._v("在febs-common的cc.mrbird.febs.common.entity.system包下新建TradeLog实体类：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Data\n@TableName("t_trade_log")\npublic class TradeLog implements Serializable {\n\n    private static final long serialVersionUID = 3902838426348137002L;\n\n    @TableId(value = "ID", type = IdType.AUTO)\n    private Long id;\n\n    @TableField("GOODS_ID")\n    private String goodsId;\n    @TableField("GOODS_NAME")\n    private String goodsName;\n    @TableField("STATUS")\n    private String status;\n    @TableField("CREATE_TIME")\n    private Date createTime;\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br")])]),s("p",[e._v("接着在febs-server-test的cc.mrbird.febs.server.test.mapper和febs-server-system的cc.mrbird.febs.server.system.mapper包下新建TradeLogMapper接口：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("public interface TradeLogMapper extends BaseMapper<TradeLog> {\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br")])]),s("p",[e._v("在febs-server-system的cc.mrbird.febs.server.system.service下新建ITradeLogService接口：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("public interface ITradeLogService extends IService<TradeLog> {\n    void orderAndPay(TradeLog tradeLog);\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br")])]),s("p",[e._v("接口包含一个下单支付抽象方法。")]),e._v(" "),s("p",[e._v("在该目录下的impl包下新建该接口实现类TradeLogServiceImpl：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Slf4j\n@Service("tradeLogService")\npublic class TradeLogServiceImpl extends ServiceImpl<TradeLogMapper, TradeLog> implements ITradeLogService {\n\n    @Autowired\n    private RocketMQTemplate rocketMQTemplate;\n\n    @Override\n    @Transactional\n    public void orderAndPay(TradeLog tradeLog) {\n        tradeLog.setCreateTime(new Date());\n        tradeLog.setStatus("下单并支付成功");\n\n        // 保存支付日志\n        this.save(tradeLog);\n        log.info("用户已经下单并支付成功商品ID为{}，名称为{}的商品", tradeLog.getGoodsId(), tradeLog.getGoodsName());\n\n        // 往RocketMQ发送支付成功消息\n        this.rocketMQTemplate.convertAndSend("pay-success", tradeLog);\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br")])]),s("p",[e._v("RocketMQTemplate的"),s("code",[e._v("convertAndSend")]),e._v("的第一个参数相当于topic，消息主题，第二个参数为payload，即消息内容。")]),e._v(" "),s("p",[e._v("接着在febs-server-system的cc.mrbird.febs.server.system.controller包下的TestController类下新增如下方法：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Slf4j\n@RestController\npublic class TestController {\n\n    @Autowired\n    private ITradeLogService tradeLogService;\n\n   ...\n\n    @GetMapping("pay")\n    public void orderAndPay(TradeLog tradeLog) {\n        this.tradeLogService.orderAndPay(tradeLog);\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br")])]),s("p",[e._v("简单起见，我没有对TradeLog进行格式校验。")]),e._v(" "),s("p",[e._v("MQ消息发送方的工作完成后，接着在febs-server-test中添加MQ消息消费相关代码。")]),e._v(" "),s("p",[e._v("在febs-server-test的cc.mrbird.febs.server.test.service目录下新建ITradeLogService接口：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("public interface ITradeLogService extends IService<TradeLog> {\n    void packageAndSend(TradeLog tradeLog);\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br")])]),s("p",[e._v("接口包含一个打包配送抽象方法。")]),e._v(" "),s("p",[e._v("接着在该目录下新建impl包，然后在该包下新建该接口实现类TradeLogServiceImpl：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Slf4j\n@Service("tradeLogService")\npublic class TradeLogServiceImpl extends ServiceImpl<TradeLogMapper, TradeLog> implements ITradeLogService {\n\n    @Override\n    @Transactional\n    public void packageAndSend(TradeLog tradeLog) {\n        TradeLog tl = new TradeLog();\n        tl.setGoodsId(tradeLog.getGoodsId());\n        tl.setGoodsName(tradeLog.getGoodsName());\n        tl.setStatus("打包完毕，开始物流配送！");\n        tl.setCreateTime(new Date());\n\n        this.save(tl);\n        log.info("商品ID为{}，名称为{}的商品打包完毕，开始物流配送", tradeLog.getGoodsId(), tradeLog.getGoodsName());\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br")])]),s("p",[e._v("Service定义完后，还需要添加个RocketMQ消息监听器。在febs-server-test的cc.mrbird.febs.server.test目录下新建listener包，在该包下新建MyRocketMQListener：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Slf4j\n@Component\n@RocketMQMessageListener(consumerGroup = "test-group", topic = "pay-success")\npublic class MyRocketMQListener implements RocketMQListener<TradeLog> {\n\n    @Autowired\n    private ITradeLogService tradeLogService;\n\n    @Override\n    public void onMessage(TradeLog tradeLog) {\n        log.info("监听到用户已经下单并支付成功ID为{}，名称为{}的商品", tradeLog.getGoodsId(), tradeLog.getGoodsName());\n        this.tradeLogService.packageAndSend(tradeLog);\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br")])]),s("p",[e._v("该类实现了RocketMQListener接口，泛型为消息发送方的payload类型。"),s("code",[e._v("@RocketMQMessageListener")]),e._v("注解的"),s("code",[e._v("topic")]),e._v("必须和消息发送方的topic一致，即在febs-server-system中指定的"),s("code",[e._v("pay-success")]),e._v("。")]),e._v(" "),s("p",[e._v("启动febs-auth、febs-gateway、febs-server-system和febs-server-test服务，然后使用Postman发送测试请求（请求头部需要添加令牌，这里就不演示令牌获取了，前面章节介绍许多次了）：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lQA259.png",alt:"670.png"}})]),e._v(" "),s("p",[e._v("请求成功，查看febs-server-system日志：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("2019-12-30 16:38:50 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 p6spy 2019-12-30 16:38:50 | 耗时 3 ms | SQL 语句：\nINSERT INTO t_trade_log (CREATE_TIME, GOODS_ID, GOODS_NAME, STATUS) VALUES ('2019-12-30T16:38:50.018+0800', '1', 'Macbook Pro 16in', '下单并支付成功');\n2019-12-30 16:38:50 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 cc.mrbird.febs.server.system.service.impl.TradeLogServiceImpl 用户已经下单并支付成功商品ID为1，名称为Macbook Pro 16in的商品\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br")])]),s("p",[e._v("febs-server-test日志：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("2019-12-30 16:38:53 INFO  [FEBS-Server-Test,,,] ConsumeMessageThread_1 cc.mrbird.febs.server.test.listener.MyRocketMQListener 监听到用户已经下单并支付成功ID为1，名称为Macbook Pro 16in的商品\n2019-12-30 16:38:53 INFO  [FEBS-Server-Test,,,] ConsumeMessageThread_1 cc.mrbird.febs.server.test.service.impl.TradeLogServiceImpl 商品ID为1，名称为Macbook Pro 16in的商品打包完毕，开始物流配送\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br")])]),s("p",[e._v("查看数据库数据：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lQEKZF.png",alt:"671.png"}})]),e._v(" "),s("p",[e._v("可看到整个流程是没问题的。")]),e._v(" "),s("h2",{attrs:{id:"分布式事务问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#分布式事务问题"}},[e._v("#")]),e._v(" 分布式事务问题")]),e._v(" "),s("p",[e._v("在正常情况下，上述流程没有任何问题。但是实际业务中，可能消息发送方发完MQ消息后，后续处理抛了异常导致事务回滚了，但是MQ消息消费端还是能够检测到这条消息并消费，这就引起了分布式事务问题。")]),e._v(" "),s("p",[e._v("比如，在febs-server-system的TradeLogServiceImpl的orderAndPay方法中抛出一个异常：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Slf4j\n@Service("tradeLogService")\npublic class TradeLogServiceImpl extends ServiceImpl<TradeLogMapper, TradeLog> implements ITradeLogService {\n\n    @Autowired\n    private RocketMQTemplate rocketMQTemplate;\n\n    @Override\n    @Transactional\n    public void orderAndPay(TradeLog tradeLog) {\n        tradeLog.setCreateTime(new Date());\n        tradeLog.setStatus("下单并支付成功");\n\n        // 保存支付日志\n        this.save(tradeLog);\n        log.info("用户已经下单并支付成功商品ID为{}，名称为{}的商品", tradeLog.getGoodsId(), tradeLog.getGoodsName());\n\n        // 往RocketMQ发送支付成功消息\n        this.rocketMQTemplate.convertAndSend("pay-success", tradeLog);\n\n        throw new RuntimeException("抛个异常");\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br")])]),s("p",[e._v("重启febs-server-system，再次调用这个方法（参数改改）：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lQZMC9.png",alt:"672.png"}})]),e._v(" "),s("p",[e._v("可以看到，系统内部出异常了。从上面Service的逻辑来看，这个异常并不影响MQ消息的发送，但是会导致本地事务回滚。")]),e._v(" "),s("p",[e._v("所以查看febs-server-test的日志，肯定会看到消费了这条消息的相关日志:")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("2019-12-30 16:47:33 INFO  [FEBS-Server-Test,,,] ConsumeMessageThread_2 cc.mrbird.febs.server.test.listener.MyRocketMQListener 监听到用户已经下单并支付成功ID为2，名称为Iphone 11 Pro Max的商品\n2019-12-30 16:47:33 INFO  [FEBS-Server-Test,,,] ConsumeMessageThread_2 cc.mrbird.febs.server.test.service.impl.TradeLogServiceImpl 商品ID为2，名称为Iphone 11 Pro Max的商品打包完毕，开始物流配送\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br")])]),s("p",[e._v("查看数据库数据：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lQeBi4.png",alt:"673.png"}})]),e._v(" "),s("p",[e._v("可以看到，iPhone 11 Pro并没有下单成功，却已经开始打包配送了，这就引起了分布式事务问题。要解决这个问题，我们需要确保只有当下单和支付确定成功后，才开始打包配送。要完成这个过程，我们可以借助RocketMQ的事务消息来解决。")]),e._v(" "),s("h2",{attrs:{id:"解决分布式事务问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#解决分布式事务问题"}},[e._v("#")]),e._v(" 解决分布式事务问题")]),e._v(" "),s("p",[e._v("使用RocketMQ事务消息解决上述问题的实现过程可以参考下面这张图来完成：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lMlhss.png",alt:"662.png"}})]),e._v(" "),s("p",[s("strong",[e._v("第1步和第2步：向RocketMQ发送半消息（就是事务消息）")]),e._v("：")]),e._v(" "),s("p",[e._v("修改febs-server-service的ITradeLogService接口，添加一个pay抽象方法：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("public interface ITradeLogService extends IService<TradeLog> {\n\n    void orderAndPay(TradeLog tradeLog);\n\n    void pay(TradeLog tradeLog);\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br")])]),s("p",[e._v("修改其实现类TradeLogServiceImpl：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Slf4j\n@Service("tradeLogService")\npublic class TradeLogServiceImpl extends ServiceImpl<TradeLogMapper, TradeLog> implements ITradeLogService {\n\n    @Autowired\n    private RocketMQTemplate rocketMQTemplate;\n\n    @Override\n    public void orderAndPay(TradeLog tradeLog) {\n        // 检测库存\n        log.info("检测商品Id为{}，名称为{}的商品库存，库存充足",tradeLog.getGoodsId(),tradeLog.getGoodsName());\n\n        String transactionId = UUID.randomUUID().toString();\n        // 往RocketMQ发送事务消息\n        // this.rocketMQTemplate.convertAndSend("pay-success", tradeLog);\n        this.rocketMQTemplate.sendMessageInTransaction(\n                "pay-success-group", // 事务消息分组，组名\n                "pay-success", // 事务消息topic\n                MessageBuilder.withPayload(tradeLog)\n                        .setHeader(RocketMQHeaders.TRANSACTION_ID, transactionId)\n                        .build(), // 消息\n                tradeLog // 额外参数，供后续回调使用\n        );\n    }\n\n\n    @Override\n    @Transactional\n    public void pay(TradeLog tradeLog) {\n        tradeLog.setCreateTime(new Date());\n        tradeLog.setStatus("下单并支付成功");\n        // 保存支付日志\n        this.save(tradeLog);\n        log.info("用户已经下单并支付成功商品ID为{}，名称为{}的商品", tradeLog.getGoodsId(), tradeLog.getGoodsName());\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br"),s("span",{staticClass:"line-number"},[e._v("24")]),s("br"),s("span",{staticClass:"line-number"},[e._v("25")]),s("br"),s("span",{staticClass:"line-number"},[e._v("26")]),s("br"),s("span",{staticClass:"line-number"},[e._v("27")]),s("br"),s("span",{staticClass:"line-number"},[e._v("28")]),s("br"),s("span",{staticClass:"line-number"},[e._v("29")]),s("br"),s("span",{staticClass:"line-number"},[e._v("30")]),s("br"),s("span",{staticClass:"line-number"},[e._v("31")]),s("br"),s("span",{staticClass:"line-number"},[e._v("32")]),s("br"),s("span",{staticClass:"line-number"},[e._v("33")]),s("br"),s("span",{staticClass:"line-number"},[e._v("34")]),s("br"),s("span",{staticClass:"line-number"},[e._v("35")]),s("br"),s("span",{staticClass:"line-number"},[e._v("36")]),s("br")])]),s("p",[e._v("可以看到，在orderAndPay方法中，我们通过RocketMQTemplate的sendMessageInTransaction方法发送了一条半消息，但是并没有实际操作数据库，数据库操作过程抽出来放到了pay方法中。")]),e._v(" "),s("p",[e._v("半消息的特点是，在RocketMQ没有确认本地事务状态为COMMIT之前，消息的消费端并不会感知到这条消息，自然不会去消费。")]),e._v(" "),s("p",[e._v("那么我们要在什么地方调用TradeLogServiceImpl的pay方法呢？答案是在RocketMQLocalTransactionListener接口的实现类方法中。")]),e._v(" "),s("p",[s("strong",[e._v("第3步和第4步，执行本地事务，并且向RocketMQ发送Commit或者Rollback")]),e._v("。")]),e._v(" "),s("p",[e._v("在febs-server-system的cc.mrbird.febs.server.system目录下新建listener包，然后在该包下新建RocketMQLocalTransactionListener的实现类MyRocketMQListener：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Slf4j\n@Component\n@RocketMQTransactionListener(txProducerGroup = "pay-success-group")\npublic class MyRocketMQListener implements RocketMQLocalTransactionListener {\n\n    @Autowired\n    private ITradeLogService tradeLogService;\n\n    /**\n     * 执行本地事务\n     * @param message 消息\n     * @param o 额外参数\n     * @return RocketMQ事务状态\n     */\n    @Override\n    public RocketMQLocalTransactionState executeLocalTransaction(Message message, Object o) {\n        MessageHeaders headers = message.getHeaders();\n        String transicationId = (String) headers.get(RocketMQHeaders.TRANSACTION_ID);\n\n        try {\n            TradeLog tradeLog = (TradeLog) o;\n            this.tradeLogService.pay(tradeLog); // 对应图中第3步，执行本地事务\n            log.info("本地事务执行成功，往RocketMQ发送COMMIT");\n            return RocketMQLocalTransactionState.COMMIT; // 对应图中第4步，COMMIT，半消息经过COMMIT后，消息消费端就可以消费这条消息了\n        } catch (Exception e){\n            log.info("本地事务回滚，往RocketMQ发送ROLLBACK", e);\n            return RocketMQLocalTransactionState.ROLLBACK; // 对应途中第4步，ROLLBACK\n        }\n    }\n\n    /**\n     * RocketMQ回查本地事务状态\n     * @param message 消息\n     * @return RocketMQ事务状态\n     */\n    @Override\n    public RocketMQLocalTransactionState checkLocalTransaction(Message message) {\n        MessageHeaders headers = message.getHeaders();\n        String transicationId = (String) headers.get(RocketMQHeaders.TRANSACTION_ID);\n        log.info("RocketMQ事务状态回查");\n        // 这个过程对应图中第5步\n        // TODO\n        return null;\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br"),s("span",{staticClass:"line-number"},[e._v("24")]),s("br"),s("span",{staticClass:"line-number"},[e._v("25")]),s("br"),s("span",{staticClass:"line-number"},[e._v("26")]),s("br"),s("span",{staticClass:"line-number"},[e._v("27")]),s("br"),s("span",{staticClass:"line-number"},[e._v("28")]),s("br"),s("span",{staticClass:"line-number"},[e._v("29")]),s("br"),s("span",{staticClass:"line-number"},[e._v("30")]),s("br"),s("span",{staticClass:"line-number"},[e._v("31")]),s("br"),s("span",{staticClass:"line-number"},[e._v("32")]),s("br"),s("span",{staticClass:"line-number"},[e._v("33")]),s("br"),s("span",{staticClass:"line-number"},[e._v("34")]),s("br"),s("span",{staticClass:"line-number"},[e._v("35")]),s("br"),s("span",{staticClass:"line-number"},[e._v("36")]),s("br"),s("span",{staticClass:"line-number"},[e._v("37")]),s("br"),s("span",{staticClass:"line-number"},[e._v("38")]),s("br"),s("span",{staticClass:"line-number"},[e._v("39")]),s("br"),s("span",{staticClass:"line-number"},[e._v("40")]),s("br"),s("span",{staticClass:"line-number"},[e._v("41")]),s("br"),s("span",{staticClass:"line-number"},[e._v("42")]),s("br"),s("span",{staticClass:"line-number"},[e._v("43")]),s("br"),s("span",{staticClass:"line-number"},[e._v("44")]),s("br"),s("span",{staticClass:"line-number"},[e._v("45")]),s("br")])]),s("p",[e._v("类上使用"),s("code",[e._v("@RocketMQTransactionListener")]),e._v("注解标注，注解属性"),s("code",[e._v("txProducerGroup")]),e._v("值和前面发送的事务消息分组组名必须一致。")]),e._v(" "),s("p",[e._v("MyRocketMQListener实现了RocketMQLocalTransactionListener接口的"),s("code",[e._v("executeLocalTransaction")]),e._v("和"),s("code",[e._v("checkLocalTransaction")]),e._v("方法。顾名思义，"),s("code",[e._v("executeLocalTransaction")]),e._v("用于指定执行本地事务逻辑，"),s("code",[e._v("checkLocalTransaction")]),e._v("方法用于RocketMQ回查本地事务状态。")]),e._v(" "),s("p",[e._v("当监听器对应的半消息发送成功后，便会接着执行"),s("code",[e._v("executeLocalTransaction")]),e._v("方法；那么什么情况下RocketMQ会执行事务回查呢，答案是，当本地事务已经提交了，但是RocketMQ并未收到COMMIT确认时。就好比程序执行到上面"),s("code",[e._v("executeLocalTransaction")]),e._v("方法"),s("code",[e._v('log.info("本地事务执行成功，往RocketMQ发送COMMIT")')]),e._v("这一行代码，但还未来得及返回COMMIT状态时，网络突然中断或者程序故障，这种情况下，当网络和应用恢复正常后，RocketMQ会执行本地事务回查操作。")]),e._v(" "),s("p",[e._v("那么问题来了，我们要怎么回查本地的事务状态呢，通常的做法是创建一张事务日志表，在本地事务执行成功后，往本地事务日志表中也插入一条事务日志。事务回查时，只要通过transicationId能够找到对应的日志，则说明本地事务执行成功，否则认为执行失败。定义一张事务日志表：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("CREATE TABLE `t_transaction_log`  (\n  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'id',\n  `transaction_Id` varchar(50) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT '事务id',\n  `remark` varchar(50) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT '备注',\n  PRIMARY KEY (`id`, `transaction_Id`) USING BTREE\n) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;\n\nSET FOREIGN_KEY_CHECKS = 1;\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br")])]),s("p",[e._v("在febs-common的cc.mrbird.febs.common.entity.system模块下新建TransactionLog类：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Data\n@TableName("t_transaction_log")\npublic class TransactionLog implements Serializable {\n\n    private static final long serialVersionUID = 1268216478456291093L;\n\n    @TableId(value = "ID", type = IdType.AUTO)\n    private Long id;\n    @TableField("TRANSACTION_ID")\n    private String transactionId;\n    @TableField("REMARK")\n    private String remark;\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br")])]),s("p",[e._v("然后在febs-server-system的cc.mrbird.febs.server.system.mapper下新建TransactionLogMapper：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("public interface TransactionLogMapper extends BaseMapper<TransactionLog> {\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br")])]),s("p",[e._v("方便起见，我就不再创建TransactionLog的Service层了。修改febs-server-system模块的ITradeLogService接口：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("public interface ITradeLogService extends IService<TradeLog> {\n\n    void orderAndPay(TradeLog tradeLog);\n\n    void pay(TradeLog tradeLog, String transactionId);\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br")])]),s("p",[e._v("修改其实现类TradeLogServiceImpl：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Slf4j\n@Service("tradeLogService")\npublic class TradeLogServiceImpl extends ServiceImpl<TradeLogMapper, TradeLog> implements ITradeLogService {\n\n    @Autowired\n    private RocketMQTemplate rocketMQTemplate;\n    @Autowired\n    private TransactionLogMapper transactionLogMapper;\n\n    @Override\n    public void orderAndPay(TradeLog tradeLog) {\n\n        log.info("检测商品Id为{}，名称为{}的商品库存，库存充足", tradeLog.getGoodsId(), tradeLog.getGoodsName());\n\n        String transactionId = UUID.randomUUID().toString();\n        // 往RocketMQ发送事务消息\n        // this.rocketMQTemplate.convertAndSend("pay-success", tradeLog);\n        this.rocketMQTemplate.sendMessageInTransaction(\n                "pay-success-group", // 事务消息分组，组名\n                "pay-success", // 事务消息topic\n                MessageBuilder.withPayload(tradeLog)\n                        .setHeader(RocketMQHeaders.TRANSACTION_ID, transactionId)\n                        .build(), // 消息\n                tradeLog // 额外参数，供后续回调使用\n        );\n    }\n\n\n    @Override\n    @Transactional\n    public void pay(TradeLog tradeLog, String transactionId) {\n        tradeLog.setCreateTime(new Date());\n        tradeLog.setStatus("下单并支付成功");\n        // 保存支付日志\n        this.save(tradeLog);\n        log.info("用户已经下单并支付成功商品ID为{}，名称为{}的商品", tradeLog.getGoodsId(), tradeLog.getGoodsName());\n        // 记录事务日志\n        TransactionLog transactionLog = new TransactionLog();\n        transactionLog.setTransactionId(transactionId);\n        String remark = String.format("事务ID为%s的本地事务执行成功", transactionId);\n        transactionLog.setRemark(remark);\n        transactionLogMapper.insert(transactionLog);\n        log.info("事务ID为{}的本地事务执行成功", transactionId);\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br"),s("span",{staticClass:"line-number"},[e._v("24")]),s("br"),s("span",{staticClass:"line-number"},[e._v("25")]),s("br"),s("span",{staticClass:"line-number"},[e._v("26")]),s("br"),s("span",{staticClass:"line-number"},[e._v("27")]),s("br"),s("span",{staticClass:"line-number"},[e._v("28")]),s("br"),s("span",{staticClass:"line-number"},[e._v("29")]),s("br"),s("span",{staticClass:"line-number"},[e._v("30")]),s("br"),s("span",{staticClass:"line-number"},[e._v("31")]),s("br"),s("span",{staticClass:"line-number"},[e._v("32")]),s("br"),s("span",{staticClass:"line-number"},[e._v("33")]),s("br"),s("span",{staticClass:"line-number"},[e._v("34")]),s("br"),s("span",{staticClass:"line-number"},[e._v("35")]),s("br"),s("span",{staticClass:"line-number"},[e._v("36")]),s("br"),s("span",{staticClass:"line-number"},[e._v("37")]),s("br"),s("span",{staticClass:"line-number"},[e._v("38")]),s("br"),s("span",{staticClass:"line-number"},[e._v("39")]),s("br"),s("span",{staticClass:"line-number"},[e._v("40")]),s("br"),s("span",{staticClass:"line-number"},[e._v("41")]),s("br"),s("span",{staticClass:"line-number"},[e._v("42")]),s("br"),s("span",{staticClass:"line-number"},[e._v("43")]),s("br"),s("span",{staticClass:"line-number"},[e._v("44")]),s("br"),s("span",{staticClass:"line-number"},[e._v("45")]),s("br")])]),s("p",[e._v("主要修改地方为，在pay方法中添加了事务日志记录操作。")]),e._v(" "),s("p",[e._v("事务日志记录好了，接下来就得完善febs-server-system的MyRocketMQListener的事务回查方法checkLocalTransaction逻辑了：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Slf4j\n@Component\n@RocketMQTransactionListener(txProducerGroup = "pay-success-group")\npublic class MyRocketMQListener implements RocketMQLocalTransactionListener {\n\n    @Autowired\n    private ITradeLogService tradeLogService;\n    @Autowired\n    private TransactionLogMapper transactionLogMapper;\n\n    /**\n     * 执行本地事务\n     *\n     * @param message 消息\n     * @param o       额外参数\n     * @return RocketMQ事务状态\n     */\n    @Override\n    public RocketMQLocalTransactionState executeLocalTransaction(Message message, Object o) {\n        MessageHeaders headers = message.getHeaders();\n        String transicationId = (String) headers.get(RocketMQHeaders.TRANSACTION_ID);\n\n        try {\n            TradeLog tradeLog = (TradeLog) o;\n            this.tradeLogService.pay(tradeLog, transicationId); // 对应图中第3步，执行本地事务\n            log.info("本地事务执行成功，往RocketMQ发送COMMIT");\n            return RocketMQLocalTransactionState.COMMIT; // 对应图中第4步，COMMIT，半消息经过COMMIT后，消息消费端就可以消费这条消息了\n        } catch (Exception e) {\n            e.printStackTrace();\n            log.info("本地事务回滚，往RocketMQ发送ROLLBACK", e);\n            return RocketMQLocalTransactionState.ROLLBACK; // 对应途中第4步，ROLLBACK\n        }\n    }\n\n    /**\n     * RocketMQ回查本地事务状态，这个过程对应图中第5步\n     *\n     * @param message 消息\n     * @return RocketMQ事务状态\n     */\n    @Override\n    public RocketMQLocalTransactionState checkLocalTransaction(Message message) {\n        MessageHeaders headers = message.getHeaders();\n        String transicationId = (String) headers.get(RocketMQHeaders.TRANSACTION_ID);\n        log.info("RocketMQ事务状态回查");\n        // 从数据库中根据事务Id查询对应的事务日志，对应图中第6步\n        TransactionLog transactionLog = transactionLogMapper.selectOne(\n                new LambdaQueryWrapper<TransactionLog>().eq(TransactionLog::getTransactionId, transicationId)\n        );\n        // 对应图中的第7步骤\n        return transactionLog != null ? RocketMQLocalTransactionState.COMMIT : RocketMQLocalTransactionState.ROLLBACK;\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br"),s("span",{staticClass:"line-number"},[e._v("24")]),s("br"),s("span",{staticClass:"line-number"},[e._v("25")]),s("br"),s("span",{staticClass:"line-number"},[e._v("26")]),s("br"),s("span",{staticClass:"line-number"},[e._v("27")]),s("br"),s("span",{staticClass:"line-number"},[e._v("28")]),s("br"),s("span",{staticClass:"line-number"},[e._v("29")]),s("br"),s("span",{staticClass:"line-number"},[e._v("30")]),s("br"),s("span",{staticClass:"line-number"},[e._v("31")]),s("br"),s("span",{staticClass:"line-number"},[e._v("32")]),s("br"),s("span",{staticClass:"line-number"},[e._v("33")]),s("br"),s("span",{staticClass:"line-number"},[e._v("34")]),s("br"),s("span",{staticClass:"line-number"},[e._v("35")]),s("br"),s("span",{staticClass:"line-number"},[e._v("36")]),s("br"),s("span",{staticClass:"line-number"},[e._v("37")]),s("br"),s("span",{staticClass:"line-number"},[e._v("38")]),s("br"),s("span",{staticClass:"line-number"},[e._v("39")]),s("br"),s("span",{staticClass:"line-number"},[e._v("40")]),s("br"),s("span",{staticClass:"line-number"},[e._v("41")]),s("br"),s("span",{staticClass:"line-number"},[e._v("42")]),s("br"),s("span",{staticClass:"line-number"},[e._v("43")]),s("br"),s("span",{staticClass:"line-number"},[e._v("44")]),s("br"),s("span",{staticClass:"line-number"},[e._v("45")]),s("br"),s("span",{staticClass:"line-number"},[e._v("46")]),s("br"),s("span",{staticClass:"line-number"},[e._v("47")]),s("br"),s("span",{staticClass:"line-number"},[e._v("48")]),s("br"),s("span",{staticClass:"line-number"},[e._v("49")]),s("br"),s("span",{staticClass:"line-number"},[e._v("50")]),s("br"),s("span",{staticClass:"line-number"},[e._v("51")]),s("br"),s("span",{staticClass:"line-number"},[e._v("52")]),s("br"),s("span",{staticClass:"line-number"},[e._v("53")]),s("br")])]),s("p",[e._v("至此，上面图中的所有流程都完成了。重新启动febs-server-system模块，使用PostMan测试一波：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lQyPjs.png",alt:"675.png"}})]),e._v(" "),s("p",[e._v("查看febs-server-system日志:")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("2019-12-30 18:59:29 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 cc.mrbird.febs.server.system.service.impl.TradeLogServiceImpl 检测商品Id为3，名称为iPad mini 5的商品库存，库存充足\n2019-12-30 18:59:30 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 p6spy 2019-12-30 18:59:30 | 耗时 1 ms | SQL 语句：\nINSERT INTO t_trade_log (CREATE_TIME, GOODS_ID, GOODS_NAME, STATUS) VALUES ('2019-12-30T18:59:29.977+0800', '3', 'iPad mini 5', '下单并支付成功');\n2019-12-30 18:59:30 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 cc.mrbird.febs.server.system.service.impl.TradeLogServiceImpl 用户已经下单并支付成功商品ID为3，名称为iPad mini 5的商品\n2019-12-30 18:59:30 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 p6spy 2019-12-30 18:59:30 | 耗时 1 ms | SQL 语句：\nINSERT INTO t_transaction_log (REMARK, TRANSACTION_ID) VALUES ('事务ID为3090c2fc-0ab8-43e3-9667-2e98c1c036e8的本地事务执行成功', '3090c2fc-0ab8-43e3-9667-2e98c1c036e8');\n2019-12-30 18:59:30 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 cc.mrbird.febs.server.system.service.impl.TradeLogServiceImpl 事务ID为3090c2fc-0ab8-43e3-9667-2e98c1c036e8的本地事务执行成功\n2019-12-30 18:59:30 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 cc.mrbird.febs.server.system.listener.MyRocketMQListener 本地事务执行成功，往RocketMQ发送COMMIT\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br")])]),s("p",[e._v("查看febs-server-test日志：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("2019-12-30 18:59:31 INFO  [FEBS-Server-Test,,,] ConsumeMessageThread_1 cc.mrbird.febs.server.test.listener.MyRocketMQListener 监听到用户已经下单并支付成功ID为3，名称为iPad mini 5的商品\n2019-12-30 18:59:31 INFO  [FEBS-Server-Test,,,] ConsumeMessageThread_1 cc.mrbird.febs.server.test.service.impl.TradeLogServiceImpl 商品ID为3，名称为iPad mini 5的商品打包完毕，开始物流配送\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br")])]),s("p",[e._v("查看数据库：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lQsz4S.png",alt:"674.png"}})]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lQyagH.png",alt:"676.png"}})]),e._v(" "),s("p",[e._v("可以看到，当流程没有异常的时候，一切都是OK的，那么现在就模拟一个异常。在febs-server-system的TradeLogServiceImpl的pay方法中手动制造一个异常：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Override\n@Transactional\npublic void pay(TradeLog tradeLog, String transactionId) {\n    tradeLog.setCreateTime(new Date());\n    tradeLog.setStatus("下单并支付成功");\n    // 保存支付日志\n    this.save(tradeLog);\n    log.info("用户已经下单并支付成功商品ID为{}，名称为{}的商品", tradeLog.getGoodsId(), tradeLog.getGoodsName());\n    // 记录事务日志\n    TransactionLog transactionLog = new TransactionLog();\n    transactionLog.setTransactionId(transactionId);\n    String remark = String.format("事务ID为%s的本地事务执行成功", transactionId);\n    transactionLog.setRemark(remark);\n    transactionLogMapper.insert(transactionLog);\n    log.info("事务ID为{}的本地事务执行成功", transactionId);\n\n    throw new RuntimeException("抛个异常~");\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br")])]),s("p",[e._v("重启febs-server-system模块，重新使用Postman发送测试请求：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lQ6Bz4.png",alt:"677.png"}})]),e._v(" "),s("p",[e._v("febs-server-system日志：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("2019-12-30 19:08:59 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 cc.mrbird.febs.server.system.service.impl.TradeLogServiceImpl 检测商品Id为4，名称为Apple Watch Series 5的商品库存，库存充足\n2019-12-30 19:09:00 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 p6spy 2019-12-30 19:09:00 | 耗时 2 ms | SQL 语句：\nINSERT INTO t_trade_log (CREATE_TIME, GOODS_ID, GOODS_NAME, STATUS) VALUES ('2019-12-30T19:09:00.279+0800', '4', 'Apple Watch Series 5', '下单并支付成功');\n2019-12-30 19:09:00 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 cc.mrbird.febs.server.system.service.impl.TradeLogServiceImpl 用户已经下单并支付成功商品ID为4，名称为Apple Watch Series 5的商品\n2019-12-30 19:09:00 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 p6spy 2019-12-30 19:09:00 | 耗时 1 ms | SQL 语句：\nINSERT INTO t_transaction_log (REMARK, TRANSACTION_ID) VALUES ('事务ID为5d756122-e560-4ce4-a850-3e4721b3df95的本地事务执行成功', '5d756122-e560-4ce4-a850-3e4721b3df95');\n2019-12-30 19:09:00 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 cc.mrbird.febs.server.system.service.impl.TradeLogServiceImpl 事务ID为5d756122-e560-4ce4-a850-3e4721b3df95的本地事务执行成功\n2019-12-30 19:09:00 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 cc.mrbird.febs.server.system.listener.MyRocketMQListener 本地事务回滚，往RocketMQ发送ROLLBACK\njava.lang.RuntimeException: 抛个异常~\n\tat cc.mrbird.febs.server.system.service.impl.TradeLogServiceImpl.pay(TradeLogServiceImpl.java:67)\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br")])]),s("p",[e._v("可以看到，本地事务回滚了，并且成功向RocketMQ发送了ROLLBACK。")]),e._v(" "),s("p",[e._v("这时候查看febs-server-test日志，会发现并没有新的日志。查看数据库t_trade_log表发现并没有新的记录。")]),e._v(" "),s("p",[e._v("至此，我们已经成功通过RocketMQ的事务消息机制实现了分布式事务问题。")]),e._v(" "),s("p",[e._v("我们也可以模拟下RocketMQ事务回查的情况。将刚刚在febs-server-system的TradeLogServiceImpl的pay方法中的异常移除掉，以debug的方式启动febs-server-system，在MyRocketMQListener中打个断点：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lQT2Tg.png",alt:"678.png"}})]),e._v(" "),s("p",[e._v("使用Postman发送测试请求：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lQ2TOJ.png",alt:"679.png"}})]),e._v(" "),s("p",[e._v("方法已经走到了断点，febs-server-system日志输出如下：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("2019-12-30 20:16:22 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-4 cc.mrbird.febs.server.system.service.impl.TradeLogServiceImpl 检测商品Id为5，名称为AirPods Pro的商品库存，库存充足\n2019-12-30 20:16:23 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-4 p6spy 2019-12-30 20:16:23 | 耗时 3 ms | SQL 语句：\nINSERT INTO t_trade_log (CREATE_TIME, GOODS_ID, GOODS_NAME, STATUS) VALUES ('2019-12-30T20:16:23.608+0800', '5', 'AirPods Pro', '下单并支付成功');\n2019-12-30 20:16:23 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-4 cc.mrbird.febs.server.system.service.impl.TradeLogServiceImpl 用户已经下单并支付成功商品ID为5，名称为AirPods Pro的商品\n2019-12-30 20:16:23 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-4 p6spy 2019-12-30 20:16:23 | 耗时 0 ms | SQL 语句：\nINSERT INTO t_transaction_log (REMARK, TRANSACTION_ID) VALUES ('事务ID为a9cd4a44-d284-48d8-9abd-5ae911c4c2ad的本地事务执行成功', 'a9cd4a44-d284-48d8-9abd-5ae911c4c2ad');\n2019-12-30 20:16:23 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-4 cc.mrbird.febs.server.system.service.impl.TradeLogServiceImpl 事务ID为a9cd4a44-d284-48d8-9abd-5ae911c4c2ad的本地事务执行成功\n功\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br")])]),s("p",[e._v("这个时候还没有往RocketMQ发送COMMIT，所以febs-server-test自然不会去消费这笔消息。")]),e._v(" "),s("p",[e._v("在CMD中找到端口为8201（febs-server-system的端口）的进程并强制杀死：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lQ7WDK.png",alt:"680.png"}})]),e._v(" "),s("p",[e._v("回到IDEA可以看到febs-server-system已经被强制杀死了：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lQH6Ig.png",alt:"681.png"}})]),e._v(" "),s("p",[e._v("这个过程模拟的就是网络突然终端或者应用突然宕机时，RocketMQ没有收到事务状态确认消息的情况。")]),e._v(" "),s("p",[e._v("重新启动febs-server-system，稍等一段实际后，控制台日志打印如下：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("2019-12-30 20:26:05 INFO  [FEBS-Server-System,,,] pool-2-thread-1 cc.mrbird.febs.server.system.listener.MyRocketMQListener RocketMQ事务状态回查\n2019-12-30 20:26:05 INFO  [FEBS-Server-System,,,] pool-2-thread-1 p6spy 2019-12-30 20:26:05 | 耗时 0 ms | SQL 语句：\nSELECT ID, REMARK, TRANSACTION_ID FROM t_transaction_log WHERE (TRANSACTION_ID = 'a9cd4a44-d284-48d8-9abd-5ae911c4c2ad');\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br")])]),s("p",[e._v("查看febs-server-test日志：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("2019-12-30 20:26:05 INFO  [FEBS-Server-Test,,,] ConsumeMessageThread_5 cc.mrbird.febs.server.test.listener.MyRocketMQListener 监听到用户已经下单并支付成功ID为5，名称为AirPods Pro的商品\n2019-12-30 20:26:05 INFO  [FEBS-Server-Test,,,] ConsumeMessageThread_5 cc.mrbird.febs.server.test.service.impl.TradeLogServiceImpl 商品ID为5，名称为AirPods Pro的商品打包完毕，开始物流配送\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br")])]),s("p",[e._v("可以看到，消息已经成功被消费，数据库中的日志也是正常的：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/30/lQbwY4.png",alt:"682.png"}})]),e._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[e._v("#")]),e._v(" 总结")]),e._v(" "),s("p",[e._v("你可能会想，如果febs-server-test里的业务方法出现异常回滚了该怎么办？其实像febs-server-test这样的下游业务，一般都会有重试的机制，即使达到最大重试次数后，业务执行还是失败的话，可以执行后续的回退方法，比如退单等（我们已经通过事务消息避免了最糟糕的情况出现，比如用户下单失败却将商品发出的情况）。")]),e._v(" "),s("p",[e._v("由此场景我们也可以总结出基于消息的最终一致性方案的缺点是：事务一致性较弱，对代码的入侵较大；优点是代码难度较低，性能较高。")])])}),[],!1,null,null,null);s.default=r.exports}}]);