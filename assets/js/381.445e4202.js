(window.webpackJsonp=window.webpackJsonp||[]).push([[381],{735:function(s,n,e){"use strict";e.r(n);var a=e(0),r=Object(a.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"tx-lcn框架简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#tx-lcn框架简介"}},[s._v("#")]),s._v(" TX-LCN框架简介")]),s._v(" "),n("p",[s._v("TX-LCN由两大模块组成： TxClient（以下简称TC）和TxManager（以下简称TM）。TxClient作为模块的依赖框架，提供TX-LCN的标准支持，TxManager作为分布式事务的控制方。事务发起方或者参与方都由TxClient端来控制：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/31/l1DrUf.png",alt:"683.png"}})]),s._v(" "),n("p",[s._v("核心步骤：")]),s._v(" "),n("ol",[n("li",[s._v("创建事务组：是指在事务发起方开始执行业务代码之前先调用TxManager创建事务组对象，然后拿到事务标识GroupId的过程。")]),s._v(" "),n("li",[s._v("加入事务组：添加事务组是指参与方在执行完业务方法以后，将该模块的事务信息通知给TxManager的操作。")]),s._v(" "),n("li",[s._v("通知事务组：是指在发起方执行完业务代码以后，将发起方执行结果状态通知给TxManager，TxManager将根据事务最终状态和事务组的信息来通知相应的参与模块提交或回滚事务，并返回结果给事务发起方。")])]),s._v(" "),n("p",[s._v("以上内容摘抄自TX-LCN官网：http://www.txlcn.org/zh-cn/index.html。")]),s._v(" "),n("p",[s._v("TX-LCN支持三种模式：LCN模式、TCC模式和TXC模式，本节会对这三种模式分别作出演示。")]),s._v(" "),n("h2",{attrs:{id:"构建tm"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#构建tm"}},[s._v("#")]),s._v(" 构建TM")]),s._v(" "),n("p",[s._v("本节将在10.3节的源码（注意，是10.3节而不是10.4节，因为10.4节已经添加了RocketMQ相关代码）上继续编写代码。使用IDEA导入10.3节的源码（导入源码后，清空下febs_cloud_base和febs_nacos库表，重新执行febs-cloud目录下的febs_cloud_base.sql和febs_nacos.sql数据库脚本），然后点击IDEA -> File -> new Module...：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/31/l1rMRg.png",alt:"684.png"}})]),s._v(" "),n("p",[s._v("选择Spring Initilaizr，然后点击Next：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/31/l1rwz4.png",alt:"685.png"}})]),s._v(" "),n("p",[s._v("按照上图所示填写相关内容，然后点击Next。依赖选择先不选，直接点击Next：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/31/l1rqFf.png",alt:"686.png"}})]),s._v(" "),n("p",[s._v("调整项目目录，保持和febs-cloud模块平级，然后点击Finish即可，创建好后，项目层级如下所示：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/31/l1sCT0.png",alt:"687.png"}})]),s._v(" "),n("p",[s._v("修改febs-tx-manager模块的pom文件，修改后的内容如下所示：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('<?xml version="1.0" encoding="UTF-8"?>\n<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">\n    <modelVersion>4.0.0</modelVersion>\n    <parent>\n        <groupId>cc.mrbird</groupId>\n        <artifactId>febs-cloud</artifactId>\n        <version>1.0-SNAPSHOT</version>\n        <relativePath>../febs-cloud/pom.xml</relativePath>\n    </parent>\n\n    <artifactId>febs-tx-manager</artifactId>\n    <version>0.0.1-SNAPSHOT</version>\n    <name>febs-tx-manager</name>\n    <description>Demo project for Spring Boot</description>\n\n    <dependencies>\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-web</artifactId>\n        </dependency>\n        \x3c!-- redis相关依赖 --\x3e\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-data-redis</artifactId>\n        </dependency>\n        <dependency>\n            <groupId>org.apache.commons</groupId>\n            <artifactId>commons-pool2</artifactId>\n        </dependency>\n        \x3c!-- nacos config依赖 --\x3e\n        <dependency>\n            <groupId>com.alibaba.cloud</groupId>\n            <artifactId>spring-cloud-alibaba-nacos-config</artifactId>\n        </dependency>\n        \x3c!-- mysql驱动 --\x3e\n        <dependency>\n            <groupId>mysql</groupId>\n            <artifactId>mysql-connector-java</artifactId>\n            <scope>runtime</scope>\n        </dependency>\n        \x3c!-- tx-lcn manager依赖 --\x3e\n        <dependency>\n            <groupId>com.codingapi.txlcn</groupId>\n            <artifactId>txlcn-tm</artifactId>\n        </dependency>\n    </dependencies>\n\n    <build>\n        <plugins>\n            <plugin>\n                <groupId>org.springframework.boot</groupId>\n                <artifactId>spring-boot-maven-plugin</artifactId>\n            </plugin>\n        </plugins>\n    </build>\n</project>\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br")])]),n("p",[s._v("接着修改febs-cloud模块的pom文件，往里添加febs-tx-manager模块和TX-LCN相关依赖管理：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('<?xml version="1.0" encoding="UTF-8"?>\n<project xmlns="http://maven.apache.org/POM/4.0.0"\n         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">\n    <modelVersion>4.0.0</modelVersion>\n\n    <groupId>cc.mrbird</groupId>\n    <artifactId>febs-cloud</artifactId>\n    <version>1.0-SNAPSHOT</version>\n    <modules>\n        <module>../febs-common</module>\n        <module>../febs-auth</module>\n        <module>../febs-gateway</module>\n        <module>../febs-server</module>\n        <module>../febs-monitor</module>\n        <module>../febs-tx-manager</module>\n    </modules>\n    <packaging>pom</packaging>\n\n    <name>FEBS-Cloud</name>\n    <description>FEBS-Cloud：Spring Cloud，Spring Security OAuth2 微服务权限管理系统</description>\n\n    <parent>\n        <groupId>org.springframework.boot</groupId>\n        <artifactId>spring-boot-starter-parent</artifactId>\n        <version>2.2.0.RELEASE</version>\n        <relativePath/> \x3c!-- lookup parent from repository --\x3e\n    </parent>\n\n    <properties>\n        <spring-cloud.version>Hoxton.RELEASE</spring-cloud.version>\n        <com-alibaba-cloud.version>2.1.1.RELEASE</com-alibaba-cloud.version>\n        <codingapi.txlcn.version>5.0.2.RELEASE</codingapi.txlcn.version>\n    </properties>\n\n    <dependencyManagement>\n        <dependencies>\n            <dependency>\n                <groupId>org.springframework.cloud</groupId>\n                <artifactId>spring-cloud-dependencies</artifactId>\n                <version>${spring-cloud.version}</version>\n                <type>pom</type>\n                <scope>import</scope>\n            </dependency>\n            \x3c!-- 升级，替换为 com.alibaba.cloud --\x3e\n            <dependency>\n                <groupId>com.alibaba.cloud</groupId>\n                <artifactId>spring-cloud-alibaba-dependencies</artifactId>\n                <version>${com-alibaba-cloud.version}</version>\n                <type>pom</type>\n                <scope>import</scope>\n            </dependency>\n            \x3c!-- tx-lcn依赖管理 --\x3e\n            <dependency>\n                <groupId>com.codingapi.txlcn</groupId>\n                <artifactId>txlcn-tc</artifactId>\n                <version>${codingapi.txlcn.version}</version>\n            </dependency>\n            <dependency>\n                <groupId>com.codingapi.txlcn</groupId>\n                <artifactId>txlcn-tm</artifactId>\n                <version>${codingapi.txlcn.version}</version>\n            </dependency>\n            <dependency>\n                <groupId>com.codingapi.txlcn</groupId>\n                <artifactId>txlcn-txmsg-netty</artifactId>\n                <version>${codingapi.txlcn.version}</version>\n            </dependency>\n        </dependencies>\n    </dependencyManagement>\n</project>\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br")])]),n("p",[s._v("修改好后，点击Maven的刷新按钮刷新依赖即可。")]),s._v(" "),n("p",[s._v("回到febs-tx-manager，删除resources目录下的项目配置文件application.properties，新建bootstrap.yml文件，内容如下所示：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("spring:\n  application:\n    name: FEBS-TX-Manager\n  cloud:\n    nacos:\n      config:\n        server-addr: ${nacos.url}:8001\n        group: DEFAULT_GROUP\n        prefix: febs-tx-manager\n        file-extension: yaml\n\nlogging:\n  level:\n    com:\n      alibaba:\n        cloud:\n          nacos:\n            client:\n              NacosPropertySourceBuilder: error\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("p",[s._v("我们使用Nacos管理项目配置。在Nacos控制台上新建配置：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/31/l16coq.png",alt:"688.png"}})]),s._v(" "),n("p",[s._v("配置内容如下所示：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("server:\n  port: 8501\nspring:\n  datasource:\n    driver-class-name: com.mysql.cj.jdbc.Driver\n    url: jdbc:mysql://${mysql.url}:3306/febs_cloud_txmanager?useUnicode=true&characterEncoding=UTF-8&useJDBCCompliantTimezoneShift=true&useLegacyDatetimeCode=false&serverTimezone=GMT%2b8\n    username: root\n    password: 123456\n  redis:\n    database: 0\n    host: ${redis.url}\n    port: 6379\n    lettuce:\n      pool:\n        min-idle: 8\n        max-idle: 500\n        max-active: 2000\n        max-wait: 10000\n    timeout: 5000\n\ntx-lcn:\n  manager:\n    # TM监听Socket端口.\n    port: 8888\n    # TM控制台密码\n    admin-key: 123456\n  logger:\n    # 开启日志记录\n    enabled: true\n    driver-class-name: ${spring.datasource.driver-class-name}\n    jdbc-url: ${spring.datasource.url}\n    username: ${spring.datasource.username}\n    password: ${spring.datasource.password}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br")])]),n("p",[s._v("其中tx-lcn.manager开头的为TM相关配置，更多TM可用配置可以参考：http://www.txlcn.org/zh-cn/docs/setting/manager.html。")]),s._v(" "),n("p",[s._v("此外，我们还配置了MySQL和Redis地址，所以别忘了在IDEA环境变量中添加相关配置。")]),s._v(" "),n("p",[s._v("TM配置好后，接着新建一个名称为febs_cloud_txmanager的MySQL数据库，建表语句如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("CREATE TABLE `t_tx_exception`  (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `group_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL,\n  `unit_id` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL,\n  `mod_id` varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL,\n  `transaction_state` tinyint(4) NULL DEFAULT NULL,\n  `registrar` tinyint(4) NULL DEFAULT NULL,\n  `remark` varchar(4096) NULL DEFAULT  NULL,\n  `ex_state` tinyint(4) NULL DEFAULT NULL COMMENT '0 未解决 1已解决',\n  `create_time` datetime(0) NULL DEFAULT NULL,\n  PRIMARY KEY (`id`) USING BTREE\n) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci ROW_FORMAT = Dynamic;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("接着在febs-tx-manager的入口类FebsTxManagerApplication上添加"),n("code",[s._v("@EnableTransactionManagerServer")]),s._v("注解：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("@SpringBootApplication\n@EnableTransactionManagerServer\npublic class FebsTxManagerApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(FebsTxManagerApplication.class, args);\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("最后，在febs-tx-manager的resources目录下添加启动banner.txt文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("|------------------------------|\n|    ____  ____  ___   __      |\n|   | |_  | |_  | |_) ( (`     |\n|   |_|   |_|__ |_|_) _)_)     |\n|                              |\n|   ${spring.application.name}         |\n|   Spring-Boot: ${spring-boot.version} |\n|------------------------------|\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("日志配置logback-spring.xml：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('<?xml version="1.0" encoding="UTF-8"?>\n<configuration scan="true" scanPeriod="60 seconds" debug="false">\n    <contextName>febs</contextName>\n    <springProperty scope="context" name="springAppName" source="spring.application.name"/>\n    <property name="log.path" value="log/febs-tx-manager" />\n    <property name="log.maxHistory" value="15" />\n    <property name="log.colorPattern" value="%magenta(%d{yyyy-MM-dd HH:mm:ss}) %highlight(%-5level) %boldCyan([${springAppName:-},%X{X-B3-TraceId:-},%X{X-B3-SpanId:-},%X{X-Span-Export:-}]) %yellow(%thread) %green(%logger) %msg%n"/>\n    <property name="log.pattern" value="%d{yyyy-MM-dd HH:mm:ss} %-5level [${springAppName:-},%X{X-B3-TraceId:-},%X{X-B3-SpanId:-},%X{X-Span-Export:-}] %thread %logger %msg%n"/>\n\n    \x3c!--输出到控制台--\x3e\n    <appender name="console" class="ch.qos.logback.core.ConsoleAppender">\n        <encoder>\n            <pattern>${log.colorPattern}</pattern>\n        </encoder>\n    </appender>\n\n    \x3c!--输出到文件--\x3e\n    <appender name="file_info" class="ch.qos.logback.core.rolling.RollingFileAppender">\n        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">\n            <fileNamePattern>${log.path}/info/info.%d{yyyy-MM-dd}.log</fileNamePattern>\n            <MaxHistory>${log.maxHistory}</MaxHistory>\n        </rollingPolicy>\n        <encoder>\n            <pattern>${log.pattern}</pattern>\n        </encoder>\n        <filter class="ch.qos.logback.classic.filter.LevelFilter">\n            <level>INFO</level>\n            <onMatch>ACCEPT</onMatch>\n            <onMismatch>DENY</onMismatch>\n        </filter>\n    </appender>\n\n    <appender name="file_error" class="ch.qos.logback.core.rolling.RollingFileAppender">\n        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">\n            <fileNamePattern>${log.path}/error/error.%d{yyyy-MM-dd}.log</fileNamePattern>\n        </rollingPolicy>\n        <encoder>\n            <pattern>${log.pattern}</pattern>\n        </encoder>\n        <filter class="ch.qos.logback.classic.filter.LevelFilter">\n            <level>ERROR</level>\n            <onMatch>ACCEPT</onMatch>\n            <onMismatch>DENY</onMismatch>\n        </filter>\n    </appender>\n\n    <root level="debug">\n        <appender-ref ref="console" />\n    </root>\n\n    <root level="info">\n        <appender-ref ref="file_info" />\n        <appender-ref ref="file_error" />\n    </root>\n</configuration>\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br")])]),n("p",[s._v("启动该项目（再次提醒下，启动前别忘了在IDEA中添加相关环境变量），然后使用浏览器访问http://localhost:8501/：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/31/l12kQS.png",alt:"689.png"}})]),s._v(" "),n("p",[s._v("输入123456登录：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/31/l12uiq.png",alt:"690.png"}})]),s._v(" "),n("p",[s._v("因为还没有TC，所以TC数量为0。")]),s._v(" "),n("h2",{attrs:{id:"搭建tc"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#搭建tc"}},[s._v("#")]),s._v(" 搭建TC")]),s._v(" "),n("p",[s._v("在febs-server模块的pom中添加TX-LCN相关依赖：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\x3c!-- TC依赖 --\x3e\n<dependency>\n    <groupId>com.codingapi.txlcn</groupId>\n    <artifactId>txlcn-tc</artifactId>\n</dependency>\n\x3c!-- TC和TM通信依赖于Netty --\x3e\n<dependency>\n    <groupId>com.codingapi.txlcn</groupId>\n    <artifactId>txlcn-txmsg-netty</artifactId>\n</dependency>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("然后在Nacos中的febs-server-test.yaml和febs-server-system.yaml配置文件中都添加如下依赖，用于指定TM地址：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("tx-lcn:\n  client:\n    manager-address: ${febs-tx-manager}:8888\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("更多TC的可用配置可以参考：http://www.txlcn.org/zh-cn/docs/setting/client.html。")]),s._v(" "),n("p",[s._v("其中${febs-tx-manager}为刚刚创建的TM地址变量，所以需要在IDEA环境变量中添加该变量：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/31/l1R0Nn.png",alt:"691.png"}})]),s._v(" "),n("p",[s._v("接着在febs-server-test和febs-server-system的入口类上都添加"),n("code",[s._v("@EnableDistributedTransaction")]),s._v("注解，用于开启分布式事务控制。")]),s._v(" "),n("p",[s._v("至此，TC端已经准备完毕了。")]),s._v(" "),n("h2",{attrs:{id:"lcn模式分布式事务控制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#lcn模式分布式事务控制"}},[s._v("#")]),s._v(" LCN模式分布式事务控制")]),s._v(" "),n("p",[s._v("在febs_cloud_base数据库中新建一张交易日志表：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("CREATE TABLE `t_trade_log`  (\n  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'ID',\n  `goods_id` int(11) NOT NULL COMMENT '商品ID',\n  `goods_name` varchar(50) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT '商品名称',\n  `status` varchar(50) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT '状态',\n  `create_time` datetime(0) NOT NULL COMMENT '创建时间',\n  PRIMARY KEY (`id`) USING BTREE\n) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;\n\nSET FOREIGN_KEY_CHECKS = 1;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("在febs-common的cc.mrbird.febs.common.entity.system包下新建TradeLog实体类：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Data\n@TableName("t_trade_log")\npublic class TradeLog implements Serializable {\n\n    private static final long serialVersionUID = 3902838426348137002L;\n\n    @TableId(value = "ID", type = IdType.AUTO)\n    private Long id;\n\n    @TableField("GOODS_ID")\n    private String goodsId;\n    @TableField("GOODS_NAME")\n    private String goodsName;\n    @TableField("STATUS")\n    private String status;\n    @TableField("CREATE_TIME")\n    private Date createTime;\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("接着在febs-server-test的cc.mrbird.febs.server.test.mapper和febs-server-system的cc.mrbird.febs.server.system.mapper包下新建TradeLogMapper接口：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("public interface TradeLogMapper extends BaseMapper<TradeLog> {\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("在febs-server-system的cc.mrbird.febs.server.system.service下新建ITradeLogService接口：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("public interface ITradeLogService extends IService<TradeLog> {\n    void orderAndPay(TradeLog tradeLog);\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("接口包含一个下单支付抽象方法。")]),s._v(" "),n("p",[s._v("在该目录下的impl包下新建该接口实现类TradeLogServiceImpl：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Slf4j\n@Service("tradeLogService")\npublic class TradeLogServiceImpl extends ServiceImpl<TradeLogMapper, TradeLog> implements ITradeLogService {\n\n    @Override\n    @LcnTransaction\n    public void orderAndPay(TradeLog tradeLog) {\n        tradeLog.setCreateTime(new Date());\n        tradeLog.setStatus("下单并支付成功");\n\n        // 保存支付日志\n        this.save(tradeLog);\n        log.info("用户已经下单并支付成功商品ID为{}，名称为{}的商品", tradeLog.getGoodsId(), tradeLog.getGoodsName());\n\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("p",[n("code",[s._v("orderAndPay")]),s._v("方法上使用"),n("code",[s._v("@LcnTransaction")]),s._v("注解标注，表示开始LCN模式分布式事务控制。")]),s._v(" "),n("p",[s._v("接着在febs-server-test的cc.mrbird.febs.server.test.service目录下新建ITradeLogService接口：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("public interface ITradeLogService extends IService<TradeLog> {\n    void packageAndSend(TradeLog tradeLog);\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("接着在该目录下新建impl包，然后在该包下新建该接口实现类TradeLogServiceImpl：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Slf4j\n@Service("tradeLogService")\npublic class TradeLogServiceImpl extends ServiceImpl<TradeLogMapper, TradeLog> implements ITradeLogService {\n\n    ConcurrentHashMap<String, Long> hashMap = new ConcurrentHashMap<>();\n\n    @Override\n    @LcnTransaction\n    public void packageAndSend(TradeLog tradeLog) {\n        TradeLog tl = new TradeLog();\n        tl.setGoodsId(tradeLog.getGoodsId());\n        tl.setGoodsName(tradeLog.getGoodsName());\n        tl.setStatus("打包完毕，开始物流配送！");\n        tl.setCreateTime(new Date());\n\n        this.save(tl);\n        log.info("商品ID为{}，名称为{}的商品打包完毕，开始物流配送", tradeLog.getGoodsId(), tradeLog.getGoodsName());\n\n        hashMap.put(TracingContext.tracing().groupId(), tradeLog.getId());\n    }\n\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("p",[s._v("在"),n("code",[s._v("packageAndSend")]),s._v("方法上，也用"),n("code",[s._v("@LcnTransaction")]),s._v("注解标注，表示开启LCN模式分布式事务控制。")]),s._v(" "),n("p",[s._v("接下来我们要实现如下图所示的调用流程：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/31/l145ZD.png",alt:"692.png"}})]),s._v(" "),n("p",[s._v("在febs-server-test的TestController中添加如下方法，供febs-server-system Feign远程调用：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Slf4j\n@RestController\npublic class TestController {\n\n    @Autowired\n    private ITradeLogService tradeLogService;\n\n    ......\n    \n    @PostMapping("package/send")\n    public void packageAndSend(@RequestBody TradeLog tradeLog) {\n        tradeLogService.packageAndSend(tradeLog);\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("回到febs-server-system模块，因为之前并没有在febs-server-system模块上使用Feign，所以还得稍微配置配置。在Nacos控制台中修改febs-server-system.yaml配置，添加Feign相关配置：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("feign:\n  hystrix:\n    enabled: true\n\nhystrix:\n  shareSecurityContext: true\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("然后在febs-server-system的入口类上添加"),n("code",[s._v("@EnableFeignClients")]),s._v("和"),n("code",[s._v("@EnableFebsOauth2FeignClient")]),s._v("注解：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@EnableFeignClients\n@EnableFebsOauth2FeignClient\n@SpringBootApplication\n@EnableFebsServerProtect\n@EnableFebsAuthExceptionHandler\n@EnableTransactionManagement\n@EnableDistributedTransaction\n@MapperScan("cc.mrbird.febs.server.system.mapper")\n@EnableGlobalMethodSecurity(prePostEnabled = true)\npublic class FebsServerSystemApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(FebsServerSystemApplication.class, args);\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("p",[s._v("因为"),n("code",[s._v("@EnableFebsOauth2FeignClient")]),s._v("、"),n("code",[s._v("@EnableFebsServerProtect")]),s._v("和"),n("code",[s._v("@EnableFebsAuthExceptionHandler")]),s._v("可以使用"),n("code",[s._v("@FebsCloudApplication")]),s._v("代替，所以上面的代码可以简化为：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@EnableFeignClients\n@SpringBootApplication\n@FebsCloudApplication\n@EnableTransactionManagement\n@EnableDistributedTransaction\n@MapperScan("cc.mrbird.febs.server.system.mapper")\n@EnableGlobalMethodSecurity(prePostEnabled = true)\npublic class FebsServerSystemApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(FebsServerSystemApplication.class, args);\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[s._v("接着在febs-server-system的cc.mrbird.febs.server.system.service目录下新建IRemoteTradeLogService，它是一个Feign Client：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@FeignClient(value = FebsServerConstant.FEBS_SERVER_TEST, contextId = "tradeLogServiceClient", fallbackFactory = RemoteTradeLogServiceFallback.class)\npublic interface IRemoteTradeLogService {\n\n    @PostMapping("package/send")\n    void packageAndSend(@RequestBody TradeLog tradeLog);\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("在该目录下新建fallback包，然后在该包下新建RemoteTradeLogServiceFallback，用于处理回退：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Slf4j\n@Component\npublic class RemoteTradeLogServiceFallback implements FallbackFactory<IRemoteTradeLogService> {\n    @Override\n    public IRemoteTradeLogService create(Throwable throwable) {\n        return tradeLog -> log.info("调用失败", throwable);\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("Feign Client定义好后，修改febs-server-system的TradeLogServiceImpl的orderAndPay方法，在下单支付成功后，远程调用febs-server-test的打包配送方法：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Slf4j\n@Service("tradeLogService")\npublic class TradeLogServiceImpl extends ServiceImpl<TradeLogMapper, TradeLog> implements ITradeLogService {\n\n    @Autowired\n    private IRemoteTradeLogService remoteTradeLogService;\n\n    @Override\n    @LcnTransaction\n    public void orderAndPay(TradeLog tradeLog) {\n        tradeLog.setCreateTime(new Date());\n        tradeLog.setStatus("下单并支付成功");\n\n        // 保存支付日志\n        this.save(tradeLog);\n        log.info("用户已经下单并支付成功商品ID为{}，名称为{}的商品", tradeLog.getGoodsId(), tradeLog.getGoodsName());\n        // 调用远程方法，打包并配送商品\n        remoteTradeLogService.packageAndSend(tradeLog);\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])]),n("p",[s._v("最后在febs-server-system的TestController中添加如下方法，作为调用的入口：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Slf4j\n@RestController\npublic class TestController {\n\n    @Autowired\n    private ITradeLogService tradeLogService;\n\n    ......\n\n    @GetMapping("pay")\n    public void orderAndPay(TradeLog tradeLog) {\n        this.tradeLogService.orderAndPay(tradeLog);\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("简单起见，我没有对TradeLog进行格式校验。")]),s._v(" "),n("p",[s._v("至此，我们便可以开始测试了。启动febs-auth、febs-gateway、febs-server-system和febs-server-test模块，然后查看TM管理界面：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/31/l1TmTS.png",alt:"694.png"}})]),s._v(" "),n("p",[s._v("可以看到，TM已经检测到了两个TC。")]),s._v(" "),n("p",[s._v("然后使用Postman发送测试请求（请求头部需要添加令牌，这里就不演示令牌获取了，前面章节介绍许多次了）：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/31/l1TMWj.png",alt:"693.png"}})]),s._v(" "),n("p",[s._v("调用流程没有问题，查看数据库t_trade_log表记录:")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/31/l17lND.png",alt:"695.png"}})]),s._v(" "),n("p",[s._v("现在，我们在febs-server-system的TradeLogServiceImpl的orderAndPay方法中制造一个异常，看看分布式事务是否生效：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Slf4j\n@Service("tradeLogService")\npublic class TradeLogServiceImpl extends ServiceImpl<TradeLogMapper, TradeLog> implements ITradeLogService {\n\n    @Autowired\n    private IRemoteTradeLogService remoteTradeLogService;\n\n    @Override\n    @LcnTransaction\n    public void orderAndPay(TradeLog tradeLog) {\n        tradeLog.setCreateTime(new Date());\n        tradeLog.setStatus("下单并支付成功");\n\n        // 保存支付日志\n        this.save(tradeLog);\n        log.info("用户已经下单并支付成功商品ID为{}，名称为{}的商品", tradeLog.getGoodsId(), tradeLog.getGoodsName());\n        // 调用远程方法，打包并配送商品\n        remoteTradeLogService.packageAndSend(tradeLog);\n\n        throw new RuntimeException("抛个异常~");\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("p",[s._v("重启febs-server-system，然后再次使用Postman发送测试请求：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/31/l1bAyR.png",alt:"696.png"}})]),s._v(" "),n("p",[s._v("可以看到调用出错了，查看数据库t_trade_log表数据，看看是否有脏数据出现：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/31/l1batS.png",alt:"697.png"}})]),s._v(" "),n("p",[s._v("可以看到，并没有新的数据出现，说明LCN模式分布式事务控制成功。")]),s._v(" "),n("p",[s._v("LCN模式的基本原理：")]),s._v(" "),n("p",[s._v("通过代理Connection的方式实现对本地事务的操作，然后再由TxManager统一协调控制事务。当本地事务提交回滚或者关闭连接时将会执行假操作，该代理的连接将由LCN连接池管理。")]),s._v(" "),n("p",[s._v("LCN模式特点：")]),s._v(" "),n("ol",[n("li",[s._v("该模式对代码的嵌入性为低（加注解就好了）。")]),s._v(" "),n("li",[s._v("该模式仅限于本地存在连接对象且可通过连接对象控制事务的模块。")]),s._v(" "),n("li",[s._v("该模式下的事务提交与回滚是由本地事务方控制，对于数据一致性上有较高的保障。")]),s._v(" "),n("li",[s._v("该模式缺陷在于代理的连接需要随事务发起方一共释放连接，增加了连接占用的时间。")])]),s._v(" "),n("h2",{attrs:{id:"tcc模式分布式事务控制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#tcc模式分布式事务控制"}},[s._v("#")]),s._v(" TCC模式分布式事务控制")]),s._v(" "),n("p",[s._v("要使用TCC模式，只需要简单修改下febs-server-test的TradeLogServiceImpl类的代码，修改后如下所示：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Slf4j\n@Service("tradeLogService")\npublic class TradeLogServiceImpl extends ServiceImpl<TradeLogMapper, TradeLog> implements ITradeLogService {\n\n    ConcurrentHashMap<String, Long> hashMap = new ConcurrentHashMap<>();\n\n    @Override\n    @TccTransaction\n    public void packageAndSend(TradeLog tradeLog) {\n        TradeLog tl = new TradeLog();\n        tl.setGoodsId(tradeLog.getGoodsId());\n        tl.setGoodsName(tradeLog.getGoodsName());\n        tl.setStatus("打包完毕，开始物流配送！");\n        tl.setCreateTime(new Date());\n\n        this.save(tl);\n        log.info("商品ID为{}，名称为{}的商品打包完毕，开始物流配送", tradeLog.getGoodsId(), tradeLog.getGoodsName());\n\n        hashMap.put(TracingContext.tracing().groupId(), tl.getId());\n    }\n\n    public void confirmPackageAndSend(TradeLog tradeLog) {\n        log.info("事务执行成功");\n        hashMap.remove(TracingContext.tracing().groupId());\n    }\n\n    public void cancelPackageAndSend(TradeLog tradeLog) {\n        Long tradeLogId = hashMap.get(TracingContext.tracing().groupId());\n        log.info("事务执行失败，回滚tradeLogId为{}的数据", tradeLogId);\n        this.removeById(tradeLogId);\n        hashMap.remove(TracingContext.tracing().groupId());\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br")])]),n("p",[s._v("该类代码主要修改了三个地方：")]),s._v(" "),n("ol",[n("li",[s._v("使用"),n("code",[s._v("@TccTransaction")]),s._v("注解实现分布式事务控制；")]),s._v(" "),n("li",[s._v("新增"),n("code",[s._v("confirmPackageAndSend")]),s._v("方法；")]),s._v(" "),n("li",[s._v("新增"),n("code",[s._v("cancelPackageAndSend")]),s._v("方法。")])]),s._v(" "),n("p",[s._v("为什么要新增"),n("code",[s._v("confirmPackageAndSend")]),s._v("和"),n("code",[s._v("cancelPackageAndSend")]),s._v("方法呢？还记得TCC的含义么，TCC是Try、Confirm、Cancel三个单词的缩写，所以"),n("code",[s._v("packageAndSend")]),s._v("方法的内容相当于Try模块里执行的逻辑；当执行成功时候，则执行Confirm操作，对应"),n("code",[s._v("confirmPackageAndSend")]),s._v("里的逻辑；当Try里的逻辑执行失败时，则执行Cancel操作，对应"),n("code",[s._v("cancelPackageAndSend")]),s._v("里的逻辑。")]),s._v(" "),n("p",[n("code",[s._v("@TccTransaction")]),s._v("注解规定了：confirm方法名称需为注解所标注的方法名（即packageAndSend）的首字母大写（即PackageAndSend），然后前面拼接"),n("code",[s._v("confirm")]),s._v("（即confirmPackageAndSend）；cancel方法名称则是方法首字母大写，然后前面拼接"),n("code",[s._v("cancel")]),s._v("（即cancelPackageAndSend）。")]),s._v(" "),n("p",[s._v("confirm操作没什么需要操作的，主要是cancel逻辑，我们需要在里面手动删除对应的记录，以此避免脏数据。")]),s._v(" "),n("p",[s._v("重启febs-server-test模块，然后再次使用Postman发送测试请求：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/31/l1bAyR.png",alt:"696.png"}})]),s._v(" "),n("p",[s._v("查看febs-server-test日志：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("2019-12-31 16:02:56 INFO  [FEBS-Server-Test,,,] http-nio-8202-exec-1 cc.mrbird.febs.server.test.service.impl.TradeLogServiceImpl 商品ID为1，名称为homepod的商品打包完毕，开始物流配送\n2019-12-31 16:02:56 INFO  [FEBS-Server-Test,,,] tc-rpc-service-0 cc.mrbird.febs.server.test.service.impl.TradeLogServiceImpl 事务执行失败，回滚tradeLogId为6的数据\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("可以看到，成功执行了cancelPackageAndSend方法。查看数据库t_trade_log表数据，看看是否有脏数据出现：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://s2.ax1x.com/2019/12/31/l1batS.png",alt:"697.png"}})]),s._v(" "),n("p",[s._v("可以看到，并没有新的数据出现，说明TCC模式分布式事务控制成功。")]),s._v(" "),n("p",[s._v("将febs-server-system的TradeLogServiceImpl的orderAndPay中的异常注释掉，然后重启febs-server-sysetm，再次使用Postman发送测试请求，febs-server-test日志输出如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("2019-12-31 16:10:57 INFO  [FEBS-Server-Test,,,] http-nio-8202-exec-5 cc.mrbird.febs.server.test.service.impl.TradeLogServiceImpl 商品ID为1，名称为homepod的商品打包完毕，开始物流配送\n2019-12-31 16:10:57 INFO  [FEBS-Server-Test,,,] tc-rpc-service-1 cc.mrbird.febs.server.test.service.impl.TradeLogServiceImpl 事务执行成功\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("TCC模式基本原理：")]),s._v(" "),n("p",[s._v("TCC事务机制相对于传统事务机制（X/Open XA Two-Phase-Commit），其特征在于它不依赖资源管理器(RM)对XA的支持，而是通过对（由业务系统提供的）业务逻辑的调度来实现分布式事务。主要由三步操作，Try: 尝试执行业务、 Confirm:确认执行业务、 Cancel: 取消执行业务。")]),s._v(" "),n("p",[s._v("TCC模式特点：")]),s._v(" "),n("ol",[n("li",[s._v("该模式对代码的嵌入性高，要求每个业务需要写三种步骤的操作。")]),s._v(" "),n("li",[s._v("该模式对有无本地事务控制都可以支持使用面广。")]),s._v(" "),n("li",[s._v("数据一致性控制几乎完全由开发者控制，对业务开发难度要求高")])]),s._v(" "),n("h2",{attrs:{id:"txc模式事务控制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#txc模式事务控制"}},[s._v("#")]),s._v(" TXC模式事务控制")]),s._v(" "),n("p",[s._v("要使用TXC模式也很简单，只需要将febs-server-test的TradeLogServiceImpl类代码修改为：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Slf4j\n@Service("tradeLogService")\npublic class TradeLogServiceImpl extends ServiceImpl<TradeLogMapper, TradeLog> implements ITradeLogService {\n\n    ConcurrentHashMap<String, Long> hashMap = new ConcurrentHashMap<>();\n\n    @Override\n    @TxcTransaction(timeout = 3000)\n    public void packageAndSend(TradeLog tradeLog) {\n        TradeLog tl = new TradeLog();\n        tl.setGoodsId(tradeLog.getGoodsId());\n        tl.setGoodsName(tradeLog.getGoodsName());\n        tl.setStatus("打包完毕，开始物流配送！");\n        tl.setCreateTime(new Date());\n\n        this.save(tl);\n        log.info("商品ID为{}，名称为{}的商品打包完毕，开始物流配送", tradeLog.getGoodsId(), tradeLog.getGoodsName());\n\n        hashMap.put(TracingContext.tracing().groupId(), tradeLog.getId());\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("p",[n("code",[s._v("packageAndSend")]),s._v("使用"),n("code",[s._v("@TxcTransaction")]),s._v("注解标注即可，这里就不测试了。")]),s._v(" "),n("p",[s._v("TXC模式基本原理：")]),s._v(" "),n("p",[s._v("TXC模式命名来源于淘宝，实现原理是在执行SQL之前，先查询SQL的影响数据，然后保存执行的SQL快走信息和创建锁。当需要回滚的时候就采用这些记录数据回滚数据库，目前锁实现依赖redis分布式锁控制。")]),s._v(" "),n("p",[s._v("TXC模式特点：")]),s._v(" "),n("ol",[n("li",[s._v("该模式同样对代码的嵌入性低。")]),s._v(" "),n("li",[s._v("该模式仅限于对支持SQL方式的模块支持。")]),s._v(" "),n("li",[s._v("该模式由于每次执行SQL之前需要先查询影响数据，因此相比LCN模式消耗资源与时间要多。")]),s._v(" "),n("li",[s._v("该模式不会占用数据库的连接资源。")])])])}),[],!1,null,null,null);n.default=r.exports}}]);