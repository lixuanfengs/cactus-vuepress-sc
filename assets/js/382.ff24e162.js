(window.webpackJsonp=window.webpackJsonp||[]).push([[382],{737:function(e,s,a){"use strict";a.r(s);var n=a(0),t=Object(n.a)({},(function(){var e=this,s=e._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h2",{attrs:{id:"搭建seata-server"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#搭建seata-server"}},[e._v("#")]),e._v(" 搭建Seata Server")]),e._v(" "),s("p",[s("a",{attrs:{href:"http://seata.io/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Seata"),s("OutboundLink")],1),e._v("是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA（适合业务流程长、业务流程多的情况，所以本节不演示） 和 XA（截至2020年1月1日，该功能Seata还在开发中，所以也不演示） 事务模式，为用户打造一站式的分布式解决方案。")]),e._v(" "),s("p",[e._v("Seata服务端下载地址：https://github.com/seata/seata/releases。因为项目里使用的spring-cloud-alibaba-dependencies依赖版本为2.1.1.RELEASE，内部Seata的版本为0.9.0，所以我们下载这个版本的Seata服务端：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2020/01/01/l85ZTS.png",alt:"698.png"}})]),e._v(" "),s("p",[e._v("下载后解压：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2020/01/01/l85MSs.png",alt:"699.png"}})]),e._v(" "),s("p",[e._v("修改conf目录下的file.conf配置文件，修改部分如下图所示：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2020/01/01/l8I58J.png",alt:"700.png"}})]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2020/01/01/l8IHDx.png",alt:"701.png"}})]),e._v(" "),s("p",[e._v("主要修改了事务分组名称和数据库连接。")]),e._v(" "),s("p",[e._v("接着在创建一个名为febs_cloud_seata的MySQL数据库，并且导入Seata解压目录conf文件夹下的db_store.sql脚本：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2020/01/01/l8X4P0.png",alt:"702.png"}})]),e._v(" "),s("p",[e._v("在febs_cloud_base数据库中导入Seata解压目录conf文件夹下的db_undo_log.sql脚本：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2020/01/01/l8XbqJ.png",alt:"705.png"}})]),e._v(" "),s("p",[e._v("导入后，接着修改conf目录下的registry.conf配置文件，修改部分如下图所示：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2020/01/01/l8Tf1J.png",alt:"703.png"}})]),e._v(" "),s("p",[e._v("指定使用Nacos作为注册中心，并修改了Nacos地址。")]),e._v(" "),s("p",[e._v("这些都修改好后，双击解压目录bin文件夹下的seata-server.bat文件启动seata-server即可（别忘了先启动好Nacos）。")]),e._v(" "),s("h2",{attrs:{id:"微服务整合seata"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#微服务整合seata"}},[e._v("#")]),e._v(" 微服务整合Seata")]),e._v(" "),s("p",[e._v("本节将在10.3节的源码（注意，是10.3节而不是10.4节，因为10.4节已经添加了RocketMQ相关代码）上继续编写代码。使用IDEA导入10.3节的源码（导入源码后，清空下febs_cloud_base和febs_nacos库表，重新执行febs-cloud目录下的febs_cloud_base.sql和febs_nacos.sql数据库脚本），然后在febs-server的pom中添加Seata依赖：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("<dependency>\n    <groupId>com.alibaba.cloud</groupId>\n    <artifactId>spring-cloud-starter-alibaba-seata</artifactId>\n</dependency>\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])]),s("p",[e._v("此外，目前MyBatis Plus的多数据源配置并不适用于Seata，因为Seata需要我们手写数据源代理配置（使用Druid作为驱动），所以我们删掉febs-server pom中MyBatis Plus的多数据源依赖（别担心，本节的数据源代理配置还是基于多数据源的）：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("\x3c!-- 删掉 --\x3e\n<dependency>\n    <groupId>com.baomidou</groupId>\n    <artifactId>dynamic-datasource-spring-boot-starter</artifactId>\n    <version>2.5.7</version>\n</dependency>\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br")])]),s("p",[e._v("接下来，我们开始往febs-server-test和febs-server-system中整合Seata，"),s("strong",[e._v("因为步骤一致，所以这里以febs-server-sysetm为例子，febs-server-test照着改就行了")]),e._v("。")]),e._v(" "),s("p",[e._v("修改Nacos控制台中的febs-server-system.yaml配置，删掉spring.datasource下的所有配置，替换为：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("spring:\n  datasource:\n    base:\n      driver-class-name: com.mysql.cj.jdbc.Driver\n      url: jdbc:mysql://${mysql.url}:3306/febs_cloud_base?useUnicode=true&characterEncoding=UTF-8&useJDBCCompliantTimezoneShift=true&useLegacyDatetimeCode=false&serverTimezone=GMT%2b8\n      username: root\n      password: 123456\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br")])]),s("p",[e._v("这里指定了一个别名为base的数据配置，如果你还需要添加新的数据源配置，则只需和base配置保持同级即可，比如新增加一个别名为order的数据源：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("spring:\n  datasource:\n    base:\n      driver-class-name: com.mysql.cj.jdbc.Driver\n      url: jdbc:mysql://${mysql.url}:3306/febs_cloud_base?useUnicode=true&characterEncoding=UTF-8&useJDBCCompliantTimezoneShift=true&useLegacyDatetimeCode=false&serverTimezone=GMT%2b8\n      username: root\n      password: 123456\n    order:\n      driver-class-name: xx\n      url: xx\n      username: xx\n      password: xx\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br")])]),s("p",[e._v("修改后，febs-sever-system.yaml的完整配置如下所示：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('server:\n  port: 8201\n\nspring:\n  boot:\n    admin:\n      client:\n        url: http://${febs-monitor-admin}:8401\n        username: febs\n        password: 123456\n  datasource:\n    base:\n      driver-class-name: com.mysql.cj.jdbc.Driver\n      url: jdbc:mysql://${mysql.url}:3306/febs_cloud_base?useUnicode=true&characterEncoding=UTF-8&useJDBCCompliantTimezoneShift=true&useLegacyDatetimeCode=false&serverTimezone=GMT%2b8\n      username: root\n      password: 123456\n      \n  autoconfigure:\n    exclude: org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration\n\nsecurity:\n  oauth2:\n    resource:\n      id: ${spring.application.name}\n      user-info-uri: http://${febs-gateway}:8301/auth/user\n\nmybatis-plus:\n  type-aliases-package: cc.mrbird.febs.common.entity.system\n  mapper-locations: classpath:mapper/*/*.xml\n  configuration:\n    jdbc-type-for-null: null\n  global-config:\n    banner: false\n\ninfo:\n  app:\n    name: ${spring.application.name}\n    description: "@project.description@"\n    version: "@project.version@"\n\nmanagement:\n  endpoints:\n    web:\n      exposure:\n        include: \'*\'\n  endpoint:\n    health:\n      show-details: ALWAYS\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br"),s("span",{staticClass:"line-number"},[e._v("24")]),s("br"),s("span",{staticClass:"line-number"},[e._v("25")]),s("br"),s("span",{staticClass:"line-number"},[e._v("26")]),s("br"),s("span",{staticClass:"line-number"},[e._v("27")]),s("br"),s("span",{staticClass:"line-number"},[e._v("28")]),s("br"),s("span",{staticClass:"line-number"},[e._v("29")]),s("br"),s("span",{staticClass:"line-number"},[e._v("30")]),s("br"),s("span",{staticClass:"line-number"},[e._v("31")]),s("br"),s("span",{staticClass:"line-number"},[e._v("32")]),s("br"),s("span",{staticClass:"line-number"},[e._v("33")]),s("br"),s("span",{staticClass:"line-number"},[e._v("34")]),s("br"),s("span",{staticClass:"line-number"},[e._v("35")]),s("br"),s("span",{staticClass:"line-number"},[e._v("36")]),s("br"),s("span",{staticClass:"line-number"},[e._v("37")]),s("br"),s("span",{staticClass:"line-number"},[e._v("38")]),s("br"),s("span",{staticClass:"line-number"},[e._v("39")]),s("br"),s("span",{staticClass:"line-number"},[e._v("40")]),s("br"),s("span",{staticClass:"line-number"},[e._v("41")]),s("br"),s("span",{staticClass:"line-number"},[e._v("42")]),s("br"),s("span",{staticClass:"line-number"},[e._v("43")]),s("br"),s("span",{staticClass:"line-number"},[e._v("44")]),s("br"),s("span",{staticClass:"line-number"},[e._v("45")]),s("br"),s("span",{staticClass:"line-number"},[e._v("46")]),s("br"),s("span",{staticClass:"line-number"},[e._v("47")]),s("br"),s("span",{staticClass:"line-number"},[e._v("48")]),s("br")])]),s("p",[e._v("接着回到febs-server-system项目，在配置文件bootstrap.yml中添加Seata配置：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("spring:\n  cloud:\n    alibaba:\n      seata:\n        tx-service-group: febs_tx_group\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br")])]),s("p",[e._v("这个分组名称必须和Seata解压目录conf文件夹下file.conf中指定的一致。")]),e._v(" "),s("p",[e._v("然后将Seata解压目录conf文件夹下的file.conf和registry.conf文件拷贝到febs-server-system的resources目录下：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2020/01/01/l8qaEq.png",alt:"704.png"}})]),e._v(" "),s("p",[e._v("接着在febs-server-system的cc.mrbird.febs.server.system.configure目录下新建seata包，然后在该包下新建枚举类DataSourceKey，用于指定数据库别名：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("@Getter\npublic enum DataSourceKey {\n    // 代表刚刚在febs-server-system.yaml中配置的base数据库\n    BASE\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br")])]),s("p",[e._v("接着在该目录下创建DynamicDataSourceContextHolder，用于切换数据库上下文：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("public class DynamicDataSourceContextHolder {\n\n    // 默认数据源BASE\n    private static final ThreadLocal<String> CONTEXT_HOLDER = ThreadLocal.withInitial(DataSourceKey.BASE::name);\n\n    private static List<Object> dataSourceKeys = new ArrayList<>();\n\n    public static void setDataSourceKey(DataSourceKey key) {\n        CONTEXT_HOLDER.set(key.name());\n    }\n\n    public static String getDataSourceKey() {\n        return CONTEXT_HOLDER.get();\n    }\n\n    public static void clearDataSourceKey() {\n        CONTEXT_HOLDER.remove();\n    }\n\n    public static List<Object> getDataSourceKeys() {\n        return dataSourceKeys;\n    }\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br")])]),s("p",[e._v("这里指定了默认的数据源为BASE，如果要切换到别的数据源，只需要通过"),s("code",[e._v("setDataSourceKey")]),e._v("方法设定即可。")]),e._v(" "),s("p",[e._v("在该目录下创建动态数据源路由DynamicRoutingDataSource：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Slf4j\npublic class DynamicRoutingDataSource extends AbstractRoutingDataSource {\n\n    @Override\n    protected Object determineCurrentLookupKey() {\n        log.info("当前数据源 [{}]", DynamicDataSourceContextHolder.getDataSourceKey());\n        return DynamicDataSourceContextHolder.getDataSourceKey();\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br")])]),s("p",[e._v("最后创建一个Seata数据源代理类DataSourceProxyConfig：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('/**\n * 虽说是多数据源，但这里只有一个BASE数据源，如果要添加新的数据源，照猫画虎即可。\n * @author MrBird\n */\n@Configuration\npublic class DataSourceProxyConfig {\n\n    @Bean("originBase")\n    @ConfigurationProperties(prefix = "spring.datasource.base")\n    public DataSource dataSourceMaster() {\n        return new DruidDataSource();\n    }\n\n\n    @Bean(name = "base")\n    public DataSourceProxy masterDataSourceProxy(@Qualifier("originBase") DataSource dataSource) {\n        return new DataSourceProxy(dataSource);\n    }\n\n\n    @Bean("dynamicDataSource")\n    public DataSource dynamicDataSource(@Qualifier("base") DataSource dataSourceBase) {\n\n        DynamicRoutingDataSource dynamicRoutingDataSource = new DynamicRoutingDataSource();\n\n        Map<Object, Object> dataSourceMap = new HashMap<>(1);\n        dataSourceMap.put(DataSourceKey.BASE.name(), dataSourceBase);\n\n        dynamicRoutingDataSource.setDefaultTargetDataSource(dataSourceBase);\n        dynamicRoutingDataSource.setTargetDataSources(dataSourceMap);\n\n        DynamicDataSourceContextHolder.getDataSourceKeys().addAll(dataSourceMap.keySet());\n\n        return dynamicRoutingDataSource;\n    }\n\n    @Bean\n    @ConfigurationProperties(prefix = "mybatis")\n    public MybatisSqlSessionFactoryBean sqlSessionFactoryBean(@Qualifier("dynamicDataSource") DataSource dataSource) {\n        // 这里用 MybatisSqlSessionFactoryBean 代替了 SqlSessionFactoryBean，否则 MyBatisPlus 不会生效\n        MybatisSqlSessionFactoryBean mybatisSqlSessionFactoryBean = new MybatisSqlSessionFactoryBean();\n        mybatisSqlSessionFactoryBean.setDataSource(dataSource);\n        return mybatisSqlSessionFactoryBean;\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br"),s("span",{staticClass:"line-number"},[e._v("24")]),s("br"),s("span",{staticClass:"line-number"},[e._v("25")]),s("br"),s("span",{staticClass:"line-number"},[e._v("26")]),s("br"),s("span",{staticClass:"line-number"},[e._v("27")]),s("br"),s("span",{staticClass:"line-number"},[e._v("28")]),s("br"),s("span",{staticClass:"line-number"},[e._v("29")]),s("br"),s("span",{staticClass:"line-number"},[e._v("30")]),s("br"),s("span",{staticClass:"line-number"},[e._v("31")]),s("br"),s("span",{staticClass:"line-number"},[e._v("32")]),s("br"),s("span",{staticClass:"line-number"},[e._v("33")]),s("br"),s("span",{staticClass:"line-number"},[e._v("34")]),s("br"),s("span",{staticClass:"line-number"},[e._v("35")]),s("br"),s("span",{staticClass:"line-number"},[e._v("36")]),s("br"),s("span",{staticClass:"line-number"},[e._v("37")]),s("br"),s("span",{staticClass:"line-number"},[e._v("38")]),s("br"),s("span",{staticClass:"line-number"},[e._v("39")]),s("br"),s("span",{staticClass:"line-number"},[e._v("40")]),s("br"),s("span",{staticClass:"line-number"},[e._v("41")]),s("br"),s("span",{staticClass:"line-number"},[e._v("42")]),s("br"),s("span",{staticClass:"line-number"},[e._v("43")]),s("br"),s("span",{staticClass:"line-number"},[e._v("44")]),s("br"),s("span",{staticClass:"line-number"},[e._v("45")]),s("br")])]),s("p",[e._v("至此febs-server-system已经整合好Seata了，剩下的febs-server-test照着这些步骤改即可。")]),e._v(" "),s("h2",{attrs:{id:"at模式分布式事务控制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#at模式分布式事务控制"}},[e._v("#")]),e._v(" AT模式分布式事务控制")]),e._v(" "),s("p",[e._v("这里我们依旧采用购物的例子，在febs_cloud_base数据库中新建购物日志表t_trade_log：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("CREATE TABLE `t_trade_log`  (\n  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'ID',\n  `goods_id` int(11) NOT NULL COMMENT '商品ID',\n  `goods_name` varchar(50) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT '商品名称',\n  `status` varchar(50) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT '状态',\n  `create_time` datetime(0) NOT NULL COMMENT '创建时间',\n  PRIMARY KEY (`id`) USING BTREE\n) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;\n\nSET FOREIGN_KEY_CHECKS = 1;\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br")])]),s("p",[e._v("在febs-common的cc.mrbird.febs.common.entity.system包下新建TradeLog实体类：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Data\n@TableName("t_trade_log")\npublic class TradeLog implements Serializable {\n\n    private static final long serialVersionUID = 3902838426348137002L;\n\n    @TableId(value = "ID", type = IdType.AUTO)\n    private Long id;\n\n    @TableField("GOODS_ID")\n    private String goodsId;\n    @TableField("GOODS_NAME")\n    private String goodsName;\n    @TableField("STATUS")\n    private String status;\n    @TableField("CREATE_TIME")\n    private Date createTime;\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br")])]),s("p",[e._v("接着在febs-server-test的cc.mrbird.febs.server.test.mapper和febs-server-system的cc.mrbird.febs.server.system.mapper包下新建TradeLogMapper接口：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("public interface TradeLogMapper extends BaseMapper<TradeLog> {\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br")])]),s("p",[e._v("在febs-server-system的cc.mrbird.febs.server.system.service下新建ITradeLogService接口：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("public interface ITradeLogService extends IService<TradeLog> {\n    void orderAndPay(TradeLog tradeLog);\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br")])]),s("p",[e._v("接口包含一个下单支付抽象方法。")]),e._v(" "),s("p",[e._v("在该目录下的impl包下新建该接口实现类TradeLogServiceImpl：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Slf4j\n@Service("tradeLogService")\npublic class TradeLogServiceImpl extends ServiceImpl<TradeLogMapper, TradeLog> implements ITradeLogService {\n\n    @Override\n    @GlobalTransactional\n    public void orderAndPay(TradeLog tradeLog) {\n       // DynamicDataSourceContextHolder.setDataSourceKey(DataSourceKey.BASE);\n        log.info("当前 XID: {}", RootContext.getXID());\n\n        tradeLog.setCreateTime(new Date());\n        tradeLog.setStatus("下单并支付成功");\n\n        // 保存支付日志\n        this.save(tradeLog);\n        log.info("用户已经下单并支付成功商品ID为{}，名称为{}的商品", tradeLog.getGoodsId(), tradeLog.getGoodsName());\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br")])]),s("p",[s("code",[e._v("orderAndPay")]),e._v("方法上使用Seata的"),s("code",[e._v("@GlobalTransactional")]),e._v("注解标注，表示开启分布式事务控制。")]),e._v(" "),s("p",[e._v("接着在febs-server-system的cc.mrbird.febs.server.system.controller包下的TestController类下新增如下方法：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Slf4j\n@RestController\npublic class TestController {\n\n    @Autowired\n    private ITradeLogService tradeLogService;\n\n   ...\n\n    @GetMapping("pay")\n    public void orderAndPay(TradeLog tradeLog) {\n        this.tradeLogService.orderAndPay(tradeLog);\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br")])]),s("p",[e._v("简单起见，我没有对TradeLog进行格式校验。")]),e._v(" "),s("p",[e._v("在febs-server-test的cc.mrbird.febs.server.test.service目录下新建ITradeLogService接口：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("public interface ITradeLogService extends IService<TradeLog> {\n    void packageAndSend(TradeLog tradeLog);\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br")])]),s("p",[e._v("接着在该目录下新建impl包，然后在该包下新建该接口实现类TradeLogServiceImpl：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Slf4j\n@Service("tradeLogService")\npublic class TradeLogServiceImpl extends ServiceImpl<TradeLogMapper, TradeLog> implements ITradeLogService {\n\n    @Override\n    @GlobalTransactional\n    public void packageAndSend(TradeLog tradeLog) {\n        log.info("当前 XID: {}", RootContext.getXID());\n\n        TradeLog tl = new TradeLog();\n        tl.setGoodsId(tradeLog.getGoodsId());\n        tl.setGoodsName(tradeLog.getGoodsName());\n        tl.setStatus("打包完毕，开始物流配送！");\n        tl.setCreateTime(new Date());\n\n        this.save(tl);\n        log.info("商品ID为{}，名称为{}的商品打包完毕，开始物流配送", tradeLog.getGoodsId(), tradeLog.getGoodsName());\n    }\n\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br")])]),s("p",[s("code",[e._v("packageAndSend")]),e._v("方法同样使用"),s("code",[e._v("@GlobalTransactional")]),e._v("注解标注。")]),e._v(" "),s("p",[e._v("接下来我们要实现如下图所示的调用流程：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2019/12/31/l145ZD.png",alt:"692.png"}})]),e._v(" "),s("p",[e._v("在febs-server-test的TestController中添加如下方法，供febs-server-system Feign远程调用：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Slf4j\n@RestController\npublic class TestController {\n\n    @Autowired\n    private ITradeLogService tradeLogService;\n\n    ......\n    \n    @PostMapping("package/send")\n    public void packageAndSend(@RequestBody TradeLog tradeLog) {\n        tradeLogService.packageAndSend(tradeLog);\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br")])]),s("p",[e._v("回到febs-server-system模块，因为之前并没有在febs-server-system模块上使用Feign，所以还得稍微配置配置。在Nacos控制台中修改febs-server-system.yaml配置，添加Feign相关配置：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("feign:\n  hystrix:\n    enabled: true\n\nhystrix:\n  shareSecurityContext: true\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br")])]),s("p",[e._v("然后在febs-server-system的入口类上添加"),s("code",[e._v("@EnableFeignClients")]),e._v("和"),s("code",[e._v("@EnableFebsOauth2FeignClient")]),e._v("注解：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@EnableFeignClients\n@EnableFebsOauth2FeignClient\n@SpringBootApplication\n@EnableFebsServerProtect\n@EnableFebsAuthExceptionHandler\n@EnableTransactionManagement\n@EnableDistributedTransaction\n@MapperScan("cc.mrbird.febs.server.system.mapper")\n@EnableGlobalMethodSecurity(prePostEnabled = true)\npublic class FebsServerSystemApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(FebsServerSystemApplication.class, args);\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br")])]),s("p",[e._v("因为"),s("code",[e._v("@EnableFebsOauth2FeignClient")]),e._v("、"),s("code",[e._v("@EnableFebsServerProtect")]),e._v("和"),s("code",[e._v("@EnableFebsAuthExceptionHandler")]),e._v("可以使用"),s("code",[e._v("@FebsCloudApplication")]),e._v("代替，所以上面的代码可以简化为：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@EnableFeignClients\n@SpringBootApplication\n@FebsCloudApplication\n@EnableTransactionManagement\n@EnableDistributedTransaction\n@MapperScan("cc.mrbird.febs.server.system.mapper")\n@EnableGlobalMethodSecurity(prePostEnabled = true)\npublic class FebsServerSystemApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(FebsServerSystemApplication.class, args);\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br")])]),s("p",[e._v("接着在febs-server-system的cc.mrbird.febs.server.system.service目录下新建IRemoteTradeLogService，它是一个Feign Client：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@FeignClient(value = FebsServerConstant.FEBS_SERVER_TEST, contextId = "tradeLogServiceClient", fallbackFactory = RemoteTradeLogServiceFallback.class)\npublic interface IRemoteTradeLogService {\n\n    @PostMapping("package/send")\n    void packageAndSend(@RequestBody TradeLog tradeLog);\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br")])]),s("p",[e._v("在该目录下新建fallback包，然后在该包下新建RemoteTradeLogServiceFallback，用于处理回退：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Slf4j\n@Component\npublic class RemoteTradeLogServiceFallback implements FallbackFactory<IRemoteTradeLogService> {\n    @Override\n    public IRemoteTradeLogService create(Throwable throwable) {\n        return tradeLog -> log.info("调用失败", throwable);\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br")])]),s("p",[e._v("Feign Client定义好后，修改febs-server-system的TradeLogServiceImpl的orderAndPay方法，在下单支付成功后，远程调用febs-server-test的打包配送方法：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Slf4j\n@Service("tradeLogService")\npublic class TradeLogServiceImpl extends ServiceImpl<TradeLogMapper, TradeLog> implements ITradeLogService {\n\n    @Autowired\n    private IRemoteTradeLogService remoteTradeLogService;\n\n    @Override\n    @GlobalTransactional\n    public void orderAndPay(TradeLog tradeLog) {\n        // DynamicDataSourceContextHolder.setDataSourceKey(DataSourceKey.BASE);\n        log.info("当前 XID: {}", RootContext.getXID());\n\n        tradeLog.setCreateTime(new Date());\n        tradeLog.setStatus("下单并支付成功");\n\n        // 保存支付日志\n        this.save(tradeLog);\n        log.info("用户已经下单并支付成功商品ID为{}，名称为{}的商品", tradeLog.getGoodsId(), tradeLog.getGoodsName());\n        // 调用远程方法，打包并配送商品\n        remoteTradeLogService.packageAndSend(tradeLog);\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br")])]),s("p",[e._v("到这里，代码都编写完了，启动febs-auth、febs-gateway、febs-server-system和febs-server-test模块，然后使用Postman发送测试请求（请求头部需要添加令牌，这里就不演示令牌获取了，前面章节介绍许多次了）：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2020/01/01/l8jeRf.png",alt:"706.png"}})]),e._v(" "),s("p",[e._v("请求发送成功，查看febs-server-system日志：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('2020-01-01 12:13:32 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 io.seata.common.loader.EnhancedServiceLoader load TransactionManager[null] extension by class[io.seata.tm.DefaultTransactionManager]\n2020-01-01 12:13:32 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 io.seata.tm.TransactionManagerHolder TransactionManager Singleton io.seata.tm.DefaultTransactionManager@6eebb6e9\n2020-01-01 12:13:32 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 io.seata.common.loader.EnhancedServiceLoader load LoadBalance[null] extension by class[io.seata.discovery.loadbalance.RandomLoadBalance]\n2020-01-01 12:13:33 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 io.seata.tm.api.DefaultGlobalTransaction Begin new global transaction [192.168.33.1:8091:2031579909]\n2020-01-01 12:13:33 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 cc.mrbird.febs.server.system.service.impl.TradeLogServiceImpl 当前 XID: 192.168.33.1:8091:2031579909\n2020-01-01 12:13:33 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 cc.mrbird.febs.server.system.configure.seata.DynamicRoutingDataSource 当前数据源 [BASE]\n2020-01-01 12:13:33 WARN  [FEBS-Server-System,,,] http-nio-8201-exec-1 io.seata.common.loader.EnhancedServiceLoader load [io.seata.rm.datasource.undo.parser.ProtostuffUndoLogParser] class fail. io/protostuff/runtime/RuntimeEnv\n2020-01-01 12:13:33 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 io.seata.common.loader.EnhancedServiceLoader load UndoLogParser[jackson] extension by class[io.seata.rm.datasource.undo.parser.JacksonUndoLogParser]\n2020-01-01 12:13:33 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 cc.mrbird.febs.server.system.service.impl.TradeLogServiceImpl 用户已经下单并支付成功商品ID为1，名称为homepod的商品\n2020-01-01 12:13:33 INFO  [FEBS-Server-System,,,] hystrix-FEBS-Server-Test-1 com.netflix.config.ChainedDynamicProperty Flipping property: FEBS-Server-Test.ribbon.ActiveConnectionsLimit to use NEXT property: niws.loadbalancer.availabilityFilteringRule.activeConnectionsLimit = 2147483647\n2020-01-01 12:13:33 INFO  [FEBS-Server-System,,,] hystrix-FEBS-Server-Test-1 com.netflix.loadbalancer.BaseLoadBalancer Client: FEBS-Server-Test instantiated a LoadBalancer: DynamicServerListLoadBalancer:{NFLoadBalancer:name=FEBS-Server-Test,current list of Servers=[],Load balancer stats=Zone stats: {},Server stats: []}ServerList:null\n2020-01-01 12:13:33 INFO  [FEBS-Server-System,,,] hystrix-FEBS-Server-Test-1 com.netflix.loadbalancer.DynamicServerListLoadBalancer Using serverListUpdater PollingServerListUpdater\n2020-01-01 12:13:33 INFO  [FEBS-Server-System,,,] hystrix-FEBS-Server-Test-1 com.alibaba.nacos.client.naming new ips(1) service: DEFAULT_GROUP@@FEBS-Server-Test -> [{"clusterName":"DEFAULT","enabled":true,"ephemeral":true,"healthy":true,"instanceHeartBeatInterval":5000,"instanceHeartBeatTimeOut":15000,"instanceId":"192.168.28.85#8202#DEFAULT#DEFAULT_GROUP@@FEBS-Server-Test","ip":"192.168.28.85","ipDeleteTimeout":30000,"metadata":{"preserved.register.source":"SPRING_CLOUD"},"port":8202,"serviceName":"FEBS-Server-Test","weight":1.0}]\n2020-01-01 12:13:33 INFO  [FEBS-Server-System,,,] hystrix-FEBS-Server-Test-1 com.alibaba.nacos.client.naming current ips:(1) service: DEFAULT_GROUP@@FEBS-Server-Test -> [{"clusterName":"DEFAULT","enabled":true,"ephemeral":true,"healthy":true,"instanceHeartBeatInterval":5000,"instanceHeartBeatTimeOut":15000,"instanceId":"192.168.28.85#8202#DEFAULT#DEFAULT_GROUP@@FEBS-Server-Test","ip":"192.168.28.85","ipDeleteTimeout":30000,"metadata":{"preserved.register.source":"SPRING_CLOUD"},"port":8202,"serviceName":"FEBS-Server-Test","weight":1.0}]\n2020-01-01 12:13:33 INFO  [FEBS-Server-System,,,] hystrix-FEBS-Server-Test-1 com.netflix.config.ChainedDynamicProperty Flipping property: FEBS-Server-Test.ribbon.ActiveConnectionsLimit to use NEXT property: niws.loadbalancer.availabilityFilteringRule.activeConnectionsLimit = 2147483647\n2020-01-01 12:13:33 INFO  [FEBS-Server-System,,,] hystrix-FEBS-Server-Test-1 com.netflix.loadbalancer.DynamicServerListLoadBalancer DynamicServerListLoadBalancer for client FEBS-Server-Test initialized: DynamicServerListLoadBalancer:{NFLoadBalancer:name=FEBS-Server-Test,current list of Servers=[192.168.28.85:8202],Load balancer stats=Zone stats: {unknown=[Zone:unknown;\tInstance count:1;\tActive connections count: 0;\tCircuit breaker tripped count: 0;\tActive connections per server: 0.0;]\n},Server stats: [[Server:192.168.28.85:8202;\tZone:UNKNOWN;\tTotal Requests:0;\tSuccessive connection failure:0;\tTotal blackout seconds:0;\tLast connection made:Thu Jan 01 08:00:00 CST 1970;\tFirst connection made: Thu Jan 01 08:00:00 CST 1970;\tActive Connections:0;\ttotal failure count in last (1000) msecs:0;\taverage resp time:0.0;\t90 percentile resp time:0.0;\t95 percentile resp time:0.0;\tmin resp time:0.0;\tmax resp time:0.0;\tstddev resp time:0.0]\n]}ServerList:com.alibaba.cloud.nacos.ribbon.NacosServerList@6f791eda\n2020-01-01 12:13:33 INFO  [FEBS-Server-System,,,] http-nio-8201-exec-1 io.seata.tm.api.DefaultGlobalTransaction [192.168.33.1:8091:2031579909] commit status:Committed\n2020-01-01 12:13:34 INFO  [FEBS-Server-System,,,] rpcDispatch_RMROLE_1_8 io.seata.core.rpc.netty.RmMessageListener onMessage:xid=192.168.33.1:8091:2031579909,branchId=2031579912,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/febs_cloud_base,applicationData=null\n2020-01-01 12:13:34 INFO  [FEBS-Server-System,,,] rpcDispatch_RMROLE_1_8 io.seata.rm.AbstractRMHandler Branch committing: 192.168.33.1:8091:2031579909 2031579912 jdbc:mysql://127.0.0.1:3306/febs_cloud_base null\n2020-01-01 12:13:34 INFO  [FEBS-Server-System,,,] rpcDispatch_RMROLE_1_8 io.seata.rm.AbstractRMHandler Branch commit result: PhaseTwo_Committed\n2020-01-01 12:13:34 INFO  [FEBS-Server-System,,,] PollingServerListUpdater-0 com.netflix.config.ChainedDynamicProperty Flipping property: FEBS-Server-Test.ribbon.ActiveConnectionsLimit to use NEXT property: niws.loadbalancer.availabilityFilteringRule.activeConnectionsLimit = 2147483647\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br")])]),s("p",[e._v("查看febs-server-test日志：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("2020-01-01 12:13:33 INFO  [FEBS-Server-Test,,,] http-nio-8202-exec-1 io.seata.common.loader.EnhancedServiceLoader load TransactionManager[null] extension by class[io.seata.tm.DefaultTransactionManager]\n2020-01-01 12:13:33 INFO  [FEBS-Server-Test,,,] http-nio-8202-exec-1 io.seata.tm.TransactionManagerHolder TransactionManager Singleton io.seata.tm.DefaultTransactionManager@9cb765b\n2020-01-01 12:13:33 INFO  [FEBS-Server-Test,,,] http-nio-8202-exec-1 cc.mrbird.febs.server.test.service.fallback.TradeLogServiceImpl 当前 XID: 192.168.33.1:8091:2031579909\n2020-01-01 12:13:33 INFO  [FEBS-Server-Test,,,] http-nio-8202-exec-1 cc.mrbird.febs.server.test.configure.seata.DynamicRoutingDataSource 当前数据源 [BASE]\n2020-01-01 12:13:33 INFO  [FEBS-Server-Test,,,] http-nio-8202-exec-1 io.seata.common.loader.EnhancedServiceLoader load LoadBalance[null] extension by class[io.seata.discovery.loadbalance.RandomLoadBalance]\n2020-01-01 12:13:33 WARN  [FEBS-Server-Test,,,] http-nio-8202-exec-1 io.seata.common.loader.EnhancedServiceLoader load [io.seata.rm.datasource.undo.parser.ProtostuffUndoLogParser] class fail. io/protostuff/runtime/RuntimeEnv\n2020-01-01 12:13:33 INFO  [FEBS-Server-Test,,,] http-nio-8202-exec-1 io.seata.common.loader.EnhancedServiceLoader load UndoLogParser[jackson] extension by class[io.seata.rm.datasource.undo.parser.JacksonUndoLogParser]\n2020-01-01 12:13:33 INFO  [FEBS-Server-Test,,,] http-nio-8202-exec-1 cc.mrbird.febs.server.test.service.fallback.TradeLogServiceImpl 商品ID为1，名称为homepod的商品打包完毕，开始物流配送\n2020-01-01 12:13:34 INFO  [FEBS-Server-Test,,,] rpcDispatch_RMROLE_1_8 io.seata.core.rpc.netty.RmMessageListener onMessage:xid=192.168.33.1:8091:2031579909,branchId=2031579915,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/febs_cloud_base,applicationData=null\n2020-01-01 12:13:34 INFO  [FEBS-Server-Test,,,] rpcDispatch_RMROLE_1_8 io.seata.rm.AbstractRMHandler Branch committing: 192.168.33.1:8091:2031579909 2031579915 jdbc:mysql://127.0.0.1:3306/febs_cloud_base null\n2020-01-01 12:13:34 INFO  [FEBS-Server-Test,,,] rpcDispatch_RMROLE_1_8 io.seata.rm.AbstractRMHandler Branch commit result: PhaseTwo_Committed\n2020-01-01 12:13:43 WARN  [FEBS-Server-Test,,,] registrationTask1 de.codecentric.boot.admin.client.registration.ApplicationRegistrator Failed to register application as Application(name=FEBS-Server-Test, managementUrl=http://DESKTOP-J2ED3B7:8202/actuator, healthUrl=http://DESKTOP-J2ED3B7:8202/actuator/health, serviceUrl=http://DESKTOP-J2ED3B7:8202/) at spring-boot-admin ([http://127.0.0.1:8401/instances]): I/O error on POST request for \"http://127.0.0.1:8401/instances\": Connect to 127.0.0.1:8401 [/127.0.0.1] failed: Connection refused: connect; nested exception is org.apache.http.conn.HttpHostConnectException: Connect to 127.0.0.1:8401 [/127.0.0.1] failed: Connection refused: connect. Further attempts are logged on DEBUG level\n2020-01-01 12:14:48 INFO  [FEBS-Server-Test,,,] rpcDispatch_RMROLE_2_8 io.seata.core.rpc.netty.RmMessageListener onMessage:UndoLogDeleteRequest{resourceId='jdbc:mysql://127.0.0.1:3306/febs_cloud_base', saveDays=7, branchType=AT}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br")])]),s("p",[e._v("查看数据库t_trade_log库表数据：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2020/01/01/l8jdL4.png",alt:"707.png"}})]),e._v(" "),s("p",[e._v("可以看到流程没有问题，现在我们手动在febs-server-system的TradeLogServiceImpl的orderAndPay方法中制造一个异常，看看分布式事务是否生效：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Slf4j\n@Service("tradeLogService")\npublic class TradeLogServiceImpl extends ServiceImpl<TradeLogMapper, TradeLog> implements ITradeLogService {\n\n    @Autowired\n    private IRemoteTradeLogService remoteTradeLogService;\n\n    @Override\n    @GlobalTransactional\n    public void orderAndPay(TradeLog tradeLog) {\n        // DynamicDataSourceContextHolder.setDataSourceKey(DataSourceKey.BASE);\n        log.info("当前 XID: {}", RootContext.getXID());\n\n        tradeLog.setCreateTime(new Date());\n        tradeLog.setStatus("下单并支付成功");\n\n        // 保存支付日志\n        this.save(tradeLog);\n        log.info("用户已经下单并支付成功商品ID为{}，名称为{}的商品", tradeLog.getGoodsId(), tradeLog.getGoodsName());\n        // 调用远程方法，打包并配送商品\n        remoteTradeLogService.packageAndSend(tradeLog);\n\n        throw new RuntimeException("抛个异常~");\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br"),s("span",{staticClass:"line-number"},[e._v("24")]),s("br"),s("span",{staticClass:"line-number"},[e._v("25")]),s("br")])]),s("p",[e._v("重启febs-server-system，然后再次使用Postman发送测试请求：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2020/01/01/l8jheH.png",alt:"708.png"}})]),e._v(" "),s("p",[e._v("查看febs-server-test日志：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("2020-01-01 12:19:03 INFO  [FEBS-Server-Test,,,] http-nio-8202-exec-6 cc.mrbird.febs.server.test.service.fallback.TradeLogServiceImpl 当前 XID: 192.168.33.1:8091:2031579922\n2020-01-01 12:19:03 INFO  [FEBS-Server-Test,,,] http-nio-8202-exec-6 cc.mrbird.febs.server.test.configure.seata.DynamicRoutingDataSource 当前数据源 [BASE]\n2020-01-01 12:19:03 INFO  [FEBS-Server-Test,,,] http-nio-8202-exec-6 cc.mrbird.febs.server.test.service.fallback.TradeLogServiceImpl 商品ID为1，名称为homepod的商品打包完毕，开始物流配送\n2020-01-01 12:19:03 INFO  [FEBS-Server-Test,,,] rpcDispatch_RMROLE_3_8 io.seata.core.rpc.netty.RmMessageListener onMessage:xid=192.168.33.1:8091:2031579922,branchId=2031579928,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/febs_cloud_base,applicationData=null\n2020-01-01 12:19:03 INFO  [FEBS-Server-Test,,,] rpcDispatch_RMROLE_3_8 io.seata.rm.AbstractRMHandler Branch Rollbacking: 192.168.33.1:8091:2031579922 2031579928 jdbc:mysql://127.0.0.1:3306/febs_cloud_base\n2020-01-01 12:19:03 INFO  [FEBS-Server-Test,,,] rpcDispatch_RMROLE_3_8 io.seata.rm.datasource.undo.AbstractUndoLogManager xid 192.168.33.1:8091:2031579922 branch 2031579928, undo_log deleted with GlobalFinished\n2020-01-01 12:19:03 INFO  [FEBS-Server-Test,,,] rpcDispatch_RMROLE_3_8 io.seata.rm.AbstractRMHandler Branch Rollbacked result: PhaseTwo_Rollbacked\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br")])]),s("p",[e._v("从日志来看，事务是回滚成功的，查看数据库t_trade_log库表数据，看看是否有脏数据：\n"),s("img",{attrs:{src:"https://s2.ax1x.com/2020/01/01/l8jdL4.png",alt:"707.png"}})]),e._v(" "),s("p",[e._v("可以看到并没有脏数据，说明分布式事务控制是成功的。使用"),s("code",[e._v("@GlobalTransactional")]),e._v("注解默认就是AT模式，下面我们试试Seata的TCC模式。")]),e._v(" "),s("h2",{attrs:{id:"tcc模式分布式事务控制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#tcc模式分布式事务控制"}},[e._v("#")]),e._v(" TCC模式分布式事务控制")]),e._v(" "),s("p",[e._v("修改febs-server-test的ITradeLogService接口，修改后内容如下所示：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@LocalTCC\npublic interface ITradeLogService extends IService<TradeLog> {\n\n    @TwoPhaseBusinessAction(name = "packageAndSendTccAction", commitMethod = "commit", rollbackMethod = "cancel")\n    void packageAndSend(TradeLog tradeLog);\n\n    boolean commit(BusinessActionContext businessActionContext);\n\n    boolean cancel(BusinessActionContext businessActionContext);\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br")])]),s("p",[e._v("接口使用"),s("code",[e._v("LocalTCC")]),e._v("注解标注，表示开启TCC模式；packageAndSend方法使用"),s("code",[e._v("@TwoPhaseBusinessAction")]),e._v("标注，此注解必须设置三个属性：")]),e._v(" "),s("ol",[s("li",[e._v("name：TCC bean的名称，必须确保唯一 ；")]),e._v(" "),s("li",[e._v("commitMethod：TCC过程中，Commit步骤要调用的此接口的方法名称；")]),e._v(" "),s("li",[e._v("rollbackMethod：TCC过程中，Cancel步骤要调用的此接口的方法名称。")])]),e._v(" "),s("p",[e._v("此外commit和cancel对应的方法返回类型必须为boolean，以便TCC框架知道Commit或者 Cancel的结果； 如果commit和cancel对应的方法中要获取到"),s("code",[e._v("packageAndSend")]),e._v("方法的参数，可以使用"),s("code",[e._v('@BusinessActionContextParameter(paramName = "tradeLog") TradeLog tradeLog')]),e._v("，后续通过BusinessActionContext对象获取。")]),e._v(" "),s("p",[e._v("修改febs-server-test接口ITradeLogService实现类：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Slf4j\n@Service("tradeLogService")\npublic class TradeLogServiceImpl extends ServiceImpl<TradeLogMapper, TradeLog> implements ITradeLogService {\n\n    private static final String TRADELOG_ID = "tradelog_id";\n    private ConcurrentHashMap<String, Long> hashMap = new ConcurrentHashMap<>();\n\n    @Override\n    public void packageAndSend(TradeLog tradeLog) {\n        TradeLog tl = new TradeLog();\n        tl.setGoodsId(tradeLog.getGoodsId());\n        tl.setGoodsName(tradeLog.getGoodsName());\n        tl.setStatus("打包完毕，开始物流配送！");\n        tl.setCreateTime(new Date());\n\n        this.save(tl);\n        log.info("商品ID为{}，名称为{}的商品打包完毕，开始物流配送", tradeLog.getGoodsId(), tradeLog.getGoodsName());\n\n        hashMap.put(TRADELOG_ID, tl.getId());\n    }\n\n    @Override\n    public boolean commit(BusinessActionContext businessActionContext) {\n        log.info("事务执行成功");\n        hashMap.remove(TRADELOG_ID);\n        return true;\n    }\n\n    @Override\n    public boolean cancel(BusinessActionContext businessActionContext) {\n        Long tradeLogId = hashMap.get(TRADELOG_ID);\n        log.info("事务执行失败，回滚tradeLogId为{}的数据", tradeLogId);\n        this.removeById(tradeLogId);\n        hashMap.remove(TRADELOG_ID);\n        return true;\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br"),s("span",{staticClass:"line-number"},[e._v("24")]),s("br"),s("span",{staticClass:"line-number"},[e._v("25")]),s("br"),s("span",{staticClass:"line-number"},[e._v("26")]),s("br"),s("span",{staticClass:"line-number"},[e._v("27")]),s("br"),s("span",{staticClass:"line-number"},[e._v("28")]),s("br"),s("span",{staticClass:"line-number"},[e._v("29")]),s("br"),s("span",{staticClass:"line-number"},[e._v("30")]),s("br"),s("span",{staticClass:"line-number"},[e._v("31")]),s("br"),s("span",{staticClass:"line-number"},[e._v("32")]),s("br"),s("span",{staticClass:"line-number"},[e._v("33")]),s("br"),s("span",{staticClass:"line-number"},[e._v("34")]),s("br"),s("span",{staticClass:"line-number"},[e._v("35")]),s("br"),s("span",{staticClass:"line-number"},[e._v("36")]),s("br"),s("span",{staticClass:"line-number"},[e._v("37")]),s("br")])]),s("p",[e._v("基本逻辑和TX-LCN框架的TCC模式差不多。")]),e._v(" "),s("p",[e._v("重启febs-server-test，再次使用Postman发送测试请求，febs-server-test日志如下：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('2020-01-01 14:42:05 INFO  [FEBS-Server-Test,,,] http-nio-8202-exec-7 cc.mrbird.febs.server.test.configure.seata.DynamicRoutingDataSource 当前数据源 [BASE]\n2020-01-01 14:42:05 INFO  [FEBS-Server-Test,,,] http-nio-8202-exec-7 cc.mrbird.febs.server.test.service.fallback.TradeLogServiceImpl 商品ID为1，名称为homepod的商品打包完毕，开始物流配送\n2020-01-01 14:42:05 INFO  [FEBS-Server-Test,,,] rpcDispatch_RMROLE_2_8 io.seata.core.rpc.netty.RmMessageListener onMessage:xid=192.168.33.1:8091:2031599655,branchId=2031599660,branchType=TCC,resourceId=packageAndSendTccAction,applicationData={"actionContext":{"sys::rollback":"cancel","sys::commit":"confirm","action-start-time":1577860925592,"host-name":"192.168.33.1","sys::prepare":"packageAndSend","actionName":"packageAndSendTccAction"}}\n2020-01-01 14:42:05 INFO  [FEBS-Server-Test,,,] rpcDispatch_RMROLE_2_8 io.seata.rm.AbstractRMHandler Branch Rollbacking: 192.168.33.1:8091:2031599655 2031599660 packageAndSendTccAction\n2020-01-01 14:42:05 INFO  [FEBS-Server-Test,,,] rpcDispatch_RMROLE_2_8 cc.mrbird.febs.server.test.service.fallback.TradeLogServiceImpl 事务执行失败，回滚tradeLogId为21的数据\n2020-01-01 14:42:05 INFO  [FEBS-Server-Test,,,] rpcDispatch_RMROLE_2_8 cc.mrbird.febs.server.test.configure.seata.DynamicRoutingDataSource 当前数据源 [BASE]\n2020-01-01 14:42:05 INFO  [FEBS-Server-Test,,,] rpcDispatch_RMROLE_2_8 io.seata.rm.AbstractResourceManager TCC resource rollback result :true, xid:192.168.33.1:8091:2031599655, branchId:2031599660, resourceId:packageAndSendTccAction\n2020-01-01 14:42:05 INFO  [FEBS-Server-Test,,,] rpcDispatch_RMROLE_2_8 io.seata.rm.AbstractRMHandler Branch Rollbacked result: PhaseTwo_Rollbacked\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br")])]),s("p",[e._v("复制")]),e._v(" "),s("p",[e._v("可以看到，cancel方法被执行了，查看数据库t_trade_log库表数据：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://s2.ax1x.com/2020/01/01/lG14BD.png",alt:"709.png"}})]),e._v(" "),s("p",[e._v("没有脏数据，分布式事务控制成功。")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("'https://lixuanfengs.github.io/blog-images/cactus-vuepress-img/87c01ec7gy1frmrxuzha8j21hc0u0gur.jpg',\n'https://lixuanfengs.github.io/blog-images/cactus-vuepress-img/87c01ec7gy1frmmw9573mj21kw0w0npk.jpg',\n'https://lixuanfengs.github.io/blog-images/cactus-vuepress-img/87c01ec7gy1frmrru1bh9j21hc0u0qbx.jpg',\n'https://cdn.jsdelivr.net/gh/xugaoyi/image_store/blog/20200507175828.jpeg',\n'https://s1.ax1x.com/2022/05/10/OtqWtO.png',\n'https://lixuanfengs.github.io/blog-images/cactus-vuepress-img/87c01ec7gy1frmrtnq32hj21hc0u0wnl.jpg',\n'https://lixuanfengs.github.io/blog-images/cactus-vuepress-img/0060lm7Tly1ftg6owkw9lj31hc0u0tt9.jpg',\n'https://lixuanfengs.github.io/blog-images/cactus-vuepress-img/0060lm7Tly1ftg6x22sgcj31hc0u0qh8.jpg',\n'https://s1.ax1x.com/2022/05/10/ONPS0g.jpg',\n'https://s1.ax1x.com/2022/05/10/ONCvX8.jpg',\n'https://s1.ax1x.com/2022/05/10/ONCj6f.jpg',\n'https://lixuanfengs.github.io/blog-images/cactus-vuepress-img/0060lm7Tly1ftg6omusg9j31hc0u010h.jpg',\n'https://lixuanfengs.github.io/blog-images/cactus-vuepress-img/0060lm7Tly1ftg6p3dkm1j31hc0u04mm.jpg',\n'https://lixuanfengs.github.io/blog-images/cactus-vuepress-img/87c01ec7gy1frmrr7y6u3j21hc0u0k0c.jpg',\n'https://cdn.jsdelivr.net/gh/xugaoyi/image_store/blog/20200507175845.jpeg',\n'https://s1.ax1x.com/2022/05/10/ONP4Cn.jpg',\n'https://s1.ax1x.com/2022/05/10/ONPREQ.jpg',\n'https://s1.ax1x.com/2022/05/10/ONP53q.jpg',\n'https://s1.ax1x.com/2022/05/10/ONPf4s.jpg',\n'https://s1.ax1x.com/2022/05/10/ONPWNj.jpg',\n'https://s1.ax1x.com/2022/05/10/ONP7uT.jpg', \n'https://s1.ax1x.com/2022/05/10/ONPIg0.jpg', \n'https://s1.ax1x.com/2022/05/10/ONPovV.jpg',\n'https://lixuanfengs.github.io/blog-images/cactus-vuepress-img/87c01ec7gy1frmmknznonj21hc0u01l1.jpg',\n'https://cdn.jsdelivr.net/gh/xugaoyi/image_store/blog/20200507175846.jpeg',\n'https://cactusmall.oss-cn-beijing.aliyuncs.com/cactusli/anime%20aesthetics%20-%20thirty-seven.gif',\n'https://lixuanfengs.github.io/blog-images/cactus-vuepress-img/87c01ec7gy1frmmmaptjmj21hc0u0npf.jpg',\n'https://lixuanfengs.github.io/blog-images/cactus-vuepress-img/87c01ec7gy1frmrz8e3ytj21hc0u0wnn.jpg',\n'https://lixuanfengs.github.io/blog-images/cactus-vuepress-img/0060lm7Tly1ftg6ozby6nj31hc0u01cf.jpg',\n'https://lixuanfengs.github.io/blog-images/cactus-vuepress-img/0060lm7Tly1ftg6xc454vj31hc0u07wh.jpg',\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br"),s("span",{staticClass:"line-number"},[e._v("24")]),s("br"),s("span",{staticClass:"line-number"},[e._v("25")]),s("br"),s("span",{staticClass:"line-number"},[e._v("26")]),s("br"),s("span",{staticClass:"line-number"},[e._v("27")]),s("br"),s("span",{staticClass:"line-number"},[e._v("28")]),s("br"),s("span",{staticClass:"line-number"},[e._v("29")]),s("br"),s("span",{staticClass:"line-number"},[e._v("30")]),s("br")])])])}),[],!1,null,null,null);s.default=t.exports}}]);