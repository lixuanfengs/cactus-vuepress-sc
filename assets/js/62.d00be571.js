(window.webpackJsonp=window.webpackJsonp||[]).push([[62],{413:function(s,a,n){"use strict";n.r(a);var e=n(0),t=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"mysql主从复制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql主从复制"}},[s._v("#")]),s._v(" MySQL主从复制")]),s._v(" "),a("h3",{attrs:{id:"mysql-replication介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql-replication介绍"}},[s._v("#")]),s._v(" MySQL Replication介绍")]),s._v(" "),a("p",[s._v("MySQL Replication是MySQL自身提供的一个主从复制功能，其实也就是一台MySQL服务器（称为Slave）从另一台MySQL服务器（称为Master）上复制日志，然后再解析日志并应用到自身的过程。MySQL Replication是单向、异步复制，基本复制过程为：Master服务器首先将更新写入二进制日志文件，并维护文件的一个索引以跟踪日志的循环。这些日志文件可以发送到Slave服务器进行更新。当一个Slave服务器连接Master服务器时，它从Master服务器日志中读取上一次成功更新的位置。然后Slave服务器开始接收从上一次完成更新后发生的所有更新，所有更新完成，将等待主服务器通知新的更新")]),s._v(" "),a("p",[s._v("MySQL Replication支持链式复制，也就是说Slave服务器下还可以再链接Slave服务器，同时Slave服务器也可以充当Master服务器角色。这里需要注意的是，在MySQL主从复制中，所有表的更新必须在Master服务器上进行，Slave服务器仅能提供查询操作")]),s._v(" "),a("h4",{attrs:{id:"类型介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#类型介绍"}},[s._v("#")]),s._v(" 类型介绍")]),s._v(" "),a("p",[s._v("1）基于语句的复制MySQL默认采用基于语句的复制，效率很高。基本方式是：在Master服务器上执行的SQL语句，在Slave服务器上再次执行同样的语句。而一旦发现没法精确复制时，会自动选择基于行的复制。")]),s._v(" "),a("p",[s._v("2）\t基于行的复制基本方式为：把Master服务器上改变的内容复制过去，而不是把SQL语句在从服务器上执行一遍， 从mysql5.0开始支持基于行的复制。")]),s._v(" "),a("p",[s._v("3）\t混合类型的复制其实就是上面两种类型的组合，默认采用基于语句的复制，如果发现基于语句的复制无法精确的完成，就会采用基于行的复制。")]),s._v(" "),a("h4",{attrs:{id:"常用架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常用架构"}},[s._v("#")]),s._v(" 常用架构")]),s._v(" "),a("p",[s._v("1、一主一从,即一个Master服务器和一个Slave服务器,这是最常见的架构")]),s._v(" "),a("p",[s._v("2、一主多从,即一个Master服务器和两个或两个以上Slave服务器,经常用在写操作不频繁、查询量")]),s._v(" "),a("p",[s._v("比较大的业务环境中")]),s._v(" "),a("p",[s._v("3、主主互备,又称双主互备,即两个MySQL Server互相将对方作为自已的Master,自已又同时作为对方的")]),s._v(" "),a("p",[s._v("Slave来进行复制,主要用于对MySQL写操作要求比较高的环境中,避免了MySQL单点故障")]),s._v(" "),a("p",[s._v("4、双主多从，其实就是双主互备，然后再加上多个Slave服务器。主要用于对MySQL写操作要求比较高，同时查询量比较大的环境中")]),s._v(" "),a("p",[s._v("同一时刻只能有一个Master服务器进行写操作。")]),s._v(" "),a("p",[s._v("一个Master服务器可以有多个Slave服务器。")]),s._v(" "),a("p",[s._v("无论是Master服务器还是Slave服务器，都要确保各自的Server ID唯一，不然双主互备就会出问题。")]),s._v(" "),a("p",[s._v("一个Slave服务器可以将其从Master服务器获得的更新信息传递给其他的Slave服务器")]),s._v(" "),a("h4",{attrs:{id:"主主互备架构图"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#主主互备架构图"}},[s._v("#")]),s._v(" 主主互备架构图")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://lixuanfengs.github.io/blog-images/cactus-vuepress-img/imageasdasd.png",alt:"img"}})]),s._v(" "),a("h3",{attrs:{id:"配置主主模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置主主模式"}},[s._v("#")]),s._v(" 配置主主模式")]),s._v(" "),a("h4",{attrs:{id:"环境介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境介绍"}},[s._v("#")]),s._v(" 环境介绍")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("DB1(k8s-master1)    centos7.4     mysql5.7      10.2.32.11      \nDB2(k8s-master2)    centos7.4     mysql5.7      10.2.32.10  \nvip: 10.2.32.3\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h4",{attrs:{id:"修改mysql配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改mysql配置文件"}},[s._v("#")]),s._v(" 修改MySQL配置文件")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("[root@k8s-master1 ~]# vim /etc/my.cnf\n[mysqld]\nserver-id = 1\nlog-bin=mysql-bin\nrelay-log = mysql-relay-bin\nreplicate-wild-ignore-table=mysql.%\nreplicate-wild-ignore-table=test.%\nreplicate-wild-ignore-table=information_schema.%\n\n#MySQL5.7之后的,账号密码要保护好\n[client]\nuser=root\npassword=123456\n[root@k8s-master2 ~]# vim /etc/my.cnf\n[mysqld]\nserver-id = 2\nlog-bin=mysql-bin\nrelay-log = mysql-relay-bin\nreplicate-wild-ignore-table=mysql.%\nreplicate-wild-ignore-table=test.%\nreplicate-wild-ignore-table=information_schema.%\n\n[client]\nuser=root\npassword=123456\n# 配置完记得重启数据库\n1、server-id是节点标识，主、从节点不能相同，必须全局唯一。\n2、log-bin表示开启MySQL的binlog日志功能。“mysql-bin”表示日志文件的命名格式，会生成文件名为mysql-bin.000001、mysql-bin.000002等的日志文件。\n3、relay-log用来定义relay-log日志文件的命名格式。\n4、replicate-wild-ignore-table是个复制过滤选项，可以过滤掉不需要复制的数据库或表，例如“mysql.%“表示不复制mysql库下的所有对象，其他依此类推。与此对应的是replicate_wild_do_table选项，用来指定需要复制的数据库或表。\n\t这里需要注意的是，不要在主库上使用binlog-do-db或binlog-ignore-db选项，也不要在从库上使用replicate-do-db或replicate-ignore-db选项，因为这样可能产生跨库更新失败的问题。推荐在从库上使用replicate_wild_do_table和replicate-wild-ignore-table两个选项来解决复制过滤问题。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br")])]),a("h4",{attrs:{id:"线上操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#线上操作"}},[s._v("#")]),s._v(" 线上操作")]),s._v(" "),a("h5",{attrs:{id:"手动同步数据库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#手动同步数据库"}},[s._v("#")]),s._v(" 手动同步数据库")]),s._v(" "),a("p",[s._v("如果DB1上已经有mysql数据，那么在执行主主互备之前，需要将DB1和DB2上两个mysql的数据保持同步，首先在DB1上备份mysql数据，执行如下SQL语句:")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("# 设置成只读的先\nmysql>FLUSH TABLES WITH READ LOCK;\nQuery OK, 0 rows affected (0.00 sec)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("不要退出这个终端，否则这个锁就失效了。在不退出终端的情况下，再开启一个终端直接打包压缩数据文件或使用mysqldump工具来导出数据。这里通过打包mysql文件来完成数据的备份，操作过程如下：")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("[root@DB1 ~]# cd /var/lib/\n[root@DB1 lib]# tar zcvf mysql.tar.gz mysql\n[root@DB1 lib]# scp mysql.tar.gz  DB2:/var/lib/\n将数据传输到DB2后，依次重启DB1和DB2上面的mysql。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h4",{attrs:{id:"测试环境"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试环境"}},[s._v("#")]),s._v(" 测试环境")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("# 两边手动创建一样的库和表\n[root@k8s-master1 ~]# mysql -uroot -p\nmysql> create database ha;\nmysql> use ha;\nmysql> create table t1(id int,name varchar(20));\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h4",{attrs:{id:"用户授权"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#用户授权"}},[s._v("#")]),s._v(" 用户授权")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("[root@k8s-master1 ha]# mysql -uroot -p\nmysql> grant replication slave on *.* to 'repl_user'@'10.2.32.10' identified by 'repl_passwd';\nmysql> show master status;\n+------------------+----------+--------------+------------------+-------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |\n+------------------+----------+--------------+------------------+-------------------+\n| mysql-bin.000001 |      154 |              |                  |                   |\n+------------------+----------+--------------+------------------+-------------------+\n1 row in set (0.00 sec)\n[root@k8s-master2 ha]# mysql -uroot -p\nmysql> change master to master_host='10.2.32.11',master_user='repl_user',master_password='repl_passwd',master_log_file='mysql-bin.000001',master_log_pos=154\n    -> ;\nmysql> start slave;\nmysql> show slave status \\G;\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: 10.2.32.11\n                  Master_User: repl_user\n                  Master_Port: 3306\n                Connect_Retry: 60\n              Master_Log_File: mysql-bin.000001\n          Read_Master_Log_Pos: 154\n               Relay_Log_File: mysql-relay-bin.000002\n                Relay_Log_Pos: 320\n        Relay_Master_Log_File: mysql-bin.000001\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n[root@k8s-master2 ha]# mysql -uroot -p\nmysql> grant replication slave on *.* to 'repl_user'@'10.2.32.11' identified by 'repl_passwd';\nQuery OK, 0 rows affected, 1 warning (0.00 sec)\n\nmysql>  show master status;\n+------------------+----------+--------------+------------------+-------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |\n+------------------+----------+--------------+------------------+-------------------+\n| mysql-bin.000002 |      451 |              |                  |                   |\n+------------------+----------+--------------+------------------+-------------------+\n1 row in set (0.00 sec)\n# 然后在DB1的mysql库中将DB2设为自己的主服务器：\n[root@k8s-master1 ha]# mysql -uroot -p\nmysql> change master to master_host='10.2.32.10',master_user='repl_user',master_password='repl_passwd',master_log_file='mysql-bin.000002',master_log_pos=451;\nmysql> start slave;\nmysql> show slave status \\G;\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: 10.2.32.10\n                  Master_User: repl_user\n                  Master_Port: 3306\n                Connect_Retry: 60\n              Master_Log_File: mysql-bin.000002\n          Read_Master_Log_Pos: 451\n               Relay_Log_File: mysql-relay-bin.000002\n                Relay_Log_Pos: 320\n        Relay_Master_Log_File: mysql-bin.000002\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br")])]),a("h4",{attrs:{id:"验证数据同步"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#验证数据同步"}},[s._v("#")]),s._v(" 验证数据同步")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("# DB1上插入数据\nmysql> use ha;\nDatabase changed\nmysql> insert into t1 values(1,'man');\nQuery OK, 1 row affected (0.00 sec)\n\nmysql> select * from t1;\n+------+------+\n| id   | name |\n+------+------+\n|    1 | man  |\n+------+------+\n1 row in set (0.00 sec)\n# DB2查看\nmysql> use ha;\nmysql> select * from t1;\n+------+------+\n| id   | name |\n+------+------+\n|    1 | man  |\n+------+------+\n1 row in set (0.00 sec)\n#反之在DB2上插入,DB1查看\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("h3",{attrs:{id:"部署keepalived"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署keepalived"}},[s._v("#")]),s._v(" 部署KeepAlived")]),s._v(" "),a("h4",{attrs:{id:"编译安装keepalived"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#编译安装keepalived"}},[s._v("#")]),s._v(" 编译安装KeepAlived")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("# 两台都要安装\nyum install -y gcc gcc-c++ wget popt-devel openssl openssl-devel\nyum install -y libnl libnl-devel libnl3 libnl3-devel\nyum install -y libnfnetlink-devel\n./configure   --sysconf=/data/keepalived && make && make install\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h4",{attrs:{id:"编辑配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#编辑配置文件"}},[s._v("#")]),s._v(" 编辑配置文件")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('[root@DB1 k8s-node1 ]# cat keepalived.conf\nglobal_defs {\n    router_id 10.2.32.12\n    script_user root\n    enable_script_security\n}\n\nvrrp_script chk_nginx {\n         script "/etc/keepalived/check_mysql.sh"\n         interval 2\n         weight -20\n}\n\n\nvrrp_instance VI_1 {\n         state MASTER\n         interface ens32\n         virtual_router_id 140\n         mcast_src_ip 10.2.32.12\n         priority 100\n         nopreempt\n         advert_int 1\n         authentication {\n            auth_type PASS\n                auth_pass 1111\n         }\n\n         track_script {\n                 chk_nginx\n         }\n         virtual_ipaddress {\n            10.2.32.3\n          }\n}\n[root@DB2 k8s-node2 ]# cat keepalived.conf\nglobal_defs {\n    router_id 10.2.32.13\n    script_user root\n    enable_script_security\n}\n\nvrrp_script chk_nginx {\n        script "/etc/keepalived/check_mysql.sh"\n        interval 2\n        weight -20\n}\n\nvrrp_instance VI_1 {\n         state BACKUP\n         interface ens32\n         virtual_router_id 128\n         priority 90\n         mcast_src_ip 10.2.32.13\n         advert_int 1\n         authentication {\n            auth_type PASS\n            auth_pass 1111\n         }\n         track_script {\n                chk_nginx\n         }\n         virtual_ipaddress {\n             10.2.32.3\n         }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br")])]),a("h4",{attrs:{id:"脚本文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#脚本文件"}},[s._v("#")]),s._v(" 脚本文件")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('# 在新版本的myql中，直接将密码写在命令行，会进行安全提示，解决办法是将其写在mysql的配置文件里的 [client] 字段里，写法见上面mysql的配置文件\n[root@k8s-node2 keepalived]# cat check_mysql.sh\n#!/bin/bash\n\nslave_is=( $(mysql -e "show slave status\\G" | grep "Slave_.*_Running" | awk \'{print $2}\') )\nif [ "${slave_is[0]}" = "No" -a "${slave_is[1]}" = "No" ];then\n     systemctl  stop keepalived\nelse\n    systemctl  start  keepalived\nfi\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h4",{attrs:{id:"启动keepalived"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动keepalived"}},[s._v("#")]),s._v(" 启动keepalived")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v(" systemctl restart keepalived\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"查看vip地址是否生成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看vip地址是否生成"}},[s._v("#")]),s._v(" 查看vip地址是否生成")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://lixuanfengs.github.io/blog-images/cactus-vuepress-img/image2.png",alt:"img"}})]),s._v(" "),a("h4",{attrs:{id:"测试通过vip地址远程登录mysql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试通过vip地址远程登录mysql"}},[s._v("#")]),s._v(" 测试通过vip地址远程登录MySQL")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("# 记得授权访问 两台机器都要操作\nmysql> grant all on *.* to  'repl_user1'@'10.2.32.3'  identified by '123456';\n[root@k8s-master1 ~]# mysql -urepl_user -p -h 10.2.32.3\nEnter password:\nWelcome to the MariaDB monitor.  Commands end with ; or \\g.\nYour MySQL connection id is 14\nServer version: 5.7.28-log MySQL Community Server (GPL)\n\nCopyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.\n\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\n\nMySQL [(none)]> show variables like '%hostname%';\n+---------------+-----------+\n| Variable_name | Value     |\n+---------------+-----------+\n| hostname      | k8s-node1 |\n+---------------+-----------+\n1 row in set (0.00 sec)\n# 可以插入数据测试看看\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("h4",{attrs:{id:"模拟故障"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#模拟故障"}},[s._v("#")]),s._v(" 模拟故障")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("# 停掉DB1的slave,看看vip能不能漂移到DB2上\nmysql> stop slave;\nQuery OK, 0 rows affected (0.01 sec)\nmysql> show slave status \\G;\n*************************** 1. row ***************************\n               Slave_IO_State:\n                  Master_Host: 10.2.32.13\n                  Master_User: repl_user\n                  Master_Port: 3306\n                Connect_Retry: 60\n              Master_Log_File: mysql-bin.000005\n          Read_Master_Log_Pos: 154\n               Relay_Log_File: mysql-relay-bin.000014\n                Relay_Log_Pos: 320\n        Relay_Master_Log_File: mysql-bin.000005\n             Slave_IO_Running: No\n            Slave_SQL_Running: No\n# 查看db1上vip是否还存在\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])])])}),[],!1,null,null,null);a.default=t.exports}}]);